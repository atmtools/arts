#include <auto_wsg.h>
#include <debug.h>

#include <iostream>
#include <string>

#include "workspace_agendas.h"
#include "workspace_groups.h"
#include "workspace_variables.h"

namespace {
const auto& wsg  = internal_workspace_groups();
const auto& vars = internal_workspace_variables();
const auto& ags  = internal_workspace_agendas();

void header(std::ostream& os) {
  os << R"--(#pragma once

//! auto-generated by make_auto_wsv.cpp

#include <optional>
#include <string>
#include <unordered_map>

#include "auto_wsg.h"

#include <workspace_agenda_class.h>
#include <workspace_method_class.h>

struct WorkspaceVariableRecord {
  std::string desc;
  std::string type;
  std::optional<Wsv> default_value{};
};

const std::unordered_map<std::string, WorkspaceVariableRecord>& workspace_variables();
)--";
}

void implementation(std::ostream& os) {
  const auto& wsv = internal_workspace_variables();
  const auto& wsa = internal_workspace_agendas();

  std::print(os,
             R"--(//! auto-generated by make_auto_wsv.cpp

#include "auto_wsv.h"

#include <workspace_agendas.h>
#include <workspace_variables.h>

)--");

for (auto& [name, wsa] : internal_workspace_agendas()) {
  if (not wsa.enum_default.empty()){
    std::println(os, "Agenda get_{}(const std::string_view);", name);
  }
}

std::print(os,
             R"--(

std::unordered_map<std::string, WorkspaceVariableRecord> workspace_variables_create() {{
  std::unordered_map<std::string, WorkspaceVariableRecord> vars;
  vars.reserve({});
)--",
             wsv.size() + 2 * wsa.size());

  for (auto&& [name, record] : wsv) {
    std::print(
        os,
        R"(
  vars.emplace("{0}", WorkspaceVariableRecord{{
    .desc          = R"-WSV-({1})-WSV-",
    .type          = "{2}",
    .default_value = {3}
  }});

)",
        name,
        record.desc,
        record.type,
        record.default_value.empty()
            ? "std::nullopt"
            : std::format("{}{{ {} }}", record.type, record.default_value));
  }

  os << R"--(
  return vars;
}

const std::unordered_map<std::string, WorkspaceVariableRecord>& workspace_variables() {
  const static auto vars = workspace_variables_create();
  return vars;
}
)--";
}
}  // namespace

int main() try {
  std::ofstream head("auto_wsv.h");
  std::ofstream impl("auto_wsv.cpp");

  header(head);
  implementation(impl);
} catch (std::exception& e) {
  std::cerr << "Cannot create the automatic variables with error:\n\n"
            << e.what() << '\n';
  return 1;
}
