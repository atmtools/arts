#include <disort-test.h>

const Vector Leg_coeffs_ALL{
    1,       2.41260, 3.23047, 3.37296, 3.23150, 2.89350, 2.49594, 2.11361,
    1.74812, 1.44692, 1.17714, 0.96643, 0.78237, 0.64114, 0.51966, 0.42563,
    0.34688, 0.28351, 0.23317, 0.18963, 0.15788, 0.12739, 0.10762, 0.08597,
    0.07381, 0.05828, 0.05089, 0.03971, 0.03524, 0.02720, 0.02451, 0.01874,
    0.01711, 0.01298, 0.01198, 0.00904, 0.00841, 0.00634, 0.00592, 0.00446,
    0.00418, 0.00316, 0.00296, 0.00225, 0.00210, 0.00160, 0.00150, 0.00115,
    0.00107, 0.00082, 0.00077, 0.00059, 0.00055, 0.00043, 0.00040, 0.00031,
    0.00029, 0.00023, 0.00021, 0.00017, 0.00015, 0.00012, 0.00011, 0.00009,
    0.00008, 0.00006, 0.00006, 0.00005, 0.00004, 0.00004, 0.00003, 0.00003,
    0.00002, 0.00002, 0.00002, 0.00001, 0.00001, 0.00001, 0.00001, 0.00001,
    0.00001, 0.00001, 0.00001};

void test_4a() try {
  const AscendingGrid tau_arr{1};
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad = 32;
  Matrix Leg_coeffs_all(1, Leg_coeffs_ALL.size(), 1);
  for (Index i = 1; i < Leg_coeffs_ALL.size(); i++) {
    Leg_coeffs_all[0, i] =
        Leg_coeffs_ALL[i] / (static_cast<Numeric>(2 * i + 1));
  }

  const Numeric mu0 = 1;
  const Numeric I0 = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{Leg_coeffs_all[0, NQuad]};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.007943282347242814,
      0.07943282347242814,
      0.7943282347242815,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.075518536612019,     0.08194596805147537,   0.08982728404351761,
      0.09622947995959737,   0.09794246758314418,   0.09308842761008874,
      0.0832021270854681,    0.07152452221711332,   0.060690006225471785,
      0.05204410002527085,   0.04592901351435296,   0.04208403752757094,
      0.03996232520696267,   0.03887978251663941,   0.03706708333386891,
      0.03403308160464711,   0.0558944948049507,    0.017551164708075263,
      0.007645141310175259,  0.004210165155803657,  0.002731544562708394,
      0.002050568612331856,  0.0017772578817073028, 0.0017689770268989084,
      0.0019983220426051224, 0.0025273371248680458, 0.0035379951915414536,
      0.005432240085814536,  0.00905612102688167,   0.01611325378675181,
      0.0294999433628832,    0.05018936402315566,   0.09160970082095146,
      0.09556765931717838,   0.1005904392700862,    0.10398381673058439,
      0.10251450000547593,   0.09468230035219637,   0.08259182473102951,
      0.06961884379364884,   0.05817937950862068,   0.04932598249112431,
      0.04317554142140412,   0.03933798105475205,   0.0372134663341194,
      0.036116647653737316,  0.03440339934928525,   0.03161340630239335,
      0.08937875141784905,   0.07999344479713275,   0.05635607527713241,
      0.03779885783679899,   0.02682350649778468,   0.020904598140883274,
      0.01827468553910195,   0.018086087196115156,  0.020211730766432255,
      0.025267105448085397,  0.03497224898408298,   0.05310510124300479,
      0.08758552494869981,   0.15429449472152088,   0.28011615069499674,
      0.4737917109553141,    0.14081973224511277,   0.13493983999324802,
      0.11796868655338975,   0.0890788261450536,    0.061877157514368945,
      0.04179436553992008,   0.028361181632577614,  0.019799271507819762,
      0.014496418471927168,  0.011288448628322532,  0.00940973926620546,
      0.008364935693031142,  0.00782692627620778,   0.007560881383702707,
      0.007197931430034877,  0.006637957342859268,  0.14324994890479265,
      0.1478291894470452,    0.15427499087203148,   0.16021745778555307,
      0.16336711725455047,   0.16410147803814626,   0.16609286527521042,
      0.1741622524225189,    0.19356988782855647,   0.23124149389277232,
      0.2986584236207314,    0.41719664486894503,   0.6282485282459408,
      1.0104399338719874,    1.6905884728060907,    2.6943343912788444,
      0.075518536612019,     0.08194596805147537,   0.08982728404351761,
      0.09622947995959737,   0.09794246758314418,   0.09308842761008874,
      0.0832021270854681,    0.07152452221711332,   0.060690006225471785,
      0.05204410002527085,   0.04592901351435296,   0.04208403752757094,
      0.03996232520696267,   0.03887978251663941,   0.03706708333386891,
      0.03403308160464711,   0.0558944948049507,    0.017551164708075263,
      0.007645141310175259,  0.004210165155803657,  0.002731544562708394,
      0.002050568612331856,  0.0017772578817073028, 0.0017689770268989084,
      0.0019983220426051224, 0.0025273371248680458, 0.0035379951915414536,
      0.005432240085814536,  0.00905612102688167,   0.01611325378675181,
      0.0294999433628832,    0.05018936402315566,   0.09160970082095146,
      0.09556765931717838,   0.1005904392700862,    0.10398381673058439,
      0.10251450000547593,   0.09468230035219637,   0.08259182473102951,
      0.06961884379364884,   0.05817937950862068,   0.04932598249112431,
      0.04317554142140412,   0.03933798105475205,   0.0372134663341194,
      0.036116647653737316,  0.03440339934928525,   0.03161340630239335,
      0.08937875141784905,   0.07999344479713275,   0.05635607527713241,
      0.03779885783679899,   0.02682350649778468,   0.020904598140883274,
      0.01827468553910195,   0.018086087196115156,  0.020211730766432255,
      0.025267105448085397,  0.03497224898408298,   0.05310510124300479,
      0.08758552494869981,   0.15429449472152088,   0.28011615069499674,
      0.4737917109553141,    0.14081973224511277,   0.13493983999324802,
      0.11796868655338975,   0.0890788261450536,    0.061877157514368945,
      0.04179436553992008,   0.028361181632577614,  0.019799271507819762,
      0.014496418471927168,  0.011288448628322532,  0.00940973926620546,
      0.008364935693031142,  0.00782692627620778,   0.007560881383702707,
      0.007197931430034877,  0.006637957342859268,  0.14324994890479265,
      0.1478291894470452,    0.15427499087203148,   0.16021745778555307,
      0.16336711725455047,   0.16410147803814626,   0.16609286527521042,
      0.1741622524225189,    0.19356988782855647,   0.23124149389277232,
      0.2986584236207314,    0.41719664486894503,   0.6282485282459408,
      1.0104399338719874,    1.6905884728060907,    2.6943343912788444,
      0.075518536612019,     0.08194596805147537,   0.08982728404351761,
      0.09622947995959737,   0.09794246758314418,   0.09308842761008874,
      0.0832021270854681,    0.07152452221711332,   0.060690006225471785,
      0.05204410002527085,   0.04592901351435296,   0.04208403752757094,
      0.03996232520696267,   0.03887978251663941,   0.03706708333386891,
      0.03403308160464711,   0.0558944948049507,    0.017551164708075263,
      0.007645141310175259,  0.004210165155803657,  0.002731544562708394,
      0.002050568612331856,  0.0017772578817073028, 0.0017689770268989084,
      0.0019983220426051224, 0.0025273371248680458, 0.0035379951915414536,
      0.005432240085814536,  0.00905612102688167,   0.01611325378675181,
      0.0294999433628832,    0.05018936402315566,   0.09160970082095146,
      0.09556765931717838,   0.1005904392700862,    0.10398381673058439,
      0.10251450000547593,   0.09468230035219637,   0.08259182473102951,
      0.06961884379364884,   0.05817937950862068,   0.04932598249112431,
      0.04317554142140412,   0.03933798105475205,   0.0372134663341194,
      0.036116647653737316,  0.03440339934928525,   0.03161340630239335,
      0.08937875141784905,   0.07999344479713275,   0.05635607527713241,
      0.03779885783679899,   0.02682350649778468,   0.020904598140883274,
      0.01827468553910195,   0.018086087196115156,  0.020211730766432255,
      0.025267105448085397,  0.03497224898408298,   0.05310510124300479,
      0.08758552494869981,   0.15429449472152088,   0.28011615069499674,
      0.4737917109553141,    0.14081973224511277,   0.13493983999324802,
      0.11796868655338975,   0.0890788261450536,    0.061877157514368945,
      0.04179436553992008,   0.028361181632577614,  0.019799271507819762,
      0.014496418471927168,  0.011288448628322532,  0.00940973926620546,
      0.008364935693031142,  0.00782692627620778,   0.007560881383702707,
      0.007197931430034877,  0.006637957342859268,  0.14324994890479265,
      0.1478291894470452,    0.15427499087203148,   0.16021745778555307,
      0.16336711725455047,   0.16410147803814626,   0.16609286527521042,
      0.1741622524225189,    0.19356988782855647,   0.23124149389277232,
      0.2986584236207314,    0.41719664486894503,   0.6282485282459408,
      1.0104399338719874,    1.6905884728060907,    2.6943343912788444,
      0.075518536612019,     0.08194596805147537,   0.08982728404351761,
      0.09622947995959737,   0.09794246758314418,   0.09308842761008874,
      0.0832021270854681,    0.07152452221711332,   0.060690006225471785,
      0.05204410002527085,   0.04592901351435296,   0.04208403752757094,
      0.03996232520696267,   0.03887978251663941,   0.03706708333386891,
      0.03403308160464711,   0.0558944948049507,    0.017551164708075263,
      0.007645141310175259,  0.004210165155803657,  0.002731544562708394,
      0.002050568612331856,  0.0017772578817073028, 0.0017689770268989084,
      0.0019983220426051224, 0.0025273371248680458, 0.0035379951915414536,
      0.005432240085814536,  0.00905612102688167,   0.01611325378675181,
      0.0294999433628832,    0.05018936402315566,   0.09160970082095146,
      0.09556765931717838,   0.1005904392700862,    0.10398381673058439,
      0.10251450000547593,   0.09468230035219637,   0.08259182473102951,
      0.06961884379364884,   0.05817937950862068,   0.04932598249112431,
      0.04317554142140412,   0.03933798105475205,   0.0372134663341194,
      0.036116647653737316,  0.03440339934928525,   0.03161340630239335,
      0.08937875141784905,   0.07999344479713275,   0.05635607527713241,
      0.03779885783679899,   0.02682350649778468,   0.020904598140883274,
      0.01827468553910195,   0.018086087196115156,  0.020211730766432255,
      0.025267105448085397,  0.03497224898408298,   0.05310510124300479,
      0.08758552494869981,   0.15429449472152088,   0.28011615069499674,
      0.4737917109553141,    0.14081973224511277,   0.13493983999324802,
      0.11796868655338975,   0.0890788261450536,    0.061877157514368945,
      0.04179436553992008,   0.028361181632577614,  0.019799271507819762,
      0.014496418471927168,  0.011288448628322532,  0.00940973926620546,
      0.008364935693031142,  0.00782692627620778,   0.007560881383702707,
      0.007197931430034877,  0.006637957342859268,  0.14324994890479265,
      0.1478291894470452,    0.15427499087203148,   0.16021745778555307,
      0.16336711725455047,   0.16410147803814626,   0.16609286527521042,
      0.1741622524225189,    0.19356988782855647,   0.23124149389277232,
      0.2986584236207314,    0.41719664486894503,   0.6282485282459408,
      1.0104399338719874,    1.6905884728060907,    2.6943343912788444,
      0.075518536612019,     0.08194596805147537,   0.08982728404351761,
      0.09622947995959737,   0.09794246758314418,   0.09308842761008874,
      0.0832021270854681,    0.07152452221711332,   0.060690006225471785,
      0.05204410002527085,   0.04592901351435296,   0.04208403752757094,
      0.03996232520696267,   0.03887978251663941,   0.03706708333386891,
      0.03403308160464711,   0.0558944948049507,    0.017551164708075263,
      0.007645141310175259,  0.004210165155803657,  0.002731544562708394,
      0.002050568612331856,  0.0017772578817073028, 0.0017689770268989084,
      0.0019983220426051224, 0.0025273371248680458, 0.0035379951915414536,
      0.005432240085814536,  0.00905612102688167,   0.01611325378675181,
      0.0294999433628832,    0.05018936402315566,   0.09160970082095146,
      0.09556765931717838,   0.1005904392700862,    0.10398381673058439,
      0.10251450000547593,   0.09468230035219637,   0.08259182473102951,
      0.06961884379364884,   0.05817937950862068,   0.04932598249112431,
      0.04317554142140412,   0.03933798105475205,   0.0372134663341194,
      0.036116647653737316,  0.03440339934928525,   0.03161340630239335,
      0.08937875141784905,   0.07999344479713275,   0.05635607527713241,
      0.03779885783679899,   0.02682350649778468,   0.020904598140883274,
      0.01827468553910195,   0.018086087196115156,  0.020211730766432255,
      0.025267105448085397,  0.03497224898408298,   0.05310510124300479,
      0.08758552494869981,   0.15429449472152088,   0.28011615069499674,
      0.4737917109553141,    0.14081973224511277,   0.13493983999324802,
      0.11796868655338975,   0.0890788261450536,    0.061877157514368945,
      0.04179436553992008,   0.028361181632577614,  0.019799271507819762,
      0.014496418471927168,  0.011288448628322532,  0.00940973926620546,
      0.008364935693031142,  0.00782692627620778,   0.007560881383702707,
      0.007197931430034877,  0.006637957342859268,  0.14324994890479265,
      0.1478291894470452,    0.15427499087203148,   0.16021745778555307,
      0.16336711725455047,   0.16410147803814626,   0.16609286527521042,
      0.1741622524225189,    0.19356988782855647,   0.23124149389277232,
      0.2986584236207314,    0.41719664486894503,   0.6282485282459408,
      1.0104399338719874,    1.6905884728060907,    2.6943343912788444,
  }
                      .reshape(5, 3, 32)};
  const Matrix u0{Vector{
      0.07545379446594264,   0.08188542075481836,   0.0898345985094786,
      0.09628277876208055,   0.0978988083572487,    0.09311131571539603,
      0.08318781492051353,   0.07154305959618819,   0.060661774569441274,
      0.052079378994377756,  0.045900486032015936,  0.042084620966234214,
      0.040002528443282094,  0.03882380539055556,   0.037039043839399495,
      0.0342465922432685,    0.05585186522153316,   0.017547672198337024,
      0.007652345937388582,  0.004211510954556429,  0.002728391310218898,
      0.0020532442125733618, 0.0017749789573844735, 0.0017711514743537168,
      0.001996259720867868,  0.0025286473378942436, 0.003538729733852337,
      0.005428464215776079,  0.009060847761030198,  0.016117172604869025,
      0.029471081064439894,  0.05018740770134213,   0.09154942435925652,
      0.09551128835901808,   0.10059724920797106,   0.10403343404144211,
      0.1024738994469357,    0.09470352793128821,   0.08257859913022757,
      0.06963591015428647,   0.058153474820220714,  0.049358263014385825,
      0.04314949759674488,   0.03933851275222725,   0.03725005470830915,
      0.03606575368717893,   0.034377922714262266,  0.031807333010224516,
      0.08932752279954222,   0.07998089735453169,   0.05639899438094798,
      0.0378086835825521,    0.02679815320459259,   0.020927268013728968,
      0.018254762138800687,  0.01810548251403171,   0.020193085490509414,
      0.025279062978445083,  0.034978997662809985,  0.05307024191816655,
      0.08762931393197887,   0.15433088583302906,   0.27984770738313525,
      0.4737735033516487,    0.1407902368413889,    0.13491226915032203,
      0.11797189175463743,   0.08909943075423446,   0.0618627577122721,
      0.04180088000340439,   0.028357571407255745,  0.019803528348447206,
      0.014490383750901462,  0.011295591098150414,  0.00940419582272404,
      0.008365045632107085,  0.007834332063511345,  0.007550734648391406,
      0.007192902249727046,  0.006676035994535058,  0.14322488051554663,
      0.14782264529001404,   0.15430643043272338,   0.16022848937635403,
      0.16332517330565713,   0.16415233884379876,   0.16603695769009247,
      0.1742262165757421,    0.19350076666694094,   0.2312897806769391,
      0.29868743974564993,   0.4170396427587464,    0.6284525139348431,
      1.0106134939716558,    1.6892880705398163,    2.694245598619696,
  }
                      .reshape(3, 32)};
  const Vector flux_down_diffuse{
      0.02435117001460185,
      0.2337009522322481,
      1.6013414300105602,
  };
  const Vector flux_down_direct{
      3.1167369447694853,
      2.901700842189926,
      1.419637633150657,
  };
  const Vector flux_up{
      0.17271789128336412,
      0.1670318303799075,
      0.052611846559713744,
  };

  // flat_print(u, compute_u(dis, taus, phis, true) );
  //  const auto [flux_up_, flux_down_diffuse_, flux_down_direct_] =  compute_flux(dis, taus);
  //  flat_print(flux_down_diffuse, flux_down_diffuse_);

  compare("test_4a",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          true);
} catch (std::exception& e) {
  throw std::runtime_error(std::format("Error in test-4a:\n{}", e.what()));
}

void test_4b() try {
  const AscendingGrid tau_arr{1};
  const Vector omega_arr{0.9};
  const Index NQuad = 32;
  Matrix Leg_coeffs_all(1, Leg_coeffs_ALL.size(), 1);
  for (Index i = 1; i < Leg_coeffs_ALL.size(); i++) {
    Leg_coeffs_all[0, i] =
        Leg_coeffs_ALL[i] / (static_cast<Numeric>(2 * i + 1));
  }

  const Numeric mu0 = 1;
  const Numeric I0 = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{Leg_coeffs_all[0, NQuad]};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.007943282347242814,
      0.07943282347242814,
      0.7943282347242815,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.05546822055635811,   0.059411236887152816,  0.06399794550879834,
      0.06735949447072487,   0.06760378213683922,   0.06373813911273711,
      0.05688354856917976,   0.04914520058115947,   0.042172833421649694,
      0.03677822959653276,   0.03314194280494441,   0.03105505126700183,
      0.03011117697494129,   0.029788107845747275,  0.02856919141990051,
      0.02605767232923958,   0.04135523925815277,   0.01310657029927235,
      0.005804676750448516,  0.0032756451829364206, 0.0021911503694092135,
      0.001698932068805539,  0.0015153518822455232, 0.0015411318040949992,
      0.001765645528614884,  0.002251803067239367,  0.0031669995072983255,
      0.004874840230816298,  0.008137729535837586,  0.014489461820233045,
      0.026537134472732427,  0.045157109966752866,  0.06623396234337268,
      0.06843995139915722,   0.07102441804067305,   0.07232722005609514,
      0.07046074538749372,   0.0646598914523552,    0.05638569231848646,
      0.04780952949480802,   0.040431956396192216,  0.03487557550409033,
      0.031178194955785228,  0.02905128549695271,   0.028059329746722483,
      0.027686577477688296,  0.026531334603286882,  0.024224970699444022,
      0.06494421195529093,   0.05875964827589697,   0.042081089326757526,
      0.02886535297484219,   0.02107615531352536,   0.016955061279966547,
      0.015277375948938342,  0.015496631845003763,  0.017623422339345222,
      0.022281839969322793,  0.0310574116530776,    0.04736871096633799,
      0.07835219660550483,   0.13830786357425218,   0.25144756662964374,
      0.42567343581887307,   0.09597835406811656,   0.09181471194213268,
      0.08019132151171687,   0.06058837024252328,   0.042207933737798464,
      0.028683774768986054,  0.01965919058013716,   0.013916639118481755,
      0.010368599194896383,  0.008236362961720634,  0.00700976305119326,
      0.006355439486346645,  0.006047735288254459,  0.0059169218874485984,
      0.0056555036984607615, 0.005185379130062525,  0.09774674744969557,
      0.10117830972637715,   0.1063392918013422,    0.11184938584920633,
      0.11620389870216694,   0.11952178587690962,   0.12427614028286962,
      0.1340174734110688,    0.15299593834831543,   0.1872001399499858,
      0.24682081131727637,   0.3509727845544144,    0.5368288578221951,
      0.8753084065409261,    1.4813537709722482,    2.3799172697006976,
      0.05546822055635811,   0.059411236887152816,  0.06399794550879834,
      0.06735949447072487,   0.06760378213683922,   0.06373813911273711,
      0.05688354856917976,   0.04914520058115947,   0.042172833421649694,
      0.03677822959653276,   0.03314194280494441,   0.03105505126700183,
      0.03011117697494129,   0.029788107845747275,  0.02856919141990051,
      0.02605767232923958,   0.04135523925815277,   0.01310657029927235,
      0.005804676750448516,  0.0032756451829364206, 0.0021911503694092135,
      0.001698932068805539,  0.0015153518822455232, 0.0015411318040949992,
      0.001765645528614884,  0.002251803067239367,  0.0031669995072983255,
      0.004874840230816298,  0.008137729535837586,  0.014489461820233045,
      0.026537134472732427,  0.045157109966752866,  0.06623396234337268,
      0.06843995139915722,   0.07102441804067305,   0.07232722005609514,
      0.07046074538749372,   0.0646598914523552,    0.05638569231848646,
      0.04780952949480802,   0.040431956396192216,  0.03487557550409033,
      0.031178194955785228,  0.02905128549695271,   0.028059329746722483,
      0.027686577477688296,  0.026531334603286882,  0.024224970699444022,
      0.06494421195529093,   0.05875964827589697,   0.042081089326757526,
      0.02886535297484219,   0.02107615531352536,   0.016955061279966547,
      0.015277375948938342,  0.015496631845003763,  0.017623422339345222,
      0.022281839969322793,  0.0310574116530776,    0.04736871096633799,
      0.07835219660550483,   0.13830786357425218,   0.25144756662964374,
      0.42567343581887307,   0.09597835406811656,   0.09181471194213268,
      0.08019132151171687,   0.06058837024252328,   0.042207933737798464,
      0.028683774768986054,  0.01965919058013716,   0.013916639118481755,
      0.010368599194896383,  0.008236362961720634,  0.00700976305119326,
      0.006355439486346645,  0.006047735288254459,  0.0059169218874485984,
      0.0056555036984607615, 0.005185379130062525,  0.09774674744969557,
      0.10117830972637715,   0.1063392918013422,    0.11184938584920633,
      0.11620389870216694,   0.11952178587690962,   0.12427614028286962,
      0.1340174734110688,    0.15299593834831543,   0.1872001399499858,
      0.24682081131727637,   0.3509727845544144,    0.5368288578221951,
      0.8753084065409261,    1.4813537709722482,    2.3799172697006976,
      0.05546822055635811,   0.059411236887152816,  0.06399794550879834,
      0.06735949447072487,   0.06760378213683922,   0.06373813911273711,
      0.05688354856917976,   0.04914520058115947,   0.042172833421649694,
      0.03677822959653276,   0.03314194280494441,   0.03105505126700183,
      0.03011117697494129,   0.029788107845747275,  0.02856919141990051,
      0.02605767232923958,   0.04135523925815277,   0.01310657029927235,
      0.005804676750448516,  0.0032756451829364206, 0.0021911503694092135,
      0.001698932068805539,  0.0015153518822455232, 0.0015411318040949992,
      0.001765645528614884,  0.002251803067239367,  0.0031669995072983255,
      0.004874840230816298,  0.008137729535837586,  0.014489461820233045,
      0.026537134472732427,  0.045157109966752866,  0.06623396234337268,
      0.06843995139915722,   0.07102441804067305,   0.07232722005609514,
      0.07046074538749372,   0.0646598914523552,    0.05638569231848646,
      0.04780952949480802,   0.040431956396192216,  0.03487557550409033,
      0.031178194955785228,  0.02905128549695271,   0.028059329746722483,
      0.027686577477688296,  0.026531334603286882,  0.024224970699444022,
      0.06494421195529093,   0.05875964827589697,   0.042081089326757526,
      0.02886535297484219,   0.02107615531352536,   0.016955061279966547,
      0.015277375948938342,  0.015496631845003763,  0.017623422339345222,
      0.022281839969322793,  0.0310574116530776,    0.04736871096633799,
      0.07835219660550483,   0.13830786357425218,   0.25144756662964374,
      0.42567343581887307,   0.09597835406811656,   0.09181471194213268,
      0.08019132151171687,   0.06058837024252328,   0.042207933737798464,
      0.028683774768986054,  0.01965919058013716,   0.013916639118481755,
      0.010368599194896383,  0.008236362961720634,  0.00700976305119326,
      0.006355439486346645,  0.006047735288254459,  0.0059169218874485984,
      0.0056555036984607615, 0.005185379130062525,  0.09774674744969557,
      0.10117830972637715,   0.1063392918013422,    0.11184938584920633,
      0.11620389870216694,   0.11952178587690962,   0.12427614028286962,
      0.1340174734110688,    0.15299593834831543,   0.1872001399499858,
      0.24682081131727637,   0.3509727845544144,    0.5368288578221951,
      0.8753084065409261,    1.4813537709722482,    2.3799172697006976,
      0.05546822055635811,   0.059411236887152816,  0.06399794550879834,
      0.06735949447072487,   0.06760378213683922,   0.06373813911273711,
      0.05688354856917976,   0.04914520058115947,   0.042172833421649694,
      0.03677822959653276,   0.03314194280494441,   0.03105505126700183,
      0.03011117697494129,   0.029788107845747275,  0.02856919141990051,
      0.02605767232923958,   0.04135523925815277,   0.01310657029927235,
      0.005804676750448516,  0.0032756451829364206, 0.0021911503694092135,
      0.001698932068805539,  0.0015153518822455232, 0.0015411318040949992,
      0.001765645528614884,  0.002251803067239367,  0.0031669995072983255,
      0.004874840230816298,  0.008137729535837586,  0.014489461820233045,
      0.026537134472732427,  0.045157109966752866,  0.06623396234337268,
      0.06843995139915722,   0.07102441804067305,   0.07232722005609514,
      0.07046074538749372,   0.0646598914523552,    0.05638569231848646,
      0.04780952949480802,   0.040431956396192216,  0.03487557550409033,
      0.031178194955785228,  0.02905128549695271,   0.028059329746722483,
      0.027686577477688296,  0.026531334603286882,  0.024224970699444022,
      0.06494421195529093,   0.05875964827589697,   0.042081089326757526,
      0.02886535297484219,   0.02107615531352536,   0.016955061279966547,
      0.015277375948938342,  0.015496631845003763,  0.017623422339345222,
      0.022281839969322793,  0.0310574116530776,    0.04736871096633799,
      0.07835219660550483,   0.13830786357425218,   0.25144756662964374,
      0.42567343581887307,   0.09597835406811656,   0.09181471194213268,
      0.08019132151171687,   0.06058837024252328,   0.042207933737798464,
      0.028683774768986054,  0.01965919058013716,   0.013916639118481755,
      0.010368599194896383,  0.008236362961720634,  0.00700976305119326,
      0.006355439486346645,  0.006047735288254459,  0.0059169218874485984,
      0.0056555036984607615, 0.005185379130062525,  0.09774674744969557,
      0.10117830972637715,   0.1063392918013422,    0.11184938584920633,
      0.11620389870216694,   0.11952178587690962,   0.12427614028286962,
      0.1340174734110688,    0.15299593834831543,   0.1872001399499858,
      0.24682081131727637,   0.3509727845544144,    0.5368288578221951,
      0.8753084065409261,    1.4813537709722482,    2.3799172697006976,
      0.05546822055635811,   0.059411236887152816,  0.06399794550879834,
      0.06735949447072487,   0.06760378213683922,   0.06373813911273711,
      0.05688354856917976,   0.04914520058115947,   0.042172833421649694,
      0.03677822959653276,   0.03314194280494441,   0.03105505126700183,
      0.03011117697494129,   0.029788107845747275,  0.02856919141990051,
      0.02605767232923958,   0.04135523925815277,   0.01310657029927235,
      0.005804676750448516,  0.0032756451829364206, 0.0021911503694092135,
      0.001698932068805539,  0.0015153518822455232, 0.0015411318040949992,
      0.001765645528614884,  0.002251803067239367,  0.0031669995072983255,
      0.004874840230816298,  0.008137729535837586,  0.014489461820233045,
      0.026537134472732427,  0.045157109966752866,  0.06623396234337268,
      0.06843995139915722,   0.07102441804067305,   0.07232722005609514,
      0.07046074538749372,   0.0646598914523552,    0.05638569231848646,
      0.04780952949480802,   0.040431956396192216,  0.03487557550409033,
      0.031178194955785228,  0.02905128549695271,   0.028059329746722483,
      0.027686577477688296,  0.026531334603286882,  0.024224970699444022,
      0.06494421195529093,   0.05875964827589697,   0.042081089326757526,
      0.02886535297484219,   0.02107615531352536,   0.016955061279966547,
      0.015277375948938342,  0.015496631845003763,  0.017623422339345222,
      0.022281839969322793,  0.0310574116530776,    0.04736871096633799,
      0.07835219660550483,   0.13830786357425218,   0.25144756662964374,
      0.42567343581887307,   0.09597835406811656,   0.09181471194213268,
      0.08019132151171687,   0.06058837024252328,   0.042207933737798464,
      0.028683774768986054,  0.01965919058013716,   0.013916639118481755,
      0.010368599194896383,  0.008236362961720634,  0.00700976305119326,
      0.006355439486346645,  0.006047735288254459,  0.0059169218874485984,
      0.0056555036984607615, 0.005185379130062525,  0.09774674744969557,
      0.10117830972637715,   0.1063392918013422,    0.11184938584920633,
      0.11620389870216694,   0.11952178587690962,   0.12427614028286962,
      0.1340174734110688,    0.15299593834831543,   0.1872001399499858,
      0.24682081131727637,   0.3509727845544144,    0.5368288578221951,
      0.8753084065409261,    1.4813537709722482,    2.3799172697006976,
  }
                      .reshape(5, 3, 32)};
  const Matrix u0{Vector{
      0.055409954112945185,  0.05935674571180144,   0.06400452836004542,
      0.06740746216920337,   0.06756448982377894,   0.0637587379057587,
      0.056870667919115915,  0.049161883856704135,  0.042147425459112,
      0.036809980039718464,  0.03311626855931635,   0.031055576352133723,
      0.030147359238737615,  0.02973772931843016,   0.028543956312977486,
      0.026249828591923187,  0.041316873175561965,  0.013103427049241388,
      0.005811160910868605,  0.0032768564017950207, 0.002188312441211421,
      0.001701340110241569,  0.0015133008491226934, 0.0015430888080873685,
      0.001763789437790907,  0.002252982259739798,  0.0031676605959638855,
      0.004871441945224576,  0.008141983599513057,  0.01449298875959492,
      0.02651115838583919,   0.04515534927277979,   0.06617971501534525,
      0.06838921892793123,   0.07103054681671536,   0.07237187441354838,
      0.07042420586889508,   0.06467899577905503,   0.05637378956954381,
      0.047824888863907955,  0.04040864268797285,   0.03490462736706904,
      0.031154755985156345,  0.02905176401535524,   0.02809225865755486,
      0.02764077376257135,   0.026508406054371228,  0.024399501541428302,
      0.06489810747077714,   0.05874835584368249,   0.042119716021052626,
      0.028874196070219803,  0.021053337473118102,  0.01697546408696525,
      0.015259444941619795,  0.01551408758876503,   0.01760664162798473,
      0.022292601720678703,  0.03106348546313174,   0.04733733762025883,
      0.07839160660825116,   0.1383406155636899,    0.2512059681219047,
      0.42565704871899024,   0.09595180943217364,   0.09178989932838831,
      0.08019420606929953,   0.06060691369789418,   0.042194974347124756,
      0.028689637606744648,  0.0196559414710429,    0.01392047016911974,
      0.01036316809165383,   0.008242791015925144,  0.0070047740808234105,
      0.006355538428991935,  0.006054400328354756,  0.005907790055069345,
      0.0056509775494264424, 0.005219649061002945,  0.09772418698294823,
      0.1011724203349907,    0.10636758612801692,   0.11185931372378063,
      0.11616615084818704,   0.11956755880240126,   0.12422582520679072,
      0.13407503932965695,   0.15293373119620382,   0.18724359661178744,
      0.2468469255802022,    0.35083148600671676,   0.5370124394395265,
      0.8754646087160942,    1.4801834424056928,    2.3798373444870062,
  }
                      .reshape(3, 32)};
  const Vector flux_down_diffuse{
      0.02173248908809939,
      0.20765428900801491,
      1.3574585838677038,
  };
  const Vector flux_down_direct{
      3.1167369447694853,
      2.901700842189926,
      1.419637633150657,
  };
  const Vector flux_up{
      0.12327751843141174,
      0.11901321616971451,
      0.037555868709280404,
  };

  // flat_print(u, compute_u(dis, taus, phis, true) );
  //  const auto [flux_up_, flux_down_diffuse_, flux_down_direct_] =  compute_flux(dis, taus);
  //  flat_print(flux_down_diffuse, flux_down_diffuse_);

  compare("test_4b",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          true);
} catch (std::exception& e) {
  throw std::runtime_error(std::format("Error in test-4b:\n{}", e.what()));
}

void test_4c() try {
  const AscendingGrid tau_arr{1};
  const Vector omega_arr{0.9};
  const Index NQuad = 32;
  Matrix Leg_coeffs_all(1, Leg_coeffs_ALL.size(), 1);
  for (Index i = 1; i < Leg_coeffs_ALL.size(); i++) {
    Leg_coeffs_all[0, i] =
        Leg_coeffs_ALL[i] / (static_cast<Numeric>(2 * i + 1));
  }

  const Numeric mu0 = 0.5;
  const Numeric I0 = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{Leg_coeffs_all[0, NQuad]};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.007943282347242814,
      0.07943282347242814,
      0.7943282347242815,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      1.0635700454994104,     1.0313811222476703,     0.950290676868214,
      0.8263828034825663,     0.6767375396981306,     0.5217920520655258,
      0.38176195761553405,    0.26887535492610304,    0.18528553201861878,
      0.1269171025222783,     0.08768523544678133,    0.0619306393010073,
      0.04527459857256871,    0.034650333710054486,   0.028043259263078397,
      0.024194455816948218,   0.8326975232800528,     0.286402653473289,
      0.14695058365769925,    0.10247169102888644,    0.0890577962833536,
      0.09122817590065702,    0.10314656532990181,    0.11300526188907212,
      0.09297533358505182,    0.053807483145228326,   0.02691088519647847,
      0.013116632617305163,   0.0065426215219256565,  0.003424120100746065,
      0.0019066346634223298,  0.0011399919832205806,  1.1616139726579193,
      1.0988786545316742,     0.9873654131579553,     0.839758962798741,
      0.6739841994405043,     0.5100007522220135,     0.3668896080247359,
      0.254688954424016,      0.17342437908161193,    0.11766337411908066,
      0.08069780606474063,    0.056692617943867145,   0.041299325583990326,
      0.03154610845091854,    0.02551386298657046,    0.022018097891434683,
      1.1897994966102652,     1.1791407848860271,     0.9732924978241444,
      0.8112784110061879,     0.7558102746402842,     0.7945366301963381,
      0.9073526848003689,     1.0009981803327477,     0.8321168018405242,
      0.4885999371760214,     0.2483748683371254,     0.12310347859064533,
      0.06241510273220526,    0.03316190472427098,    0.01871177853760324,
      0.011313853593810432,   0.7403674354325608,     0.6739511512948008,
      0.5465437194560101,     0.3797062968336693,     0.23987653950271542,
      0.1448556523118123,     0.08592818823284107,    0.05099113321832003,
      0.03072137679301328,    0.019037918250961648,   0.012275328184189829,
      0.008320075262598087,   0.0059807720478444815,  0.004592362823511097,
      0.003785509287144371,   0.0033567098454885926,  0.7727898109644037,
      0.8443824658304688,     0.9822830245833298,     1.2028121304776505,
      1.5158838785111046,     1.9328103919379838,     2.4711080881074454,
      2.968033785672419,      2.756072319394043,      1.8751195141837491,
      1.1173626926275222,     0.6468797166286065,     0.3785672644715373,
      0.22811026120316955,    0.1430082395550376,     0.09408298867798016,
      0.07335181309895841,    0.07960403884481163,    0.08648273600800536,
      0.0908408484009438,     0.09025407715379473,    0.08406927617051317,
      0.07405400397414955,    0.06283220780321111,    0.05235656958530554,
      0.0435692658779694,     0.0366792574440718,     0.031525002077379384,
      0.02781577624485395,    0.025265533949281258,   0.0236446070151711,
      0.022794069221352003,   0.05410850245063635,    0.016868106924970098,
      0.007227951324140392,   0.0038503095279375735,  0.0023487852502362284,
      0.0015907003230766488,  0.0011820667694202984,  0.0009557015748156045,
      0.0008313974224938181,  0.0007677091720795781,  0.0007417852643815473,
      0.0007397936084181625,  0.0007521488442215343,  0.0007710103406190284,
      0.0007894683216508015,  0.000801830929591687,   0.08744925997898666,
      0.09081840252116063,    0.09439952597265253,    0.0955206977821651,
      0.09196695452873672,    0.0834005173912592,     0.0718549727981079,
      0.05989677431260286,    0.04922955415445777,    0.040544103648016215,
      0.03387342934272705,    0.028955855653623023,   0.025453606363752268,
      0.02306300829015494,    0.0215507740659756,     0.02075949918801941,
      0.08540639165085619,    0.07628844638905727,    0.05304098245472933,
      0.03453883052645357,    0.02318618632828948,    0.01644317470942205,
      0.012438415670886188,   0.010070533509975724,   0.008701361578036668,
      0.007957333331995742,   0.007614414964929705,   0.007530022092075718,
      0.007603683523173111,   0.007754326112526312,   0.007912090896193094,
      0.00802043955892391,    0.08927230164851614,    0.0849203153549531,
      0.07373836935448945,    0.05590876315489604,    0.03930895974855153,
      0.026958254120606623,   0.018541413802124682,   0.013018983685577003,
      0.00944899621574572,    0.007144811969682882,   0.005649039046222198,
      0.0046714023375098,     0.004031596827934326,   0.0036193073271811173,
      0.0033680370632107816,  0.003239377890642549,   0.09112939125174234,
      0.09470852184367833,    0.0998830576183494,     0.10447059171169581,
      0.10542721480968378,    0.10154401543368584,    0.09453831022808558,
      0.08682727637130556,    0.08006515092668379,    0.07498381271403934,
      0.07168882512783253,    0.06994994679450622,    0.06938449368128796,
      0.06955146966735495,    0.07001483143765608,    0.07040689210339139,
      0.0584156069411588,     0.06273476028980463,    0.06756616347237145,
      0.07092770263765369,    0.07113461186886386,    0.06686536811921859,
      0.05830503088669642,    0.05206787714986465,    0.045278913076830504,
      0.03917415108002779,    0.035807730467618086,   0.031208517832332854,
      0.027180001497357043,   0.024211785135322964,   0.022439624619042878,
      0.02197964543727148,    0.04330910590270296,    0.013321047130471603,
      0.005548596452476852,   0.002822705049205312,   0.0016089607421563448,
      0.0009940688684009944,  0.0006596221784354218,  0.00047051013467285923,
      0.0003619323473315017,  0.00030131709543558066, 0.000272268569368588,
      0.00026783981808825645, 0.00028745387787529976, 0.0003367307604663852,
      0.00042971224173907175, 0.0005942145068373412,  0.06512850378630779,
      0.0675156030289387,     0.07023119963524128,    0.07162129292828526,
      0.07013336049591914,    0.06469384453190642,    0.055707006462577396,
      0.04904295871112497,    0.042232115035389095,   0.036283035730499624,
      0.03288358024019858,    0.028563018782244123,   0.024835161023793142,
      0.02210066893237419,    0.020466182748959262,   0.02002860187522049,
      0.06370532604499908,    0.056935668479298235,   0.038845565929862234,
      0.02431310514293952,    0.015369792672698767,   0.010043541297380108,
      0.006860979228115477,   0.00495282340581864,    0.003815213464245425,
      0.0031623077590874366,  0.00283818122776275,    0.00277182368710493,
      0.00295411823020911,    0.0034373634962210995,  0.004356561065602847,
      0.00597973014975424,    0.051209128687439494,   0.049245164085758665,
      0.043772219273035755,   0.03457372325261648,    0.025738640103129384,
      0.01883534102417841,    0.013715963396070008,   0.010549208328693147,
      0.008316292994741873,   0.0067512674086053015,  0.005815123748356345,
      0.004926810449858258,   0.00421255661797628,    0.0036875832677483347,
      0.003347412957832837,   0.0031947379517931205,  0.05202185882582041,
      0.05353953705787799,    0.05556836107983806,    0.05688929617690755,
      0.05569169996886017,    0.05133147549902204,    0.04512980118050464,
      0.03881543762387256,    0.033526720681607565,   0.02977930068414818,
      0.02774190442280697,    0.027509348488548364,   0.029297102474269237,
      0.03361329713557153,    0.041464770831778776,   0.05463965206389537,
      0.0732639552320304,     0.07950914624882756,    0.0863810821922515,
      0.09073684956467558,    0.09015493136972128,    0.08398202004567525,
      0.07398279105212821,    0.06277751425706346,    0.05231654517636499,
      0.04354100416357421,    0.03665992856391112,    0.031512174254302666,
      0.027807538889153247,   0.02526050596485776,    0.023641833214421305,
      0.022792963465862816,   0.054043560689351754,   0.016847547084864137,
      0.007218886377260985,   0.0038452758503029734,  0.002345542722067589,
      0.0015883615599977187,  0.0011802141441539262,  0.0009541199613234336,
      0.0008299723226948991,  0.0007663831465661063,  0.000740541251644542,
      0.0007386444088618661,  0.0007511327128852988,  0.0007701855899216419,
      0.0007888996468505381,  0.0008015714230375237,  0.0873417461295161,
      0.09070781008358589,    0.09428675711551282,    0.09541001450633309,
      0.0918649796212912,     0.08331331476607816,    0.07178547077086744,
      0.05984441522489741,    0.04919182658167776,    0.04051779631845399,
      0.0338556172229558,     0.028944129727572616,   0.025446125889416693,
      0.023058465620513387,   0.021548277344476778,   0.020758506082928476,
      0.08530096423401516,    0.0761934212928292,     0.05297340371577541,
      0.0344932303550876,     0.023154101116100098,   0.016419139176627986,
      0.012419176908307909,   0.010054171202765349,   0.008686759730042312,
      0.007943893467717341,   0.007601929970086796,   0.0075185831804180205,
      0.007593635157871268,   0.007746209822131358,   0.007906513114605733,
      0.008017898830125983,   0.08916202373363263,    0.08481652092008851,
      0.07364995917873841,    0.05584374407150495,    0.039265298766110714,
      0.0269302278461875,     0.018523854172918318,   0.013008128911324447,
      0.009442350341816296,   0.007140774376044137,   0.005646617667973055,
      0.004669979043105566,   0.004030784546986553,   0.003618865841011595,
      0.0033678179823013474,  0.0032392968049377684,  0.09101624973578526,
      0.09458967242586692,    0.099755344422037,      0.10433356737965657,
      0.10528471480734976,    0.10140229539311293,    0.09440225440561816,
      0.08669922093011669,    0.07994567168421517,    0.07487291361456491,
      0.0715869371779703,     0.06985844058972264,    0.06930587705505668,
      0.06948921527812031,    0.0699726897307907,     0.0703878661077918,
      1.0635664720400526,     1.0313779569197106,     0.9502881369953059,
      0.8263809331785863,     0.676736257607786,      0.5217912252760836,
      0.3817614508013288,     0.26887505621922836,    0.18528536096543274,
      0.12691700664451916,    0.087685182662518,      0.06193061083032767,
      0.04527458371534882,    0.034650326436970545,   0.028043256189856113,
      0.02419445496739299,    0.8326945944653017,     0.2864015759312301,
      0.14694996243329728,    0.10247118107035667,    0.08905725202578807,
      0.09122746088235124,    0.10314547899822554,    0.11300369092625344,
      0.09297412262816875,    0.0538070376959258,     0.026910751230971804,
      0.013116592702558294,   0.006542609453839232,   0.003424116456098088,
      0.0019066336280845573,  0.0011399917649835166,  1.1616103744703923,
      1.0988755030403425,     0.9873629113601422,     0.8397571380501662,
      0.673982960571965,      0.5099999616532005,     0.3668891285884553,
      0.25468867469417755,    0.17342422032776084,    0.11766328581339452,
      0.08069775775520704,    0.05669259201933207,    0.04129931211015354,
      0.03154610187671805,    0.02551386021620954,    0.022018097127466017,
      1.1897956658388515,     1.1791366644791172,     0.9732886428955931,
      0.8112746084664916,     0.7558058900429628,     0.7945306554038305,
      0.9073434176442446,     1.0009845801128876,     0.8321061806210528,
      0.48859597866214854,    0.24837366143372402,    0.12310311375291284,
      0.06241499074267142,    0.033161870381075584,   0.01871176863664164,
      0.011313851478346435,   0.7403658374116515,     0.6739497670111031,
      0.5465426805671092,     0.379705641294956,      0.2398761689931974,
      0.1448554547140982,     0.08592808605098333,    0.05099108115943703,
      0.030721350391161497,   0.019037904846552597,   0.01227532136803595,
      0.008320071813659846,   0.005980770342594062,   0.004592362031521351,
      0.0037855089739550016,  0.0033567097686254314,  0.772788100906056,
      0.8443804905570022,     0.9822804656387246,     1.202808411596309,
      1.5158779164428018,     1.9328000514649317,     2.471089011940399,
      2.968001607657075,      2.756043664049215,      1.8751072864978553,
      1.1173584007516175,     0.6468782172693082,     0.3785667326313918,
      0.22811007383388698,    0.14300817821676495,    0.09408297402355946,
  }
                      .reshape(5, 3, 32)};
  const Matrix u0{Vector{
      0.23705162089052095,   0.2412190589131112,    0.23877512556804495,
      0.22593129552984226,   0.20228794442690748,   0.17072898795401356,
      0.1369312055014745,    0.10621878529574728,   0.08122826174750086,
      0.06229935337752246,   0.04856246621037301,   0.03873473578358826,
      0.03189632967776782,   0.02731193680061299,   0.02444011191909011,
      0.02293568193210174,   0.1809869242966403,    0.05983563179136447,
      0.028634037621330155,  0.01810574164663575,   0.01397677527733145,
      0.012565759438150335,  0.012467501953690736,  0.01234451548282159,
      0.010444241798966735,  0.007186443134601126,  0.004487589919263455,
      0.0027813877976064073, 0.0018017092708790753, 0.0012588220929484449,
      0.0009689802675128264, 0.0008341296929890326, 0.2691230534867352,
      0.26493310042394386,   0.25358148630953903,   0.23304629177763758,
      0.2034242683157734,    0.16786334357627483,   0.13206106440631274,
      0.10082512306542021,   0.07613181360802339,   0.057820965316388584,
      0.044744515448360854,  0.035512441262255966,  0.029149199547916043,
      0.02491098280760372,   0.022267723162537088,  0.020887238216495786,
      0.2701497209636098,    0.2563251443463251,    0.19740073760368962,
      0.14967639828202292,   0.12398834290714182,   0.11404314864980764,
      0.11360546251513681,   0.11261878205330644,   0.0959230503310723,
      0.06686636644191928,   0.04241399551481145,   0.026707610570276742,
      0.01755074785340491,   0.012407380696537447,  0.009631587679556625,
      0.00833044780241888,   0.20700785856321857,   0.19242253663041445,
      0.16129066249253105,   0.11699172806959905,   0.0779840767152533,
      0.050266756311287075,  0.032240641286739674,  0.02099520446439917,
      0.014100973750858057,  0.009880542005083362,  0.007268315049512105,
      0.005611503059465481,  0.004550109404438507,  0.003875616600683067,
      0.0034669059748039547, 0.0032570619617404827, 0.21381374719631627,
      0.22819770386771351,   0.25363463515281326,   0.2888323212865843,
      0.3288541142498077,    0.3688894253102731,    0.4077190748959853,
      0.4318719590217775,    0.4026646117222593,    0.3200944441082327,
      0.23464261984646273,   0.1695078456035194,    0.12540324753240212,
      0.09733903054913996,   0.08068361620690091,   0.07236743230101543,
  }
                      .reshape(3, 32)};
  const Vector flux_down_diffuse{
      0.0208785903553725,
      0.1884427167369132,
      0.7993050216383508,
  };
  const Vector flux_down_direct{
      1.5460389448948937,
      1.3400635769797566,
      0.3207562583192799,
  };
  const Vector flux_up{
      0.22468327389391207,
      0.21448592530495367,
      0.053273482889755995,
  };

  //flat_print(u, compute_u(dis, taus, phis, true) );
  //  const auto [flux_up_, flux_down_diffuse_, flux_down_direct_] =  compute_flux(dis, taus);
  //  flat_print(flux_down_diffuse, flux_down_diffuse_);

  compare("test_4c",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          true);
} catch (std::exception& e) {
  throw std::runtime_error(std::format("Error in test-4c:\n{}", e.what()));
}

int main() try {
  std::cout << std::setprecision(16);
  test_4a();
  test_4b();
  test_4c();
} catch (std::exception& e) {
  std::cerr << "Error in main:\n" << e.what() << '\n';
  return EXIT_FAILURE;
}
