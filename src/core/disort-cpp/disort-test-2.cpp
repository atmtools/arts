#include <disort-test.h>

void test_2a() {
  const AscendingGrid tau_arr{0.2};
  const Vector omega_arr{0.5};
  const Index NQuad = 16;
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  Leg_coeffs_all[0, 2] = 0.1;

  const Numeric mu0  = 0.080442;
  const Numeric I0   = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.0015886564694485628,
      0.015886564694485628,
      0.1588656469448563,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.1561311861919676,     0.08638585024047925,    0.04729067391128542,
      0.028409076319742283,   0.018373874786892876,   0.012597791159567148,
      0.009296455101669219,   0.00774570420071888,    0.014903242883786033,
      0.0030096734873206973,  0.001279768037014509,   0.0007127786632087084,
      0.00045026061544546365, 0.0003047897834893786,  0.00021899740137544153,
      0.0001725965412486519,  0.13253349027498823,    0.0729781509440335,
      0.03971061397295092,    0.023794109289471885,   0.015379498169119543,
      0.010550392613430132,   0.007794467262493139,   0.006500059721148297,
      0.09739874308759502,    0.025868343618095122,   0.011456480410668247,
      0.006464355089269236,   0.004107400855181298,   0.0027895128936317307,
      0.0020087656480993438,  0.00158562162051949,    0.024442589619082297,
      0.008718341540082606,   0.004019047864312807,   0.0022722417773627522,
      0.0014413731718674809,  0.0009893501446313097,  0.0007384499995024364,
      0.0006215372222292928,  0.04145092396331483,    0.05673929634477565,
      0.03949994570003181,    0.026052713925845617,   0.017769727048831306,
      0.012546506884339446,   0.009258425396531836,   0.007421901982741076,
      0.08238233341666351,    0.04700854995744025,    0.02675264439970333,
      0.01719409387206973,    0.01238059106652975,    0.009785198202888755,
      0.008371223310605452,   0.0076914592798373,     0.007739260654482851,
      0.0015605332551427889,  0.0006715619564085279,  0.0003904778860178782,
      0.00026926424849642587, 0.0002086240001226152,  0.00017690260948801108,
      0.00016198156098637035, 0.07064575958051514,    0.040089290539521004,
      0.022656169467009237,   0.014507857734597219,   0.010423802185267656,
      0.008226286524018304,   0.007030050282129389,   0.006455103433265337,
      0.05090936464807766,    0.013491487338446169,   0.0060457355467619925,
      0.003559801169331118,   0.0024671975282678717,  0.001915661918932774,
      0.0016257300258774971,  0.001488985603728977,   0.014514740892514286,
      0.005247754742935454,   0.002486733141116856,   0.0014873478279462935,
      0.0010340166758908158,  0.0008009599605771753,  0.0006768826851758884,
      0.0006178709772097915,  0.02375469091581934,    0.031092243587909525,
      0.021701467348472708,   0.014864065016479624,   0.010996317961783022,
      0.008809425251296589,   0.007590429957842192,   0.006997763093999456,
      0.15660238079531005,    0.08769497260579313,    0.048959598228151206,
      0.030136031037805718,   0.019966857995577143,   0.013904390546302716,
      0.010194573099889755,   0.008153320404846412,   0.014857660758533519,
      0.0029628432752956996,  0.0012338330362911467,  0.0006695537408856032,
      0.0004120654879616411,  0.00027414115173237275, 0.0001981731447400184,
      0.00016319692640076716, 0.13292827581244648,    0.07407019733296197,
      0.04109487029064439,    0.025222439363136607,   0.016695152610201953,
      0.011628702676096796,   0.008535362349150252,   0.006836253584620295,
      0.09710329794378368,    0.0254687972543394,     0.011048247274068638,
      0.006075196946381438,   0.0037615984229819426,  0.002511256545802262,
      0.0018194276715479936,  0.0015000999323971102,  0.024505414911040708,
      0.008832876145795374,   0.004142722592775438,   0.0023922938885559434,
      0.0015488970228141972,  0.0010762154724550564,  0.000797680094403817,
      0.0006483169380537868,  0.04133949201499859,    0.05591588454793815,
      0.0381632150916727,     0.024559944794668984,   0.016347329959456067,
      0.011360888569871129,   0.008436612160721398,   0.007047450145490177,
      0.08238260601540559,    0.04700922453946856,    0.02675348955066594,
      0.01719496339005142,    0.012381390953762547,   0.00978585323587318,
      0.00837167305686092,    0.007691663216970531,   0.00773924143491147,
      0.0015605105530807108,  0.0006715392816037152,  0.0003904564239413843,
      0.0002692452319049074,  0.00020860871623964997, 0.0001768922132063951,
      0.0001619768641379086,  0.07064598802357888,    0.040089853284262345,
      0.022656870470578825,   0.014508576900995586,   0.01042446281986235,
      0.008226827110965066,   0.007030421297196662,   0.0064552716367275486,
      0.05090924010214591,    0.013491293655354902,   0.006045534034186255,
      0.0035596079456121665,  0.002467025360909639,   0.0019155231582309324,
      0.001625635501121401,   0.0014889428698350263,  0.014514777286031505,
      0.005247813774598552,   0.00248679577574801,    0.0014874082765593704,
      0.0010340706684258546,  0.0008010035091756051,  0.0006769123458219064,
      0.0006178843755960739,  0.023754644022316144,   0.031091844502894445,
      0.021700807550456648,   0.014863323854452454,   0.010995609795197626,
      0.008808834014748872,   0.0075900196799814626,  0.0069975759865922825,
      0.15613111232539045,    0.08638581053607032,    0.04729065295623784,
      0.02840906467323948,    0.018373868395563833,   0.012597788020488346,
      0.009296453952020445,   0.007745704044620899,   0.014903235731195128,
      0.0030096720498824633,  0.0012797674402865605,  0.0007127783517088228,
      0.00045026044399313936, 0.0003047896949819401,  0.0002189973644841181,
      0.00017259653298240199, 0.13253342828862344,    0.07297811778230491,
      0.039710596572619015,   0.023794099646318383,   0.01537949288467553,
      0.010550390019881874,   0.007794466312945208,   0.006500059592185599,
      0.09739869667205059,    0.025868331341078042,   0.011456475101931736,
      0.006464352281956786,   0.004107399301385672,   0.0027895120893102246,
      0.002008765312374616,   0.0015856215452532197,  0.02444257967553717,
      0.008718338040877207,   0.004019046301095188,   0.0022722409624709532,
      0.0014413727376435548,  0.000989349934535697,   0.0007384499231350189,
      0.0006215372118714689,  0.04145090629492953,    0.05673927090347819,
      0.039499928235572634,   0.02605270311020463,    0.017769720630845007,
      0.012546503443514889,   0.00925842393388727,    0.007421901652168403,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.11937459022534644,   0.06702456378251162,    0.0374389952367809,
      0.023233432114714944,  0.01577557852750885,    0.011518226319151597,
      0.009058424895067934,  0.00782051128175966,    0.011309853611500137,
      0.0022733929351817454, 0.0009641783931732813,  0.0005408193512007202,
      0.0003502112673696155, 0.00024904282037595515, 0.0001927426404220438,
      0.0001649385599676907, 0.10168834793351113,    0.0568068016543339,
      0.031529542891909186,  0.01950815563606639,    0.013230646211933355,
      0.009657984585139357,  0.007597528896976716,   0.006561651067105337,
      0.07408017556084695,   0.019580004290165508,   0.008649024336404318,
      0.004914764349843026,  0.0032008270114959212,  0.002283005946927143,
      0.0017699015152847304, 0.0015159178453363516,  0.01949437581773283,
      0.00701168906344019,   0.003283816966275525,   0.0019098153620024628,
      0.0012645826229536598, 0.0009168768222484698,  0.0007224775717217445,
      0.00062640070335959,   0.032574943037792084,   0.043709866330029656,
      0.030266440841197693,  0.020085104193458193,   0.014027334500460073,
      0.01038148746783943,   0.008218923031370543,   0.007116196177374381,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.0013056103336560845,
      0.01162454097707424,
      0.04436806160233174,
  };
  const Vector flux_down_direct{
      0.2477740448961252,
      0.2074261540756425,
      0.03507038703950099,
  };
  const Vector flux_up{
      0.05249330391904688,
      0.04411776975796322,
      0.004467845377564142,
  };

  //  flat_print(u, compute_u(dis, taus, phis) );

  compare("test_2a",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_2b() {
  const AscendingGrid tau_arr{0.2};
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad = 16;
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  Leg_coeffs_all[0, 2] = 0.1;

  const Numeric mu0  = 0.080442;
  const Numeric I0   = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.0015886564694485628,
      0.015886564694485628,
      0.1588656469448563,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.33661131842209324,    0.19268132080141906,    0.10714856672766362,
      0.06503499336634443,    0.04254455794333043,    0.02959262197605611,
      0.02218415395183482,    0.018681406011407303,   0.031487370516260646,
      0.006357619110001814,   0.002703779409774085,   0.0015075130597138105,
      0.0009548070390426309,  0.0006494307494245406,  0.0004699418649598758,
      0.0003732701141695816,  0.2903561681871601,     0.16531991009217634,
      0.09132250524381211,    0.055289150757729395,   0.03616660818781017,
      0.025193550703508764,   0.018928309335746966,   0.015965254585078442,
      0.20782038147977658,    0.05512759685827272,    0.024414862811075987,
      0.013791680705211725,   0.008788450695540698,   0.006000257633098966,
      0.0043548223623237825,  0.003467307898275545,   0.06382933346290583,
      0.02295618949269454,    0.010643885855926178,   0.006078765710688001,
      0.0039202609884895125,  0.002753603080304408,   0.0021080618214649742,
      0.0018046603905097541,  0.10270476001069608,    0.1309901748059769,
      0.089966746517404,      0.05922583442214636,    0.040541830432490954,
      0.028874502446800177,   0.021594092168851917,   0.01756686408035997,
      0.18752858955977977,    0.11271171920942843,    0.06535524291147622,
      0.04218954338143055,    0.030325217661239322,   0.02385147465267356,
      0.020290519496640305,   0.01856669601748584,    0.01705036627946693,
      0.003437457636274969,   0.0014783030735291205,  0.0008581937706278788,
      0.000590227986993075,   0.00045577192925450196, 0.00038520484715722663,
      0.0003519208924414337,  0.164945510589173,      0.0983738402072994,
      0.05654136589197782,    0.036331177272619454,   0.026040313816794076,
      0.02043858376133195,    0.017359821953601383,   0.01586965894354582,
      0.11398547531947797,    0.030151855382709196,   0.013497867774102173,
      0.007932298385459498,   0.00548036986299143,    0.004238340829024811,
      0.0035828981408452375,  0.003272770691962897,   0.04318186907393859,
      0.015728626085409005,   0.007451025233008617,   0.004442247267877832,
      0.003070131631050478,   0.0023598120058015513,  0.0019788464245124432,
      0.0017965731625769494,  0.06621062215425547,    0.07865936006234439,
      0.053728790778457935,   0.036465175981310494,   0.026771438069931607,
      0.021281919349832704,   0.018208408962040828,   0.016707650229480897,
      0.33755746859459856,    0.19531574023517645,    0.11051043632664981,
      0.0685151529687525,     0.04575533447335582,    0.03222642293272768,
      0.023994643367876375,   0.019503127211034914,   0.03139592421870847,
      0.006263668965834838,   0.002611625233308788,   0.0014207958078646628,
      0.0008781804940475851,  0.000587943881796368,   0.0004281645250341777,
      0.000354412734969808,   0.29114954453943126,    0.1675197551280427,
      0.09411384498890954,    0.05817050432691033,    0.03882114494178786,
      0.02736941157951896,    0.02042339357201749,    0.016643690596798006,
      0.20722743885629985,    0.054325761811823824,   0.02359559931184206,
      0.013010699306986593,   0.008094478175279063,   0.005441839975867799,
      0.003974850265878025,   0.0032956790861074815,  0.06395785689092262,
      0.023190773185846877,   0.010897237183472115,   0.006324710617817366,
      0.004140545510553325,   0.0029315666900326834,  0.002229409111614788,
      0.0018595253403169067,  0.10247840534974698,    0.1293286686419325,
      0.0872724471546151,     0.05621798480239955,    0.037676154630031274,
      0.02648601456253057,    0.01993856326238762,    0.01681254894355006,
      0.18752913743139682,    0.11271307707253261,    0.06535694558861121,
      0.042191295756833946,   0.03032682996337915,    0.023852795082879644,
      0.020291426141015152,   0.018567107140881004,   0.01705032775376365,
      0.003437412098161566,   0.001478257586294164,   0.000858150715063896,
      0.0005901898368994355,  0.0004557412673029068,  0.0003851839904222467,
      0.0003519114697148666,  0.16494597019669288,    0.09837497416116962,
      0.05654277965458773,    0.03633262815108371,    0.026041646813204283,
      0.02043967461380162,    0.01736057065392252,    0.015869998378966913,
      0.11398522562911513,    0.03015146675572384,    0.013497463397402982,
      0.00793191062994263,    0.005480024357695679,   0.004238062361773315,
      0.003582708445864565,   0.0032726849319434236,  0.043181943694095705,
      0.01572874705058536,    0.0074511535688382875,  0.004442371120280111,
      0.003070242253552428,   0.0023599012290411473,  0.0019789071931175565,
      0.0017966006128124293,  0.06621052717196782,    0.07865855506584268,
      0.053727461078722984,   0.03646368268772797,    0.026770011402543707,
      0.02128072830602159,    0.01820758247697878,    0.01670727331305196,
      0.3366111691029762,     0.19268124017355878,    0.10714852409430156,
      0.06503496965129454,    0.042544544921700136,   0.02959261557678915,
      0.022184151605804843,   0.018681405691369803,   0.03148735610210955,
      0.006357616213316735,   0.002703778207325022,   0.0015075124320631241,
      0.0009548066936107074,  0.0006494305711297878,  0.0004699417906619857,
      0.00037327009753235067, 0.2903560425782838,     0.16531984259643426,
      0.09132246976519418,    0.05528913107978183,    0.03616659739821572,
      0.025193545404849724,   0.018928307393675837,   0.015965254319958672,
      0.20782028779305145,    0.05512757208289493,    0.02441485209879663,
      0.0137916750409783,     0.00878844756086689,    0.006000256010717102,
      0.004354821685345224,   0.003467307746624117,   0.06382931278333097,
      0.022956182206516056,   0.010643882599760072,   0.006078764012714433,
      0.003920260083316753,   0.002753602642044771,   0.0021080616619279582,
      0.0018046603687131523,  0.10270472357312618,    0.1309901228903418,
      0.08996671095269368,    0.05922581241307888,    0.04054181737816201,
      0.028874495451041905,   0.021594089196844593,   0.017566863409630745,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.26230655535918806,    0.1533552920977222,    0.08709258374794351,
      0.05448252660752197,    0.03723778309072949,   0.027380663427918256,
      0.021690072349632893,   0.018829532701199605,  0.02424600155660583,
      0.004874045053576711,   0.0020679969733340612, 0.0011611686999711587,
      0.0007533560966136946,  0.0005372257836362113, 0.00041712641133689643,
      0.00035787997999743294, 0.22784923700809828,   0.13239697606089118,
      0.074629946137607,      0.04653068317486366,   0.031767261498921937,
      0.023360168659405933,   0.01851793024227841,   0.016087108193687596,
      0.1607546586001179,     0.042439218000007536,  0.018751498529530772,
      0.010666695543227958,   0.006960873857655757,  0.004979659953283407,
      0.00387384349147489,    0.0033271213659941427, 0.053537740807713924,
      0.019401068607127425,   0.009110809318557697,  0.005322008146476274,
      0.0035502812415338773,  0.0026012095860854204, 0.002073798537564769,
      0.001814336445022278,   0.0844010894040092,    0.10440928863323623,
      0.07117402646230994,    0.04709335542379997,   0.032940036536825805,
      0.02448093980948581,    0.019487264922382026,  0.016948631229308016,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.002808077375731864,
      0.02528046017357219,
      0.10462213765369247,
  };
  const Vector flux_down_direct{
      0.2477740448961252,
      0.2074261540756425,
      0.03507038703950099,
  };
  const Vector flux_up{
      0.12342740401744604,
      0.10555194313436794,
      0.012538091094116733,
  };

  //  flat_print(u, compute_u(dis, taus, phis) );

  compare("test_2b",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_2c() {
  const AscendingGrid tau_arr{5.0};
  const Vector omega_arr{0.5};
  const Index NQuad = 16;
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  Leg_coeffs_all[0, 2] = 0.1;

  const Numeric mu0  = 0.080442;
  const Numeric I0   = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.03971641173621407,
      0.3971641173621407,
      3.9716411736214075,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.10164946338584704,    0.05813826684725844,    0.033990246575187046,
      0.021667377399682563,   0.014782453918330406,   0.010686700496443003,
      0.0082988545030551,     0.007161102115123685,   0.1271694159708155,
      0.05043782346118207,    0.02395120394507888,    0.013828505590272452,
      0.008880787901050338,   0.006070308141454301,   0.00439234035943489,
      0.0034797528455993193,  0.004776842193759767,   0.0037632404349387458,
      0.002947729103884882,   0.002370850935864757,   0.001976082352003826,
      0.001716262754520492,   0.0015577121135343615,  0.0014786148137274555,
      0.005857215813725669,   0.014232920537682454,   0.02203636131852511,
      0.020047039003887573,   0.015896555557782886,   0.012202014467442904,
      0.009488709631977522,   0.00785659142319757,    4.443570299464519e-05,
      4.099727460033606e-05,  3.63437922410339e-05,   3.15962403990107e-05,
      2.784067016059044e-05,  2.5390802535083235e-05, 2.4002172310954986e-05,
      2.3357556578096176e-05, 4.635654147563655e-05,  5.096866402602973e-05,
      6.132901978615807e-05,  8.605001007872234e-05,  0.00015876464339441737,
      0.0002783511041039006,  0.0003801342527773907,  0.00042877335885554036,
      0.05543606969549277,    0.03311150823172821,    0.020548953891970954,
      0.014183142477372662,   0.010737431262437435,   0.00877603167643163,
      0.007668091333568076,   0.007124126538236207,   0.06754594611118121,
      0.026644156577436028,   0.012793084090912168,   0.007700915044814099,
      0.005386281910531443,   0.004199402651478455,   0.0035702236539504125,
      0.003272139041893697,   0.004074174704483437,   0.0033453925527384674,
      0.0027025016452505886,  0.002225961826738155,   0.0018953704783358696,
      0.0016781003506801744,  0.0015457995987835135,  0.0014785897140419094,
      0.004770064844724639,   0.009355339520783764,   0.013290431443461781,
      0.012251302135507187,   0.010382905987131253,   0.008911023935011317,
      0.007957963433762635,   0.007459799144884375,   4.4251127050575396e-05,
      4.0846794703075016e-05, 3.624063125384297e-05,  3.1540678738669e-05,
      2.7823038443166223e-05, 2.5397142113688036e-05, 2.401785026901557e-05,
      2.3368955140544883e-05, 4.615338467451166e-05,  5.072172897441908e-05,
      6.098068305823064e-05,  8.420625090207517e-05,  0.00014440625421393425,
      0.00024632358736312554, 0.00035017610291787355, 0.00041793365966434593,
      0.10194365018021548,    0.05896753630004414,    0.035079260075184866,
      0.022817410953545718,   0.015856348253116527,   0.011574022432655477,
      0.008911377719861944,   0.007439689605340223,   0.12679119848982334,
      0.049670763654570765,   0.023110399495680143,   0.013008504154879915,
      0.008144886837304341,   0.005475202064358973,   0.003986349477992779,
      0.003296147302850439,   0.004781427639034556,   0.0037780178592694124,
      0.0029700928962621467,  0.00239721730497484,    0.002002655322693741,
      0.0017393433978941718,  0.0015741381365449991,  0.0014862030989202491,
      0.0058502919538478,     0.014076713269630009,   0.02138072281789294,
      0.019008526936188118,   0.014740265907174812,   0.011159193555687326,
      0.008735323866985877,   0.007506557183407523,   4.44427436118632e-05,
      4.102985975957794e-05,  3.640804767239505e-05,  3.1683724964889405e-05,
      2.7935230050627385e-05, 2.5475744903939956e-05, 2.40636108171554e-05,
      2.3386140779070136e-05, 4.634913730754442e-05,  5.0926428688065847e-05,
      6.120835658729623e-05,  8.55962677643921e-05,   0.0001553774715173909,
      0.00026771168204024217, 0.0003649698407165555,  0.0004190439308540281,
      0.055436239974908166,   0.033111935590275046,   0.020549505393295014,
      0.014183721524704897,   0.010737970501089726,   0.00877647651479882,
      0.007668398063764513,   0.007124265920119147,   0.06754578672707555,
      0.026643784755579172,   0.012792669058945315,   0.007700507903661474,
      0.005385915523717914,   0.004199105885353079,   0.003570020968175197,
      0.003272047297054746,   0.0040741773497739815,  0.0033454001541210797,
      0.002702512955381989,   0.002225975088976829,   0.001895383811830344,
      0.0016781119158578732,  0.0015458078218591853,  0.0014785935100940905,
      0.004770061924775138,   0.00935526381749889,    0.013290107834363343,
      0.012250786518693558,   0.010382330310753498,   0.008910503909762254,
      0.007957587318102054,   0.007459624238703479,   4.425113066495516e-05,
      4.0846811079059514e-05, 3.624066344921556e-05,  3.1540722530610394e-05,
      2.7823085755568785e-05, 2.5397184602937033e-05, 2.401788099578704e-05,
      2.3368969434090563e-05, 4.6153381072180406e-05, 5.0721707969689876e-05,
      6.0980622870677944e-05, 8.420602483959482e-05,  0.00014440456696220965,
      0.0002463182810100551,  0.00035016853190363863, 0.00041792879793924325,
      0.10164941709895307,    0.05813824161329138,    0.03399023286177999,
      0.021667369628084646,   0.014782449604969317,   0.010686698364055074,
      0.008298853719237866,   0.007161102008536086,   0.12716935644186514,
      0.05043779985918917,    0.023951192997057304,   0.013828499667580986,
      0.008880784590428303,   0.006070306419251293,   0.0043923396387653,
      0.0034797526838639815,  0.004776841489946637,   0.003763240013398443,
      0.0029477288530693232,  0.0023708507843873835,  0.0019760822646520495,
      0.001716262710590822,   0.0015577120975173982,  0.0014786148118062336,
      0.005857214728305025,   0.014232915699134733,   0.022036352736424684,
      0.020047031467650463,   0.01589655033306226,    0.012202011437027864,
      0.00948870828948386,    0.007856591113870156,   4.443570280831001e-05,
      4.099727444171398e-05,  3.6343792121817115e-05, 3.1596240321588856e-05,
      2.7840670119330578e-05, 2.5390802520197847e-05, 2.4002172311280995e-05,
      2.3357556582352262e-05, 4.6356541274329904e-05, 5.096866378964828e-05,
      6.132901946797211e-05,  8.605000834834238e-05,  0.00015876462988240054,
      0.0002783510747349154,  0.00038013422660845354, 0.0004287733504469836,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.07861633308002298,    0.04583225754042854,    0.027541922126212166,
      0.018212840474036627,   0.013028483452513449,   0.009953252115584881,
      0.008136642044081295,   0.007212278620816139,   0.0972631048845011,
      0.03834917784636619,    0.01816189067795224,    0.01055965887455749,
      0.00694951373229366,    0.004986041722956439,   0.003879758924915907,
      0.003330033083465054,   0.004426655119143298,   0.003558011787036472,
      0.0028307077287652947,  0.002304999626831234,   0.0019423713220070979,
      0.001702953157898571,   0.0015558633894239182,  0.0014804998096886784,
      0.005311908965288484,   0.011755068596883793,   0.01749944603138272,
      0.01588947785704597,    0.01285058622794728,    0.010295748867280501,
      0.008534943029322898,   0.007570664848418358,   4.4345175622944325e-05,
      4.093018298381183e-05,  3.630827962647702e-05,  3.159033618256659e-05,
      2.7855500187887637e-05, 2.5415213227954715e-05, 2.4025374757872234e-05,
      2.337040369661366e-05,  4.625311157641096e-05,  5.083463503242523e-05,
      6.112467808814834e-05,  8.501466659638514e-05,  0.00015073844447972755,
      0.0002596768259225218,  0.0003613631275193335,  0.0004209205442051107,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.0244031639302229,
      0.036471653152916055,
      0.0007125750375068403,
  };
  const Vector flux_down_direct{
      0.1542445007091196,
      0.0018130187617600292,
      9.127007163577451e-23,
  };
  const Vector flux_up{
      0.042284510915472286,
      0.006042450878342856,
      8.662087193261241e-05,
  };

  //  flat_print(u, compute_u(dis, taus, phis) );

  compare("test_2c",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_2d() {
  const AscendingGrid tau_arr{5.0};
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad = 16;
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  Leg_coeffs_all[0, 2] = 0.1;

  const Numeric mu0  = 0.080442;
  const Numeric I0   = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.03971641173621407,
      0.3971641173621407,
      3.9716411736214075,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.2450325644400978,   0.15609141366048676,  0.10512735595877597,
      0.07806901778116687,  0.062189201082152236, 0.05222355264307346,
      0.046115533813128814, 0.0430625153442811,   0.28930898543757627,
      0.11372346335511033,  0.05397239609450618,  0.031247467198818563,
      0.02020860722445118,  0.013986459557336158, 0.010302512365347734,
      0.008317860554261092, 0.04334193662323984,  0.04045553701019035,
      0.037686208057937876, 0.035239284729033885, 0.033105457547226706,
      0.031339477575841386, 0.030038959226531457, 0.029293131182747945,
      0.04605608180348128,  0.06352018520803356,  0.07392792050301099,
      0.06296995961836363,  0.049523214110535105, 0.03878915226760632,
      0.03133371593649586,  0.027030170901574058, 0.01092718832504181,
      0.010385669713058014, 0.00944088279510192,  0.008205964927161644,
      0.007058609155108493, 0.006201672543202041, 0.005647101371413692,
      0.005356412343912226, 0.011188440620825694, 0.011724972379840019,
      0.012611834344004832, 0.01373817668380464,  0.01497736106154803,
      0.016085207358127945, 0.01682190251815004,  0.01716669644667654,
      0.15097676655558445,  0.10480888296587575,  0.07741410003643462,
      0.06256723748347204,  0.053783009656371374, 0.04824207365389028,
      0.044796545449044385, 0.04298268846074814,  0.16859059511028926,
      0.06559679335440234,  0.0314095069715226,   0.018859815335304515,
      0.01314602334229062,  0.010206680327247091, 0.008642599925771764,
      0.007899234215930974, 0.04156192480213171,  0.039327284691841775,
      0.036988113592292246, 0.03481313750694481,  0.03286393375166501,
      0.031224731343466528, 0.03000370738326891,  0.029293741098005723,
      0.04344604589039734,  0.053151200216952986, 0.055806212222905084,
      0.046903868536455964, 0.03818575179396271,  0.03203181015002923,
      0.028195128933098477, 0.026218588815050826, 0.010926347366923024,
      0.010384984606413373, 0.009440414285755457, 0.008205714270960262,
      0.007058531764179594, 0.006201704191295256, 0.0056471748534642425,
      0.005356465246999603, 0.011187514842492348, 0.011723847140536975,
      0.012610256232040195, 0.013732933337396397, 0.014945335024376841,
      0.01601638820036785,  0.01675815394115316,  0.0171436457590303,
      0.24562509201177685,  0.15776943854345268,  0.1073431090929947,
      0.08042005841267129,  0.064392442318417,    0.05404852430801875,
      0.047377297578711355, 0.0436368600225391,   0.28854898854049554,
      0.11218259505774718,  0.05228346339414346,  0.029600344178746497,
      0.01873042383930088,  0.012791090512094,    0.009487013729209248,
      0.007949059259608303, 0.04335355721000394,  0.04049609589864658,
      0.0377520106541219,   0.035320506098213196, 0.033189675586816805,
      0.03141390549356972,  0.030092467091833063, 0.02931797527809658,
      0.04603960856698137,  0.0631928088210728,   0.07258594095986472,
      0.060853735936612134, 0.047170661656445005, 0.036668962775698144,
      0.02980252538427027,  0.02631887193773682,  0.010927220748714828,
      0.010385819957619008, 0.009441179447771484, 0.008206369152853747,
      0.007059046264452766, 0.006202065288105068, 0.00564738547871971,
      0.005356544532593245, 0.01118840654795479,  0.011724778386680767,
      0.012611283325551982, 0.013736541908638931, 0.014969038069114392,
      0.016061451966976358, 0.016788963996631035, 0.017145763709394825,
      0.15097711000715405,  0.10480974804548984,  0.07741522232702029,
      0.06256842134436341,  0.05378411603193474,  0.04824298858719328,
      0.044797177306020584, 0.04298297581659386,  0.1685902752961292,
      0.06559604660439494,  0.031408673367212744, 0.018858997557396576,
      0.013145287413234594, 0.01020608423425049,  0.00864219280274698,
      0.00789904993245074,  0.04156193150555857,  0.03932730554569269,
      0.03698814685917513,  0.0348131783510612,   0.032863976002530965,
      0.031224768633419442, 0.03000373416820858,  0.02929375352595926,
      0.043446038955005054, 0.05315104163270563,  0.05580554996076478,
      0.046902817930623834, 0.03818458059975804,  0.03203075290476261,
      0.028194364524718504, 0.02621823339364036,  0.01092634738356355,
      0.010384984681915854, 0.009440414434390268, 0.00820571447329952,
      0.007058531982882248, 0.006201704387750064, 0.005647174995552171,
      0.005356465313100533, 0.011187514825910398, 0.011723847044054658,
      0.01261025595718247,  0.013732932522222456, 0.01494533087681694,
      0.01601637635115173,  0.016758137495540202, 0.01714363529895681,
      0.2450324702362617,   0.15609136195867038,  0.10512732769186466,
      0.0780690016919237,   0.06218919212542781,  0.052223548205580624,
      0.046115532178857596, 0.04306251512093989,  0.2893088649091153,
      0.11372341561347472,  0.0539723739536437,   0.031247455222744035,
      0.02020860053122974,  0.013986456076250476, 0.010302510909208307,
      0.008317860227789041, 0.0433419348403247,   0.040455535871803616,
      0.03768620734340113,  0.035239284282591564, 0.03310545728465898,
      0.03133947744249751,  0.030038959177909344, 0.029293131177149944,
      0.04605607919756217,  0.06352017492085388,  0.07392790271663352,
      0.06296994408106715,  0.04952320336091903,  0.038789146040047816,
      0.03133371318051564,  0.027030170267727922, 0.010927188324192752,
      0.010385669712335366, 0.009440882794559286, 0.008205964926809983,
      0.007058609154921879, 0.006201672543135551, 0.005647101371416182,
      0.005356412343932098, 0.01118844061990843,  0.011724972378763255,
      0.012611834342564405, 0.013738176678969783, 0.014977361031601709,
      0.016085207295244673, 0.016821902462631988, 0.017166696428856425,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.19815283738296866,   0.13086976106630885,  0.09182480570146143,
      0.07090603528839483,   0.05853705371259721,  0.05068917030697414,
      0.045771559513395746,  0.04316622398906973,  0.22875974730043772,
      0.08927481643269446,   0.04226861345228164,  0.02464175790267812,
      0.016307677225234067,  0.011797653051229092, 0.009268630544268403,
      0.008016324012912855,  0.042454836641679886, 0.039901553144603925,
      0.03735361561070649,   0.035046521552482265, 0.03300575543315467,
      0.03130071609674492,   0.03003471361824184,  0.029299648717727438,
      0.044746944589326564,  0.05825382846868889,  0.06453148812809018,
      0.05440772632916112,   0.043266198085136785, 0.03488030146899893,
      0.029381529147600487,  0.02644651066430933,  0.010926775953954459,
      0.010385364730292343,  0.009440722722160793, 0.008205940680768556,
      0.007058679764315528,  0.006201786578032249, 0.005647209157028761,
      0.0053564718508904395, 0.01118796921133962,  0.01172436124980323,
      0.012610907499002766,  0.013735146214748481, 0.01495926677540816,
      0.0160448574481572,    0.01678179154157783,  0.01714993661030331,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.05731046499360956,
      0.126892763353781,
      0.048266569757733475,
  };
  const Vector flux_down_direct{
      0.1542445007091196,
      0.0018130187617600292,
      9.127007163577451e-23,
  };
  const Vector flux_up{
      0.18475322872480376,
      0.10190441615968317,
      0.021466254396448035,
  };

  //  flat_print(u, compute_u(dis, taus, phis) );

  compare("test_2d",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

int main() try {
  test_2a();
  test_2b();
  test_2c();
  test_2d();

  return EXIT_SUCCESS;
} catch (const std::exception& e) {
  std::cerr << e.what() << std::endl;
  return EXIT_FAILURE;
}
