#include <disort-test.h>

#include <cstdlib>

void test_1a() {
  const AscendingGrid tau_arr{0.03125};
  const Vector omega_arr{0.2};
  const Index NQuad = 16;
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;

  const Numeric mu0  = 0.1;
  const Numeric I0   = Constant::pi / mu0;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.00024822757335133793,
      0.0024822757335133793,
      0.024822757335133797,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.35676766371700613,    0.11515624011306771,    0.053436658034579254,
      0.03185179757864009,    0.022221695720769187,   0.017334110957813523,
      0.01476084554346042,    0.01354717039281035,    0.006272239136434476,
      0.0012311127255863958,  0.0005279627210367777,  0.00030684148319048884,
      0.00021173940399960115, 0.00016426497063658953, 0.00013947924962721495,
      0.00012783853481044806, 0.33983822899325977,    0.10663176472801149,
      0.04922255452753117,    0.02928959970435685,    0.020418867271182927,
      0.015921821757741456,   0.013555542945410774,   0.012439818795015567,
      0.058677722035800815,   0.012045563995507722,   0.005198315509861912,
      0.003027140865022561,   0.002090691073059458,   0.001622623170530307,
      0.001378093434267673,   0.0012632115778897946,  0.10620793228511737,
      0.023495416805647706,   0.01024912181116478,    0.005988686167527986,
      0.0041421340616093144,  0.003217135536825991,   0.002733355491246957,
      0.0025059443432470683,  0.31231801817016613,    0.09673705215312936,
      0.04448821524830001,    0.02643842298044743,    0.018420709650953052,
      0.014359600713860271,   0.01222364651829485,    0.011216747490829296,
      0.35676766371700613,    0.11515624011306771,    0.053436658034579254,
      0.03185179757864009,    0.022221695720769187,   0.017334110957813523,
      0.01476084554346042,    0.01354717039281035,    0.006272239136434476,
      0.0012311127255863958,  0.0005279627210367777,  0.00030684148319048884,
      0.00021173940399960115, 0.00016426497063658953, 0.00013947924962721495,
      0.00012783853481044806, 0.33983822899325977,    0.10663176472801149,
      0.04922255452753117,    0.02928959970435685,    0.020418867271182927,
      0.015921821757741456,   0.013555542945410774,   0.012439818795015567,
      0.058677722035800815,   0.012045563995507722,   0.005198315509861912,
      0.003027140865022561,   0.002090691073059458,   0.001622623170530307,
      0.001378093434267673,   0.0012632115778897946,  0.10620793228511737,
      0.023495416805647706,   0.01024912181116478,    0.005988686167527986,
      0.0041421340616093144,  0.003217135536825991,   0.002733355491246957,
      0.0025059443432470683,  0.31231801817016613,    0.09673705215312936,
      0.04448821524830001,    0.02643842298044743,    0.018420709650953052,
      0.014359600713860271,   0.01222364651829485,    0.011216747490829296,
      0.35676766371700613,    0.11515624011306771,    0.053436658034579254,
      0.03185179757864009,    0.022221695720769187,   0.017334110957813523,
      0.01476084554346042,    0.01354717039281035,    0.006272239136434476,
      0.0012311127255863958,  0.0005279627210367777,  0.00030684148319048884,
      0.00021173940399960115, 0.00016426497063658953, 0.00013947924962721495,
      0.00012783853481044806, 0.33983822899325977,    0.10663176472801149,
      0.04922255452753117,    0.02928959970435685,    0.020418867271182927,
      0.015921821757741456,   0.013555542945410774,   0.012439818795015567,
      0.058677722035800815,   0.012045563995507722,   0.005198315509861912,
      0.003027140865022561,   0.002090691073059458,   0.001622623170530307,
      0.001378093434267673,   0.0012632115778897946,  0.10620793228511737,
      0.023495416805647706,   0.01024912181116478,    0.005988686167527986,
      0.0041421340616093144,  0.003217135536825991,   0.002733355491246957,
      0.0025059443432470683,  0.31231801817016613,    0.09673705215312936,
      0.04448821524830001,    0.02643842298044743,    0.018420709650953052,
      0.014359600713860271,   0.01222364651829485,    0.011216747490829296,
      0.35676766371700613,    0.11515624011306771,    0.053436658034579254,
      0.03185179757864009,    0.022221695720769187,   0.017334110957813523,
      0.01476084554346042,    0.01354717039281035,    0.006272239136434476,
      0.0012311127255863958,  0.0005279627210367777,  0.00030684148319048884,
      0.00021173940399960115, 0.00016426497063658953, 0.00013947924962721495,
      0.00012783853481044806, 0.33983822899325977,    0.10663176472801149,
      0.04922255452753117,    0.02928959970435685,    0.020418867271182927,
      0.015921821757741456,   0.013555542945410774,   0.012439818795015567,
      0.058677722035800815,   0.012045563995507722,   0.005198315509861912,
      0.003027140865022561,   0.002090691073059458,   0.001622623170530307,
      0.001378093434267673,   0.0012632115778897946,  0.10620793228511737,
      0.023495416805647706,   0.01024912181116478,    0.005988686167527986,
      0.0041421340616093144,  0.003217135536825991,   0.002733355491246957,
      0.0025059443432470683,  0.31231801817016613,    0.09673705215312936,
      0.04448821524830001,    0.02643842298044743,    0.018420709650953052,
      0.014359600713860271,   0.01222364651829485,    0.011216747490829296,
      0.35676766371700613,    0.11515624011306771,    0.053436658034579254,
      0.03185179757864009,    0.022221695720769187,   0.017334110957813523,
      0.01476084554346042,    0.01354717039281035,    0.006272239136434476,
      0.0012311127255863958,  0.0005279627210367777,  0.00030684148319048884,
      0.00021173940399960115, 0.00016426497063658953, 0.00013947924962721495,
      0.00012783853481044806, 0.33983822899325977,    0.10663176472801149,
      0.04922255452753117,    0.02928959970435685,    0.020418867271182927,
      0.015921821757741456,   0.013555542945410774,   0.012439818795015567,
      0.058677722035800815,   0.012045563995507722,   0.005198315509861912,
      0.003027140865022561,   0.002090691073059458,   0.001622623170530307,
      0.001378093434267673,   0.0012632115778897946,  0.10620793228511737,
      0.023495416805647706,   0.01024912181116478,    0.005988686167527986,
      0.0041421340616093144,  0.003217135536825991,   0.002733355491246957,
      0.0025059443432470683,  0.31231801817016613,    0.09673705215312936,
      0.04448821524830001,    0.02643842298044743,    0.018420709650953052,
      0.014359600713860271,   0.01222364651829485,    0.011216747490829296,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.35676766371700613,    0.11515624011306771,    0.053436658034579254,
      0.03185179757864009,    0.022221695720769187,   0.017334110957813523,
      0.01476084554346042,    0.01354717039281035,    0.006272239136434476,
      0.0012311127255863958,  0.0005279627210367777,  0.00030684148319048884,
      0.00021173940399960115, 0.00016426497063658953, 0.00013947924962721495,
      0.00012783853481044806, 0.33983822899325977,    0.10663176472801149,
      0.04922255452753117,    0.02928959970435685,    0.020418867271182927,
      0.015921821757741456,   0.013555542945410774,   0.012439818795015567,
      0.058677722035800815,   0.012045563995507722,   0.005198315509861912,
      0.003027140865022561,   0.002090691073059458,   0.001622623170530307,
      0.001378093434267673,   0.0012632115778897946,  0.10620793228511737,
      0.023495416805647706,   0.01024912181116478,    0.005988686167527986,
      0.0041421340616093144,  0.003217135536825991,   0.002733355491246957,
      0.0025059443432470683,  0.31231801817016613,    0.09673705215312936,
      0.04448821524830001,    0.02643842298044743,    0.018420709650953052,
      0.014359600713860271,   0.01222364651829485,    0.011216747490829296,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.0007868544295254413,
      0.007737663196157111,
      0.06592554544874399,
  };
  const Vector flux_down_direct{
      3.133804025142161,
      3.064569578946533,
      2.4510152157377942,
  };
  const Vector flux_up{
      0.07924240097129419,
      0.07297406585706889,
      0.015229317274357446,
  };

  compare("test_1a",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_1b() {
  const AscendingGrid tau_arr{0.03125};
  // Reduced from 1 because we have not implemented that special case
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad = 16;
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  const Numeric mu0    = 0.1;
  const Numeric I0     = Constant::pi / mu0;
  const Numeric phi0   = 0;

  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.00024822757335133793,
      0.0024822757335133793,
      0.024822757335133797,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      1.884161788161661,     0.6091299271450721,    0.2827196635959161,
      0.16853109491893087,   0.11758065586431807,   0.09172052389780146,
      0.07810511252459242,   0.0716833603651359,    0.032816185568706066,
      0.006441146729581961,  0.002762285820282553,  0.0016053858240530161,
      0.001107814472448176,  0.0008594296002826233, 0.000729751420104992,
      0.0006688475346877281, 1.7971985289441132,    0.5645866790974203,
      0.26066254191530297,   0.15511358828339106,   0.10813778039528911,
      0.08432245559215444,   0.07179097429565265,   0.06588220573511572,
      0.3074439638681437,    0.06311150907704334,   0.02723594780016246,
      0.01586032185185258,   0.010953906217096293,  0.008501522744522328,
      0.007220340125698106,  0.006618431284682184,  0.5642261506301139,
      0.12481364501654255,   0.054445643454698836,  0.03181319367199404,
      0.022003893594913733,  0.017090099012489236,  0.014520155031130702,
      0.013312098298769628,  1.6536929216128056,    0.5115564165380804,
      0.2352144066525593,    0.13977472896676363,   0.09738416596831596,
      0.07591346269413397,   0.06462109601098168,   0.05929787330746044,
      1.884161788161661,     0.6091299271450721,    0.2827196635959161,
      0.16853109491893087,   0.11758065586431807,   0.09172052389780146,
      0.07810511252459242,   0.0716833603651359,    0.032816185568706066,
      0.006441146729581961,  0.002762285820282553,  0.0016053858240530161,
      0.001107814472448176,  0.0008594296002826233, 0.000729751420104992,
      0.0006688475346877281, 1.7971985289441132,    0.5645866790974203,
      0.26066254191530297,   0.15511358828339106,   0.10813778039528911,
      0.08432245559215444,   0.07179097429565265,   0.06588220573511572,
      0.3074439638681437,    0.06311150907704334,   0.02723594780016246,
      0.01586032185185258,   0.010953906217096293,  0.008501522744522328,
      0.007220340125698106,  0.006618431284682184,  0.5642261506301139,
      0.12481364501654255,   0.054445643454698836,  0.03181319367199404,
      0.022003893594913733,  0.017090099012489236,  0.014520155031130702,
      0.013312098298769628,  1.6536929216128056,    0.5115564165380804,
      0.2352144066525593,    0.13977472896676363,   0.09738416596831596,
      0.07591346269413397,   0.06462109601098168,   0.05929787330746044,
      1.884161788161661,     0.6091299271450721,    0.2827196635959161,
      0.16853109491893087,   0.11758065586431807,   0.09172052389780146,
      0.07810511252459242,   0.0716833603651359,    0.032816185568706066,
      0.006441146729581961,  0.002762285820282553,  0.0016053858240530161,
      0.001107814472448176,  0.0008594296002826233, 0.000729751420104992,
      0.0006688475346877281, 1.7971985289441132,    0.5645866790974203,
      0.26066254191530297,   0.15511358828339106,   0.10813778039528911,
      0.08432245559215444,   0.07179097429565265,   0.06588220573511572,
      0.3074439638681437,    0.06311150907704334,   0.02723594780016246,
      0.01586032185185258,   0.010953906217096293,  0.008501522744522328,
      0.007220340125698106,  0.006618431284682184,  0.5642261506301139,
      0.12481364501654255,   0.054445643454698836,  0.03181319367199404,
      0.022003893594913733,  0.017090099012489236,  0.014520155031130702,
      0.013312098298769628,  1.6536929216128056,    0.5115564165380804,
      0.2352144066525593,    0.13977472896676363,   0.09738416596831596,
      0.07591346269413397,   0.06462109601098168,   0.05929787330746044,
      1.884161788161661,     0.6091299271450721,    0.2827196635959161,
      0.16853109491893087,   0.11758065586431807,   0.09172052389780146,
      0.07810511252459242,   0.0716833603651359,    0.032816185568706066,
      0.006441146729581961,  0.002762285820282553,  0.0016053858240530161,
      0.001107814472448176,  0.0008594296002826233, 0.000729751420104992,
      0.0006688475346877281, 1.7971985289441132,    0.5645866790974203,
      0.26066254191530297,   0.15511358828339106,   0.10813778039528911,
      0.08432245559215444,   0.07179097429565265,   0.06588220573511572,
      0.3074439638681437,    0.06311150907704334,   0.02723594780016246,
      0.01586032185185258,   0.010953906217096293,  0.008501522744522328,
      0.007220340125698106,  0.006618431284682184,  0.5642261506301139,
      0.12481364501654255,   0.054445643454698836,  0.03181319367199404,
      0.022003893594913733,  0.017090099012489236,  0.014520155031130702,
      0.013312098298769628,  1.6536929216128056,    0.5115564165380804,
      0.2352144066525593,    0.13977472896676363,   0.09738416596831596,
      0.07591346269413397,   0.06462109601098168,   0.05929787330746044,
      1.884161788161661,     0.6091299271450721,    0.2827196635959161,
      0.16853109491893087,   0.11758065586431807,   0.09172052389780146,
      0.07810511252459242,   0.0716833603651359,    0.032816185568706066,
      0.006441146729581961,  0.002762285820282553,  0.0016053858240530161,
      0.001107814472448176,  0.0008594296002826233, 0.000729751420104992,
      0.0006688475346877281, 1.7971985289441132,    0.5645866790974203,
      0.26066254191530297,   0.15511358828339106,   0.10813778039528911,
      0.08432245559215444,   0.07179097429565265,   0.06588220573511572,
      0.3074439638681437,    0.06311150907704334,   0.02723594780016246,
      0.01586032185185258,   0.010953906217096293,  0.008501522744522328,
      0.007220340125698106,  0.006618431284682184,  0.5642261506301139,
      0.12481364501654255,   0.054445643454698836,  0.03181319367199404,
      0.022003893594913733,  0.017090099012489236,  0.014520155031130702,
      0.013312098298769628,  1.6536929216128056,    0.5115564165380804,
      0.2352144066525593,    0.13977472896676363,   0.09738416596831596,
      0.07591346269413397,   0.06462109601098168,   0.05929787330746044,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      1.884161788161661,     0.6091299271450721,    0.2827196635959161,
      0.16853109491893087,   0.11758065586431807,   0.09172052389780146,
      0.07810511252459242,   0.0716833603651359,    0.032816185568706066,
      0.006441146729581961,  0.002762285820282553,  0.0016053858240530161,
      0.001107814472448176,  0.0008594296002826233, 0.000729751420104992,
      0.0006688475346877281, 1.7971985289441132,    0.5645866790974203,
      0.26066254191530297,   0.15511358828339106,   0.10813778039528911,
      0.08432245559215444,   0.07179097429565265,   0.06588220573511572,
      0.3074439638681437,    0.06311150907704334,   0.02723594780016246,
      0.01586032185185258,   0.010953906217096293,  0.008501522744522328,
      0.007220340125698106,  0.006618431284682184,  0.5642261506301139,
      0.12481364501654255,   0.054445643454698836,  0.03181319367199404,
      0.022003893594913733,  0.017090099012489236,  0.014520155031130702,
      0.013312098298769628,  1.6536929216128056,    0.5115564165380804,
      0.2352144066525593,    0.13977472896676363,   0.09738416596831596,
      0.07591346269413397,   0.06462109601098168,   0.05929787330746044,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.004116799850517918,
      0.040540582222464164,
      0.34855700606476986,
  };
  const Vector flux_down_direct{
      3.133804025142161,
      3.064569578946533,
      2.4510152157377942,
  };
  const Vector flux_up{
      0.41924950456263993,
      0.38643891412180953,
      0.08090163314088572,
  };

  compare("test_1b",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_1c() {
  const AscendingGrid tau_arr{0.03125};
  const Vector omega_arr{0.99};
  const Index NQuad{16};
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  const Numeric mu0    = 0.1;
  const Numeric I0     = Constant::pi / mu0;
  const Numeric phi0   = 0;

  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.00024822757335133793,
      0.0024822757335133793,
      0.024822757335133797,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      1.8640094766961572,    0.6026028448882168,    0.2796894400823778,
      0.16672461641481376,   0.11632027079412674,   0.09073732545443514,
      0.07726785720125255,   0.07091494048060534,   0.032469032154871486,
      0.006373007630823923,  0.002733064368516959,  0.001588402895143882,
      0.0010960952121946285, 0.0008503379342268214, 0.0007220315833586476,
      0.000661771983237094,  1.777945949034467,     0.5585300930160414,
      0.2578657661249659,    0.15344920127017342,   0.10697742018489043,
      0.08341763170917958,   0.0710206147090811,    0.06517524856221163,
      0.30418605367699936,   0.06244275201122432,   0.026947345049608266,
      0.015692259905573776,  0.010837834566268944,  0.008411437483938591,
      0.007143830758467203,  0.00654829996897369,   0.558149921343424,
      0.12346957108533839,   0.05385934136281561,   0.031470611544029525,
      0.02176694366071922,   0.016906063579859458,  0.014363794180721205,
      0.013168746469509041,  1.6359523418341224,    0.5060766747145572,
      0.2326953640897969,    0.13827790668156764,   0.09634132758419965,
      0.0751005554275601,    0.063929116631552,     0.05866289868632781,
      1.8640094766961572,    0.6026028448882168,    0.2796894400823778,
      0.16672461641481376,   0.11632027079412674,   0.09073732545443514,
      0.07726785720125255,   0.07091494048060534,   0.032469032154871486,
      0.006373007630823923,  0.002733064368516959,  0.001588402895143882,
      0.0010960952121946285, 0.0008503379342268214, 0.0007220315833586476,
      0.000661771983237094,  1.777945949034467,     0.5585300930160414,
      0.2578657661249659,    0.15344920127017342,   0.10697742018489043,
      0.08341763170917958,   0.0710206147090811,    0.06517524856221163,
      0.30418605367699936,   0.06244275201122432,   0.026947345049608266,
      0.015692259905573776,  0.010837834566268944,  0.008411437483938591,
      0.007143830758467203,  0.00654829996897369,   0.558149921343424,
      0.12346957108533839,   0.05385934136281561,   0.031470611544029525,
      0.02176694366071922,   0.016906063579859458,  0.014363794180721205,
      0.013168746469509041,  1.6359523418341224,    0.5060766747145572,
      0.2326953640897969,    0.13827790668156764,   0.09634132758419965,
      0.0751005554275601,    0.063929116631552,     0.05866289868632781,
      1.8640094766961572,    0.6026028448882168,    0.2796894400823778,
      0.16672461641481376,   0.11632027079412674,   0.09073732545443514,
      0.07726785720125255,   0.07091494048060534,   0.032469032154871486,
      0.006373007630823923,  0.002733064368516959,  0.001588402895143882,
      0.0010960952121946285, 0.0008503379342268214, 0.0007220315833586476,
      0.000661771983237094,  1.777945949034467,     0.5585300930160414,
      0.2578657661249659,    0.15344920127017342,   0.10697742018489043,
      0.08341763170917958,   0.0710206147090811,    0.06517524856221163,
      0.30418605367699936,   0.06244275201122432,   0.026947345049608266,
      0.015692259905573776,  0.010837834566268944,  0.008411437483938591,
      0.007143830758467203,  0.00654829996897369,   0.558149921343424,
      0.12346957108533839,   0.05385934136281561,   0.031470611544029525,
      0.02176694366071922,   0.016906063579859458,  0.014363794180721205,
      0.013168746469509041,  1.6359523418341224,    0.5060766747145572,
      0.2326953640897969,    0.13827790668156764,   0.09634132758419965,
      0.0751005554275601,    0.063929116631552,     0.05866289868632781,
      1.8640094766961572,    0.6026028448882168,    0.2796894400823778,
      0.16672461641481376,   0.11632027079412674,   0.09073732545443514,
      0.07726785720125255,   0.07091494048060534,   0.032469032154871486,
      0.006373007630823923,  0.002733064368516959,  0.001588402895143882,
      0.0010960952121946285, 0.0008503379342268214, 0.0007220315833586476,
      0.000661771983237094,  1.777945949034467,     0.5585300930160414,
      0.2578657661249659,    0.15344920127017342,   0.10697742018489043,
      0.08341763170917958,   0.0710206147090811,    0.06517524856221163,
      0.30418605367699936,   0.06244275201122432,   0.026947345049608266,
      0.015692259905573776,  0.010837834566268944,  0.008411437483938591,
      0.007143830758467203,  0.00654829996897369,   0.558149921343424,
      0.12346957108533839,   0.05385934136281561,   0.031470611544029525,
      0.02176694366071922,   0.016906063579859458,  0.014363794180721205,
      0.013168746469509041,  1.6359523418341224,    0.5060766747145572,
      0.2326953640897969,    0.13827790668156764,   0.09634132758419965,
      0.0751005554275601,    0.063929116631552,     0.05866289868632781,
      1.8640094766961572,    0.6026028448882168,    0.2796894400823778,
      0.16672461641481376,   0.11632027079412674,   0.09073732545443514,
      0.07726785720125255,   0.07091494048060534,   0.032469032154871486,
      0.006373007630823923,  0.002733064368516959,  0.001588402895143882,
      0.0010960952121946285, 0.0008503379342268214, 0.0007220315833586476,
      0.000661771983237094,  1.777945949034467,     0.5585300930160414,
      0.2578657661249659,    0.15344920127017342,   0.10697742018489043,
      0.08341763170917958,   0.0710206147090811,    0.06517524856221163,
      0.30418605367699936,   0.06244275201122432,   0.026947345049608266,
      0.015692259905573776,  0.010837834566268944,  0.008411437483938591,
      0.007143830758467203,  0.00654829996897369,   0.558149921343424,
      0.12346957108533839,   0.05385934136281561,   0.031470611544029525,
      0.02176694366071922,   0.016906063579859458,  0.014363794180721205,
      0.013168746469509041,  1.6359523418341224,    0.5060766747145572,
      0.2326953640897969,    0.13827790668156764,   0.09634132758419965,
      0.0751005554275601,    0.063929116631552,     0.05866289868632781,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      1.8640094766961572,    0.6026028448882168,    0.2796894400823778,
      0.16672461641481376,   0.11632027079412674,   0.09073732545443514,
      0.07726785720125255,   0.07091494048060534,   0.032469032154871486,
      0.006373007630823923,  0.002733064368516959,  0.001588402895143882,
      0.0010960952121946285, 0.0008503379342268214, 0.0007220315833586476,
      0.000661771983237094,  1.777945949034467,     0.5585300930160414,
      0.2578657661249659,    0.15344920127017342,   0.10697742018489043,
      0.08341763170917958,   0.0710206147090811,    0.06517524856221163,
      0.30418605367699936,   0.06244275201122432,   0.026947345049608266,
      0.015692259905573776,  0.010837834566268944,  0.008411437483938591,
      0.007143830758467203,  0.00654829996897369,   0.558149921343424,
      0.12346957108533839,   0.05385934136281561,   0.031470611544029525,
      0.02176694366071922,   0.016906063579859458,  0.014363794180721205,
      0.013168746469509041,  1.6359523418341224,    0.5060766747145572,
      0.2326953640897969,    0.13827790668156764,   0.09634132758419965,
      0.0751005554275601,    0.063929116631552,     0.05866289868632781,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.0040732493718682455,
      0.04011099801236401,
      0.34482410270913155,
  };
  const Vector flux_down_direct{
      3.133804025142161,
      3.064569578946533,
      2.4510152157377942,
  };
  const Vector flux_up{
      0.4147559591523601,
      0.3822926461087521,
      0.08003043683361628,
  };

  // flat_print(u, compute_u(dis, taus, phis));

  compare("test_1c",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_1d() {
  const AscendingGrid tau_arr{32};
  const Vector omega_arr{0.2};
  const Index NQuad{16};
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  const Numeric mu0    = 0.1;
  const Numeric I0     = Constant::pi / mu0;
  const Numeric phi0   = 0;

  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.25418503511177004,
      2.5418503511177004,
      25.418503511177008,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.04100206328312362,    0.026259156391650777,   0.01701968976439121,
      0.012046256751605363,   0.009270929939049833,   0.007667317705653775,
      0.006755193760136256,   0.00630607750738469,    0.058288154572447806,
      0.11053671950323012,    0.1037953161240487,     0.0797922002523191,
      0.06237985110327942,    0.05155415526519188,    0.045256653832926534,
      0.04213554847901238,    0.00020437362831238478, 0.00018595488026950117,
      0.00016198460316320382, 0.00013947527947084424, 0.00012146843015615359,
      0.00010845409509993784, 9.998019139418776e-05,  9.548259805009713e-05,
      0.0002147789257574467,  0.00024027506354579878, 0.00031073526822435063,
      0.0007736366223601242,  0.0020671675191932786,  0.0035804540398637996,
      0.004718032864223061,   0.005334334625284373,   5.327628685568291e-15,
      4.9229831723508146e-15, 4.372726845861904e-15,  3.8323446644714926e-15,
      3.3839301616057147e-15, 3.0510631096451133e-15, 2.8304084260703088e-15,
      2.7120465233010202e-15, 5.549039317890542e-15,  6.068719161173638e-15,
      7.183965456399806e-15,  9.354966518998689e-15,  1.385807046088222e-14,
      2.5719620831327467e-14, 1.078816344093889e-13,  5.590736739662429e-13,
      0.04100206328312362,    0.026259156391650777,   0.01701968976439121,
      0.012046256751605363,   0.009270929939049833,   0.007667317705653775,
      0.006755193760136256,   0.00630607750738469,    0.058288154572447806,
      0.11053671950323012,    0.1037953161240487,     0.0797922002523191,
      0.06237985110327942,    0.05155415526519188,    0.045256653832926534,
      0.04213554847901238,    0.00020437362831238478, 0.00018595488026950117,
      0.00016198460316320382, 0.00013947527947084424, 0.00012146843015615359,
      0.00010845409509993784, 9.998019139418776e-05,  9.548259805009713e-05,
      0.0002147789257574467,  0.00024027506354579878, 0.00031073526822435063,
      0.0007736366223601242,  0.0020671675191932786,  0.0035804540398637996,
      0.004718032864223061,   0.005334334625284373,   5.327628685568291e-15,
      4.9229831723508146e-15, 4.372726845861904e-15,  3.8323446644714926e-15,
      3.3839301616057147e-15, 3.0510631096451133e-15, 2.8304084260703088e-15,
      2.7120465233010202e-15, 5.549039317890542e-15,  6.068719161173638e-15,
      7.183965456399806e-15,  9.354966518998689e-15,  1.385807046088222e-14,
      2.5719620831327467e-14, 1.078816344093889e-13,  5.590736739662429e-13,
      0.04100206328312362,    0.026259156391650777,   0.01701968976439121,
      0.012046256751605363,   0.009270929939049833,   0.007667317705653775,
      0.006755193760136256,   0.00630607750738469,    0.058288154572447806,
      0.11053671950323012,    0.1037953161240487,     0.0797922002523191,
      0.06237985110327942,    0.05155415526519188,    0.045256653832926534,
      0.04213554847901238,    0.00020437362831238478, 0.00018595488026950117,
      0.00016198460316320382, 0.00013947527947084424, 0.00012146843015615359,
      0.00010845409509993784, 9.998019139418776e-05,  9.548259805009713e-05,
      0.0002147789257574467,  0.00024027506354579878, 0.00031073526822435063,
      0.0007736366223601242,  0.0020671675191932786,  0.0035804540398637996,
      0.004718032864223061,   0.005334334625284373,   5.327628685568291e-15,
      4.9229831723508146e-15, 4.372726845861904e-15,  3.8323446644714926e-15,
      3.3839301616057147e-15, 3.0510631096451133e-15, 2.8304084260703088e-15,
      2.7120465233010202e-15, 5.549039317890542e-15,  6.068719161173638e-15,
      7.183965456399806e-15,  9.354966518998689e-15,  1.385807046088222e-14,
      2.5719620831327467e-14, 1.078816344093889e-13,  5.590736739662429e-13,
      0.04100206328312362,    0.026259156391650777,   0.01701968976439121,
      0.012046256751605363,   0.009270929939049833,   0.007667317705653775,
      0.006755193760136256,   0.00630607750738469,    0.058288154572447806,
      0.11053671950323012,    0.1037953161240487,     0.0797922002523191,
      0.06237985110327942,    0.05155415526519188,    0.045256653832926534,
      0.04213554847901238,    0.00020437362831238478, 0.00018595488026950117,
      0.00016198460316320382, 0.00013947527947084424, 0.00012146843015615359,
      0.00010845409509993784, 9.998019139418776e-05,  9.548259805009713e-05,
      0.0002147789257574467,  0.00024027506354579878, 0.00031073526822435063,
      0.0007736366223601242,  0.0020671675191932786,  0.0035804540398637996,
      0.004718032864223061,   0.005334334625284373,   5.327628685568291e-15,
      4.9229831723508146e-15, 4.372726845861904e-15,  3.8323446644714926e-15,
      3.3839301616057147e-15, 3.0510631096451133e-15, 2.8304084260703088e-15,
      2.7120465233010202e-15, 5.549039317890542e-15,  6.068719161173638e-15,
      7.183965456399806e-15,  9.354966518998689e-15,  1.385807046088222e-14,
      2.5719620831327467e-14, 1.078816344093889e-13,  5.590736739662429e-13,
      0.04100206328312362,    0.026259156391650777,   0.01701968976439121,
      0.012046256751605363,   0.009270929939049833,   0.007667317705653775,
      0.006755193760136256,   0.00630607750738469,    0.058288154572447806,
      0.11053671950323012,    0.1037953161240487,     0.0797922002523191,
      0.06237985110327942,    0.05155415526519188,    0.045256653832926534,
      0.04213554847901238,    0.00020437362831238478, 0.00018595488026950117,
      0.00016198460316320382, 0.00013947527947084424, 0.00012146843015615359,
      0.00010845409509993784, 9.998019139418776e-05,  9.548259805009713e-05,
      0.0002147789257574467,  0.00024027506354579878, 0.00031073526822435063,
      0.0007736366223601242,  0.0020671675191932786,  0.0035804540398637996,
      0.004718032864223061,   0.005334334625284373,   5.327628685568291e-15,
      4.9229831723508146e-15, 4.372726845861904e-15,  3.8323446644714926e-15,
      3.3839301616057147e-15, 3.0510631096451133e-15, 2.8304084260703088e-15,
      2.7120465233010202e-15, 5.549039317890542e-15,  6.068719161173638e-15,
      7.183965456399806e-15,  9.354966518998689e-15,  1.385807046088222e-14,
      2.5719620831327467e-14, 1.078816344093889e-13,  5.590736739662429e-13,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.04100206328312362,    0.026259156391650777,   0.01701968976439121,
      0.012046256751605363,   0.009270929939049833,   0.007667317705653775,
      0.006755193760136256,   0.00630607750738469,    0.058288154572447806,
      0.11053671950323012,    0.1037953161240487,     0.0797922002523191,
      0.06237985110327942,    0.05155415526519188,    0.045256653832926534,
      0.04213554847901238,    0.00020437362831238478, 0.00018595488026950117,
      0.00016198460316320382, 0.00013947527947084424, 0.00012146843015615359,
      0.00010845409509993784, 9.998019139418776e-05,  9.548259805009713e-05,
      0.0002147789257574467,  0.00024027506354579878, 0.00031073526822435063,
      0.0007736366223601242,  0.0020671675191932786,  0.0035804540398637996,
      0.004718032864223061,   0.005334334625284373,   5.327628685568291e-15,
      4.9229831723508146e-15, 4.372726845861904e-15,  3.8323446644714926e-15,
      3.3839301616057147e-15, 3.0510631096451133e-15, 2.8304084260703088e-15,
      2.7120465233010202e-15, 5.549039317890542e-15,  6.068719161173638e-15,
      7.183965456399806e-15,  9.354966518998689e-15,  1.385807046088222e-14,
      2.5719620831327467e-14, 1.078816344093889e-13,  5.590736739662429e-13,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      0.19195510861249748,
      0.009160006699860893,
      2.7714782987777976e-13,
  };
  const Vector flux_down_direct{
      0.2473080718025409,
      2.871005731865268e-11,
      1.2764145357290263e-110,
  };
  const Vector flux_up{
      0.02992670575602179,
      0.00037318837905454333,
      1.0385254943329445e-14,
  };

  // flat_print(u, compute_u(dis, taus, phis, false));

  compare("test_1d",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_1e() {
  const AscendingGrid tau_arr{32};
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad{16};
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  const Numeric mu0    = 0.1;
  const Numeric I0     = Constant::pi / mu0;
  const Numeric phi0   = 0;

  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.25418503511177004,
      2.5418503511177004,
      25.418503511177008,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.7955938923764598,  0.7051028384975992,  0.6428361842929261,
      0.6058970273439587,  0.5832215356077042,  0.5688607887412133,
      0.5600111116693228,  0.5553948822461586,  0.8937483049386075,
      1.1192820283615519,  0.9272956216682785,  0.6872095940051814,
      0.5292259721342323,  0.43418795859518194, 0.3797137511906708,
      0.3529046357817669,  0.4881996477241071,  0.4867715388751602,
      0.4844473341616477,  0.48156189678105604, 0.47850292693508173,
      0.47567144092258806, 0.47343723456482056, 0.47209220634728666,
      0.4889027848614072,  0.4903807489358687,  0.493031922005243,
      0.49769339236078075, 0.5021826236836797,  0.5018936909177529,
      0.49797383817153734, 0.49423257668316556, 0.11746188692358234,
      0.11614034707852157, 0.11395047532610764, 0.11118743555774782,
      0.10822418422128374, 0.1054608728985393,  0.10327205513253153,
      0.10195311045150306, 0.11810334264032653, 0.1194248859915137,
      0.12161477242678492, 0.12437783225780431, 0.1273409904309465,
      0.13010409653334942, 0.13229405061348412, 0.13361564740605483,
      0.7955938923764598,  0.7051028384975992,  0.6428361842929261,
      0.6058970273439587,  0.5832215356077042,  0.5688607887412133,
      0.5600111116693228,  0.5553948822461586,  0.8937483049386075,
      1.1192820283615519,  0.9272956216682785,  0.6872095940051814,
      0.5292259721342323,  0.43418795859518194, 0.3797137511906708,
      0.3529046357817669,  0.4881996477241071,  0.4867715388751602,
      0.4844473341616477,  0.48156189678105604, 0.47850292693508173,
      0.47567144092258806, 0.47343723456482056, 0.47209220634728666,
      0.4889027848614072,  0.4903807489358687,  0.493031922005243,
      0.49769339236078075, 0.5021826236836797,  0.5018936909177529,
      0.49797383817153734, 0.49423257668316556, 0.11746188692358234,
      0.11614034707852157, 0.11395047532610764, 0.11118743555774782,
      0.10822418422128374, 0.1054608728985393,  0.10327205513253153,
      0.10195311045150306, 0.11810334264032653, 0.1194248859915137,
      0.12161477242678492, 0.12437783225780431, 0.1273409904309465,
      0.13010409653334942, 0.13229405061348412, 0.13361564740605483,
      0.7955938923764598,  0.7051028384975992,  0.6428361842929261,
      0.6058970273439587,  0.5832215356077042,  0.5688607887412133,
      0.5600111116693228,  0.5553948822461586,  0.8937483049386075,
      1.1192820283615519,  0.9272956216682785,  0.6872095940051814,
      0.5292259721342323,  0.43418795859518194, 0.3797137511906708,
      0.3529046357817669,  0.4881996477241071,  0.4867715388751602,
      0.4844473341616477,  0.48156189678105604, 0.47850292693508173,
      0.47567144092258806, 0.47343723456482056, 0.47209220634728666,
      0.4889027848614072,  0.4903807489358687,  0.493031922005243,
      0.49769339236078075, 0.5021826236836797,  0.5018936909177529,
      0.49797383817153734, 0.49423257668316556, 0.11746188692358234,
      0.11614034707852157, 0.11395047532610764, 0.11118743555774782,
      0.10822418422128374, 0.1054608728985393,  0.10327205513253153,
      0.10195311045150306, 0.11810334264032653, 0.1194248859915137,
      0.12161477242678492, 0.12437783225780431, 0.1273409904309465,
      0.13010409653334942, 0.13229405061348412, 0.13361564740605483,
      0.7955938923764598,  0.7051028384975992,  0.6428361842929261,
      0.6058970273439587,  0.5832215356077042,  0.5688607887412133,
      0.5600111116693228,  0.5553948822461586,  0.8937483049386075,
      1.1192820283615519,  0.9272956216682785,  0.6872095940051814,
      0.5292259721342323,  0.43418795859518194, 0.3797137511906708,
      0.3529046357817669,  0.4881996477241071,  0.4867715388751602,
      0.4844473341616477,  0.48156189678105604, 0.47850292693508173,
      0.47567144092258806, 0.47343723456482056, 0.47209220634728666,
      0.4889027848614072,  0.4903807489358687,  0.493031922005243,
      0.49769339236078075, 0.5021826236836797,  0.5018936909177529,
      0.49797383817153734, 0.49423257668316556, 0.11746188692358234,
      0.11614034707852157, 0.11395047532610764, 0.11118743555774782,
      0.10822418422128374, 0.1054608728985393,  0.10327205513253153,
      0.10195311045150306, 0.11810334264032653, 0.1194248859915137,
      0.12161477242678492, 0.12437783225780431, 0.1273409904309465,
      0.13010409653334942, 0.13229405061348412, 0.13361564740605483,
      0.7955938923764598,  0.7051028384975992,  0.6428361842929261,
      0.6058970273439587,  0.5832215356077042,  0.5688607887412133,
      0.5600111116693228,  0.5553948822461586,  0.8937483049386075,
      1.1192820283615519,  0.9272956216682785,  0.6872095940051814,
      0.5292259721342323,  0.43418795859518194, 0.3797137511906708,
      0.3529046357817669,  0.4881996477241071,  0.4867715388751602,
      0.4844473341616477,  0.48156189678105604, 0.47850292693508173,
      0.47567144092258806, 0.47343723456482056, 0.47209220634728666,
      0.4889027848614072,  0.4903807489358687,  0.493031922005243,
      0.49769339236078075, 0.5021826236836797,  0.5018936909177529,
      0.49797383817153734, 0.49423257668316556, 0.11746188692358234,
      0.11614034707852157, 0.11395047532610764, 0.11118743555774782,
      0.10822418422128374, 0.1054608728985393,  0.10327205513253153,
      0.10195311045150306, 0.11810334264032653, 0.1194248859915137,
      0.12161477242678492, 0.12437783225780431, 0.1273409904309465,
      0.13010409653334942, 0.13229405061348412, 0.13361564740605483,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.7955938923764598,  0.7051028384975992,  0.6428361842929261,
      0.6058970273439587,  0.5832215356077042,  0.5688607887412133,
      0.5600111116693228,  0.5553948822461586,  0.8937483049386075,
      1.1192820283615519,  0.9272956216682785,  0.6872095940051814,
      0.5292259721342323,  0.43418795859518194, 0.3797137511906708,
      0.3529046357817669,  0.4881996477241071,  0.4867715388751602,
      0.4844473341616477,  0.48156189678105604, 0.47850292693508173,
      0.47567144092258806, 0.47343723456482056, 0.47209220634728666,
      0.4889027848614072,  0.4903807489358687,  0.493031922005243,
      0.49769339236078075, 0.5021826236836797,  0.5018936909177529,
      0.49797383817153734, 0.49423257668316556, 0.11746188692358234,
      0.11614034707852157, 0.11395047532610764, 0.11118743555774782,
      0.10822418422128374, 0.1054608728985393,  0.10327205513253153,
      0.10195311045150306, 0.11810334264032653, 0.1194248859915137,
      0.12161477242678492, 0.12437783225780431, 0.1273409904309465,
      0.13010409653334942, 0.13229405061348412, 0.13361564740605483,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      1.6531501469284766,
      1.5671665684857083,
      0.40385718355125283,
  };
  const Vector flux_down_direct{
      0.2473080718025409,
      2.871005731865268e-11,
      1.2764145357290263e-110,
  };
  const Vector flux_up{
      1.8326929930608915,
      1.4994166341744244,
      0.3361942504917655,
  };

  // flat_print(u, compute_u(dis, taus, phis));

  compare("test_1e",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

void test_1f() {
  const AscendingGrid tau_arr{32};
  const Vector omega_arr{0.99};
  const Index NQuad{16};
  Matrix Leg_coeffs_all(1, 17, 0);
  Leg_coeffs_all[0, 0] = 1;
  const Numeric mu0    = 0.1;
  const Numeric I0     = Constant::pi / mu0;
  const Numeric phi0   = 0;

  const Index NLeg     = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{0};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.25418503511177004,
      2.5418503511177004,
      25.418503511177008,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.7164691533282324,   0.6215727987250954,   0.551748253895844,
      0.5056879938804985,   0.47390665916197366,  0.4516671461847766,
      0.4369654111570505,   0.4289758612980197,   0.8163837746121,
      1.0494274142025273,   0.8774002131772574,   0.6520604392812852,
      0.5027450417823759,   0.4126990887205985,   0.36102794729769455,
      0.33558459764985904,  0.3006052015612011,   0.2963378177670009,
      0.2895597036329729,   0.2814717576945127,   0.27330976496111,
      0.26612760141318476,  0.2607040393903882,   0.2575386392907273,
      0.3027295672685804,   0.3072279649306579,   0.3151745442046686,
      0.32712907480267317,  0.3402733222739759,   0.3484930157834256,
      0.3513098988775981,   0.35155028527949994,  0.005317800363858766,
      0.005230780933428381, 0.005090938974588383, 0.00492165563897284,
      0.004748128812814748, 0.004592997527796641, 0.004474200837102728,
      0.00440418649327166,  0.005360789441178993, 0.005450969213068261,
      0.005605440083747342, 0.005810044402332431, 0.00604276476240741,
      0.006273595697708566, 0.006467044059943434, 0.006588664325568582,
      0.7164691533282324,   0.6215727987250954,   0.551748253895844,
      0.5056879938804985,   0.47390665916197366,  0.4516671461847766,
      0.4369654111570505,   0.4289758612980197,   0.8163837746121,
      1.0494274142025273,   0.8774002131772574,   0.6520604392812852,
      0.5027450417823759,   0.4126990887205985,   0.36102794729769455,
      0.33558459764985904,  0.3006052015612011,   0.2963378177670009,
      0.2895597036329729,   0.2814717576945127,   0.27330976496111,
      0.26612760141318476,  0.2607040393903882,   0.2575386392907273,
      0.3027295672685804,   0.3072279649306579,   0.3151745442046686,
      0.32712907480267317,  0.3402733222739759,   0.3484930157834256,
      0.3513098988775981,   0.35155028527949994,  0.005317800363858766,
      0.005230780933428381, 0.005090938974588383, 0.00492165563897284,
      0.004748128812814748, 0.004592997527796641, 0.004474200837102728,
      0.00440418649327166,  0.005360789441178993, 0.005450969213068261,
      0.005605440083747342, 0.005810044402332431, 0.00604276476240741,
      0.006273595697708566, 0.006467044059943434, 0.006588664325568582,
      0.7164691533282324,   0.6215727987250954,   0.551748253895844,
      0.5056879938804985,   0.47390665916197366,  0.4516671461847766,
      0.4369654111570505,   0.4289758612980197,   0.8163837746121,
      1.0494274142025273,   0.8774002131772574,   0.6520604392812852,
      0.5027450417823759,   0.4126990887205985,   0.36102794729769455,
      0.33558459764985904,  0.3006052015612011,   0.2963378177670009,
      0.2895597036329729,   0.2814717576945127,   0.27330976496111,
      0.26612760141318476,  0.2607040393903882,   0.2575386392907273,
      0.3027295672685804,   0.3072279649306579,   0.3151745442046686,
      0.32712907480267317,  0.3402733222739759,   0.3484930157834256,
      0.3513098988775981,   0.35155028527949994,  0.005317800363858766,
      0.005230780933428381, 0.005090938974588383, 0.00492165563897284,
      0.004748128812814748, 0.004592997527796641, 0.004474200837102728,
      0.00440418649327166,  0.005360789441178993, 0.005450969213068261,
      0.005605440083747342, 0.005810044402332431, 0.00604276476240741,
      0.006273595697708566, 0.006467044059943434, 0.006588664325568582,
      0.7164691533282324,   0.6215727987250954,   0.551748253895844,
      0.5056879938804985,   0.47390665916197366,  0.4516671461847766,
      0.4369654111570505,   0.4289758612980197,   0.8163837746121,
      1.0494274142025273,   0.8774002131772574,   0.6520604392812852,
      0.5027450417823759,   0.4126990887205985,   0.36102794729769455,
      0.33558459764985904,  0.3006052015612011,   0.2963378177670009,
      0.2895597036329729,   0.2814717576945127,   0.27330976496111,
      0.26612760141318476,  0.2607040393903882,   0.2575386392907273,
      0.3027295672685804,   0.3072279649306579,   0.3151745442046686,
      0.32712907480267317,  0.3402733222739759,   0.3484930157834256,
      0.3513098988775981,   0.35155028527949994,  0.005317800363858766,
      0.005230780933428381, 0.005090938974588383, 0.00492165563897284,
      0.004748128812814748, 0.004592997527796641, 0.004474200837102728,
      0.00440418649327166,  0.005360789441178993, 0.005450969213068261,
      0.005605440083747342, 0.005810044402332431, 0.00604276476240741,
      0.006273595697708566, 0.006467044059943434, 0.006588664325568582,
      0.7164691533282324,   0.6215727987250954,   0.551748253895844,
      0.5056879938804985,   0.47390665916197366,  0.4516671461847766,
      0.4369654111570505,   0.4289758612980197,   0.8163837746121,
      1.0494274142025273,   0.8774002131772574,   0.6520604392812852,
      0.5027450417823759,   0.4126990887205985,   0.36102794729769455,
      0.33558459764985904,  0.3006052015612011,   0.2963378177670009,
      0.2895597036329729,   0.2814717576945127,   0.27330976496111,
      0.26612760141318476,  0.2607040393903882,   0.2575386392907273,
      0.3027295672685804,   0.3072279649306579,   0.3151745442046686,
      0.32712907480267317,  0.3402733222739759,   0.3484930157834256,
      0.3513098988775981,   0.35155028527949994,  0.005317800363858766,
      0.005230780933428381, 0.005090938974588383, 0.00492165563897284,
      0.004748128812814748, 0.004592997527796641, 0.004474200837102728,
      0.00440418649327166,  0.005360789441178993, 0.005450969213068261,
      0.005605440083747342, 0.005810044402332431, 0.00604276476240741,
      0.006273595697708566, 0.006467044059943434, 0.006588664325568582,
  }
                      .reshape(5, 3, 16)};
  const Matrix u0{Vector{
      0.7164691533282324,   0.6215727987250954,   0.551748253895844,
      0.5056879938804985,   0.47390665916197366,  0.4516671461847766,
      0.4369654111570505,   0.4289758612980197,   0.8163837746121,
      1.0494274142025273,   0.8774002131772574,   0.6520604392812852,
      0.5027450417823759,   0.4126990887205985,   0.36102794729769455,
      0.33558459764985904,  0.3006052015612011,   0.2963378177670009,
      0.2895597036329729,   0.2814717576945127,   0.27330976496111,
      0.26612760141318476,  0.2607040393903882,   0.2575386392907273,
      0.3027295672685804,   0.3072279649306579,   0.3151745442046686,
      0.32712907480267317,  0.3402733222739759,   0.3484930157834256,
      0.3513098988775981,   0.35155028527949994,  0.005317800363858766,
      0.005230780933428381, 0.005090938974588383, 0.00492165563897284,
      0.004748128812814748, 0.004592997527796641, 0.004474200837102728,
      0.00440418649327166,  0.005360789441178993, 0.005450969213068261,
      0.005605440083747342, 0.005810044402332431, 0.00604276476240741,
      0.006273595697708566, 0.006467044059943434, 0.006588664325568582,
  }
                      .reshape(3, 16)};
  const Vector flux_down_diffuse{
      1.568549451121739,
      1.0710538192833332,
      0.019337018443936045,
  };
  const Vector flux_down_direct{
      0.2473080718025409,
      2.871005731865268e-11,
      1.2764145357290263e-110,
  };
  const Vector flux_up{
      1.4799180933383977,
      0.8498057527984113,
      0.014719695725175012,
  };

  // flat_print(u, compute_u(dis, taus, phis));

  compare("test_1f",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          false);
}

int main() try {
  test_1a();
  test_1b();
  test_1c();
  test_1d();
  test_1e();
  test_1f();

  return EXIT_SUCCESS;
} catch (const std::exception& e) {
  std::cerr << e.what() << std::endl;
  return EXIT_FAILURE;
}
