#include <disort-test.h>

#include "sorted_grid.h"

const Vector Leg_coeffs_ALL{
    1,      2.544,  3.883,  4.568,  5.235,  5.887,  6.457,  7.177,  7.859,
    8.494,  9.286,  9.856,  10.615, 11.229, 11.851, 12.503, 13.058, 13.626,
    14.209, 14.660, 15.231, 15.641, 16.126, 16.539, 16.934, 17.325, 17.673,
    17.999, 18.329, 18.588, 18.885, 19.103, 19.345, 19.537, 19.721, 19.884,
    20.024, 20.145, 20.251, 20.330, 20.401, 20.444, 20.477, 20.489, 20.483,
    20.467, 20.427, 20.382, 20.310, 20.236, 20.136, 20.036, 19.909, 19.785,
    19.632, 19.486, 19.311, 19.145, 18.949, 18.764, 18.551, 18.348, 18.119,
    17.901, 17.659, 17.428, 17.174, 16.931, 16.668, 16.415, 16.144, 15.883,
    15.606, 15.338, 15.058, 14.784, 14.501, 14.225, 13.941, 13.662, 13.378,
    13.098, 12.816, 12.536, 12.257, 11.978, 11.703, 11.427, 11.156, 10.884,
    10.618, 10.350, 10.090, 9.827,  9.574,  9.318,  9.072,  8.822,  8.584,
    8.340,  8.110,  7.874,  7.652,  7.424,  7.211,  6.990,  6.785,  6.573,
    6.377,  6.173,  5.986,  5.790,  5.612,  5.424,  5.255,  5.075,  4.915,
    4.744,  4.592,  4.429,  4.285,  4.130,  3.994,  3.847,  3.719,  3.580,
    3.459,  3.327,  3.214,  3.090,  2.983,  2.866,  2.766,  2.656,  2.562,
    2.459,  2.372,  2.274,  2.193,  2.102,  2.025,  1.940,  1.869,  1.790,
    1.723,  1.649,  1.588,  1.518,  1.461,  1.397,  1.344,  1.284,  1.235,
    1.179,  1.134,  1.082,  1.040,  0.992,  0.954,  0.909,  0.873,  0.832,
    0.799,  0.762,  0.731,  0.696,  0.668,  0.636,  0.610,  0.581,  0.557,
    0.530,  0.508,  0.483,  0.463,  0.440,  0.422,  0.401,  0.384,  0.364,
    0.349,  0.331,  0.317,  0.301,  0.288,  0.273,  0.262,  0.248,  0.238,
    0.225,  0.215,  0.204,  0.195,  0.185,  0.177,  0.167,  0.160,  0.151,
    0.145,  0.137,  0.131,  0.124,  0.118,  0.112,  0.107,  0.101,  0.097,
    0.091,  0.087,  0.082,  0.079,  0.074,  0.071,  0.067,  0.064,  0.060,
    0.057,  0.054,  0.052,  0.049,  0.047,  0.044,  0.042,  0.039,  0.038,
    0.035,  0.034,  0.032,  0.030,  0.029,  0.027,  0.026,  0.024,  0.023,
    0.022,  0.021,  0.020,  0.018,  0.018,  0.017,  0.016,  0.015,  0.014,
    0.013,  0.013,  0.012,  0.011,  0.011,  0.010,  0.009,  0.009,  0.008,
    0.008,  0.008,  0.007,  0.007,  0.006,  0.006,  0.006,  0.005,  0.005,
    0.005,  0.005,  0.004,  0.004,  0.004,  0.004,  0.003,  0.003,  0.003,
    0.003,  0.003,  0.003,  0.002,  0.002,  0.002,  0.002,  0.002,  0.002,
    0.002,  0.002,  0.002,  0.001,  0.001,  0.001,  0.001,  0.001,  0.001,
    0.001,  0.001,  0.001,  0.001,  0.001,  0.001,  0.001,  0.001,  0.001,
    0.001,  0.001,  0.001};

void test_5a() try {
  const AscendingGrid tau_arr{64};
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad = 48;
  Matrix Leg_coeffs_all(1, Leg_coeffs_ALL.nelem(), 1);
  for (Index i = 1; i < Leg_coeffs_ALL.nelem(); i++) {
    Leg_coeffs_all(0, i) =
        Leg_coeffs_ALL[i] / (static_cast<Numeric>(2 * i + 1));
  }

  const Numeric mu0 = 1;
  const Numeric I0 = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{Leg_coeffs_all(0, NQuad)};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.5083700702235401,
      5.083700702235401,
      50.837007022354015,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.507063572207684,   0.51636564447546,    0.5321830383179786,
      0.5539972431384415,  0.5811833845540577,  0.6122423466230208,
      0.6448761665555232,  0.6796457578108405,  0.7141642321645364,
      0.7483733061632339,  0.7817172121102663,  0.8128841248003741,
      0.8411254232977388,  0.866891005434762,   0.8925072551139768,
      0.9238802409908266,  0.9579470522148495,  0.96980494166867,
      0.9652408204355815,  0.9703151246292322,  0.9751960286676178,
      0.9805459697657098,  0.9906083780360244,  1.0255798177030528,
      0.5026059204928238,  0.4929939158463259,  0.4748626741798086,
      0.44682768744428497, 0.40585546690400315, 0.35344484367665585,
      0.29767047372532995, 0.2486412978763419,  0.20867917383176834,
      0.17889198404923518, 0.15822602738913966, 0.14631560875691574,
      0.14232888900413043, 0.1457644313882178,  0.15766144894493292,
      0.17810892965542363, 0.209418319869943,   0.25495302993285324,
      0.31700562273113,    0.40134303985465547, 0.5164931946278004,
      0.6783851554369442,  1.0202938184357702,  4.607857807624242,
      0.9774269322344173,  0.9782234961145863,  0.9795372574931799,
      0.981318047389461,   0.983624788881885,   0.9861420135911327,
      0.9883085311072474,  0.9905248635130253,  0.9922915515096367,
      0.9935737919686982,  0.9944204070369081,  0.9946715719171169,
      0.9943375358761831,  0.9936968378829224,  0.9926932647580788,
      0.9921379334955616,  0.9914488687012672,  0.9892547300452603,
      0.9862515925749499,  0.9837861733277252,  0.9817197557010808,
      0.9803730049087086,  0.9799750628359662,  0.9810537155403897,
      0.9770337695109317,  0.9761679349041746,  0.9744982003900373,
      0.9719951259929452,  0.9688543709122791,  0.9649937789533457,
      0.9596965251891406,  0.9539247702178675,  0.9474464604417223,
      0.9405207634158946,  0.9345421859414664,  0.9301690637353549,
      0.9294860302851811,  0.9353033477861865,  0.9487046906540627,
      0.9747717828110428,  1.0145338727841107,  1.0720542968033118,
      1.1512675992588104,  1.2531200616114544,  1.3851532920333829,
      1.5641043499778187,  1.888153918206631,   3.793585097002943,
      0.31065778474132766, 0.30948568530913073, 0.3073973180857877,
      0.304426358741703,   0.30062151407031046, 0.2960452216695459,
      0.2907725815609881,  0.2848901546950307,  0.2784945573302836,
      0.27169090343523156, 0.2645911277277599,  0.25731221173508884,
      0.2499743566801228,  0.2426991262313735,  0.235607551697069,
      0.22881809988155727, 0.22244439866101373, 0.21659273307523844,
      0.2113595464843365,  0.2068293035209422,  0.20307301900755007,
      0.20014756485648486, 0.19809563442875291, 0.1969458112383366,
      0.3112091631217609,  0.3123812531005276,  0.31446957166387834,
      0.31744039198586504, 0.3212449408901727,  0.3258207087275452,
      0.33109253185345755, 0.33697381360002393, 0.34336795589818214,
      0.3501699511881018,  0.35726810473395043, 0.3645458692780265,
      0.37188375466113954, 0.3791612885473636,  0.3862589903371388,
      0.39306033329672996, 0.3994536556259553,  0.40533399460622394,
      0.4106048104985155,  0.41517957282877754, 0.418983183052939,
      0.42195321429371146, 0.4240409702982276,  0.42521265376071316,
      0.507063572207684,   0.51636564447546,    0.5321830383179786,
      0.5539972431384415,  0.5811833845540577,  0.6122423466230208,
      0.6448761665555232,  0.6796457578108405,  0.7141642321645364,
      0.7483733061632339,  0.7817172121102663,  0.8128841248003741,
      0.8411254232977388,  0.866891005434762,   0.8925072551139768,
      0.9238802409908266,  0.9579470522148495,  0.96980494166867,
      0.9652408204355815,  0.9703151246292322,  0.9751960286676178,
      0.9805459697657098,  0.9906083780360244,  1.0255798177030528,
      0.5026059204928238,  0.4929939158463259,  0.4748626741798086,
      0.44682768744428497, 0.40585546690400315, 0.35344484367665585,
      0.29767047372532995, 0.2486412978763419,  0.20867917383176834,
      0.17889198404923518, 0.15822602738913966, 0.14631560875691574,
      0.14232888900413043, 0.1457644313882178,  0.15766144894493292,
      0.17810892965542363, 0.209418319869943,   0.25495302993285324,
      0.31700562273113,    0.40134303985465547, 0.5164931946278004,
      0.6783851554369442,  1.0202938184357702,  4.607857807624242,
      0.9774269322344173,  0.9782234961145863,  0.9795372574931799,
      0.981318047389461,   0.983624788881885,   0.9861420135911327,
      0.9883085311072474,  0.9905248635130253,  0.9922915515096367,
      0.9935737919686982,  0.9944204070369081,  0.9946715719171169,
      0.9943375358761831,  0.9936968378829224,  0.9926932647580788,
      0.9921379334955616,  0.9914488687012672,  0.9892547300452603,
      0.9862515925749499,  0.9837861733277252,  0.9817197557010808,
      0.9803730049087086,  0.9799750628359662,  0.9810537155403897,
      0.9770337695109317,  0.9761679349041746,  0.9744982003900373,
      0.9719951259929452,  0.9688543709122791,  0.9649937789533457,
      0.9596965251891406,  0.9539247702178675,  0.9474464604417223,
      0.9405207634158946,  0.9345421859414664,  0.9301690637353549,
      0.9294860302851811,  0.9353033477861865,  0.9487046906540627,
      0.9747717828110428,  1.0145338727841107,  1.0720542968033118,
      1.1512675992588104,  1.2531200616114544,  1.3851532920333829,
      1.5641043499778187,  1.888153918206631,   3.793585097002943,
      0.31065778474132766, 0.30948568530913073, 0.3073973180857877,
      0.304426358741703,   0.30062151407031046, 0.2960452216695459,
      0.2907725815609881,  0.2848901546950307,  0.2784945573302836,
      0.27169090343523156, 0.2645911277277599,  0.25731221173508884,
      0.2499743566801228,  0.2426991262313735,  0.235607551697069,
      0.22881809988155727, 0.22244439866101373, 0.21659273307523844,
      0.2113595464843365,  0.2068293035209422,  0.20307301900755007,
      0.20014756485648486, 0.19809563442875291, 0.1969458112383366,
      0.3112091631217609,  0.3123812531005276,  0.31446957166387834,
      0.31744039198586504, 0.3212449408901727,  0.3258207087275452,
      0.33109253185345755, 0.33697381360002393, 0.34336795589818214,
      0.3501699511881018,  0.35726810473395043, 0.3645458692780265,
      0.37188375466113954, 0.3791612885473636,  0.3862589903371388,
      0.39306033329672996, 0.3994536556259553,  0.40533399460622394,
      0.4106048104985155,  0.41517957282877754, 0.418983183052939,
      0.42195321429371146, 0.4240409702982276,  0.42521265376071316,
      0.507063572207684,   0.51636564447546,    0.5321830383179786,
      0.5539972431384415,  0.5811833845540577,  0.6122423466230208,
      0.6448761665555232,  0.6796457578108405,  0.7141642321645364,
      0.7483733061632339,  0.7817172121102663,  0.8128841248003741,
      0.8411254232977388,  0.866891005434762,   0.8925072551139768,
      0.9238802409908266,  0.9579470522148495,  0.96980494166867,
      0.9652408204355815,  0.9703151246292322,  0.9751960286676178,
      0.9805459697657098,  0.9906083780360244,  1.0255798177030528,
      0.5026059204928238,  0.4929939158463259,  0.4748626741798086,
      0.44682768744428497, 0.40585546690400315, 0.35344484367665585,
      0.29767047372532995, 0.2486412978763419,  0.20867917383176834,
      0.17889198404923518, 0.15822602738913966, 0.14631560875691574,
      0.14232888900413043, 0.1457644313882178,  0.15766144894493292,
      0.17810892965542363, 0.209418319869943,   0.25495302993285324,
      0.31700562273113,    0.40134303985465547, 0.5164931946278004,
      0.6783851554369442,  1.0202938184357702,  4.607857807624242,
      0.9774269322344173,  0.9782234961145863,  0.9795372574931799,
      0.981318047389461,   0.983624788881885,   0.9861420135911327,
      0.9883085311072474,  0.9905248635130253,  0.9922915515096367,
      0.9935737919686982,  0.9944204070369081,  0.9946715719171169,
      0.9943375358761831,  0.9936968378829224,  0.9926932647580788,
      0.9921379334955616,  0.9914488687012672,  0.9892547300452603,
      0.9862515925749499,  0.9837861733277252,  0.9817197557010808,
      0.9803730049087086,  0.9799750628359662,  0.9810537155403897,
      0.9770337695109317,  0.9761679349041746,  0.9744982003900373,
      0.9719951259929452,  0.9688543709122791,  0.9649937789533457,
      0.9596965251891406,  0.9539247702178675,  0.9474464604417223,
      0.9405207634158946,  0.9345421859414664,  0.9301690637353549,
      0.9294860302851811,  0.9353033477861865,  0.9487046906540627,
      0.9747717828110428,  1.0145338727841107,  1.0720542968033118,
      1.1512675992588104,  1.2531200616114544,  1.3851532920333829,
      1.5641043499778187,  1.888153918206631,   3.793585097002943,
      0.31065778474132766, 0.30948568530913073, 0.3073973180857877,
      0.304426358741703,   0.30062151407031046, 0.2960452216695459,
      0.2907725815609881,  0.2848901546950307,  0.2784945573302836,
      0.27169090343523156, 0.2645911277277599,  0.25731221173508884,
      0.2499743566801228,  0.2426991262313735,  0.235607551697069,
      0.22881809988155727, 0.22244439866101373, 0.21659273307523844,
      0.2113595464843365,  0.2068293035209422,  0.20307301900755007,
      0.20014756485648486, 0.19809563442875291, 0.1969458112383366,
      0.3112091631217609,  0.3123812531005276,  0.31446957166387834,
      0.31744039198586504, 0.3212449408901727,  0.3258207087275452,
      0.33109253185345755, 0.33697381360002393, 0.34336795589818214,
      0.3501699511881018,  0.35726810473395043, 0.3645458692780265,
      0.37188375466113954, 0.3791612885473636,  0.3862589903371388,
      0.39306033329672996, 0.3994536556259553,  0.40533399460622394,
      0.4106048104985155,  0.41517957282877754, 0.418983183052939,
      0.42195321429371146, 0.4240409702982276,  0.42521265376071316,
      0.507063572207684,   0.51636564447546,    0.5321830383179786,
      0.5539972431384415,  0.5811833845540577,  0.6122423466230208,
      0.6448761665555232,  0.6796457578108405,  0.7141642321645364,
      0.7483733061632339,  0.7817172121102663,  0.8128841248003741,
      0.8411254232977388,  0.866891005434762,   0.8925072551139768,
      0.9238802409908266,  0.9579470522148495,  0.96980494166867,
      0.9652408204355815,  0.9703151246292322,  0.9751960286676178,
      0.9805459697657098,  0.9906083780360244,  1.0255798177030528,
      0.5026059204928238,  0.4929939158463259,  0.4748626741798086,
      0.44682768744428497, 0.40585546690400315, 0.35344484367665585,
      0.29767047372532995, 0.2486412978763419,  0.20867917383176834,
      0.17889198404923518, 0.15822602738913966, 0.14631560875691574,
      0.14232888900413043, 0.1457644313882178,  0.15766144894493292,
      0.17810892965542363, 0.209418319869943,   0.25495302993285324,
      0.31700562273113,    0.40134303985465547, 0.5164931946278004,
      0.6783851554369442,  1.0202938184357702,  4.607857807624242,
      0.9774269322344173,  0.9782234961145863,  0.9795372574931799,
      0.981318047389461,   0.983624788881885,   0.9861420135911327,
      0.9883085311072474,  0.9905248635130253,  0.9922915515096367,
      0.9935737919686982,  0.9944204070369081,  0.9946715719171169,
      0.9943375358761831,  0.9936968378829224,  0.9926932647580788,
      0.9921379334955616,  0.9914488687012672,  0.9892547300452603,
      0.9862515925749499,  0.9837861733277252,  0.9817197557010808,
      0.9803730049087086,  0.9799750628359662,  0.9810537155403897,
      0.9770337695109317,  0.9761679349041746,  0.9744982003900373,
      0.9719951259929452,  0.9688543709122791,  0.9649937789533457,
      0.9596965251891406,  0.9539247702178675,  0.9474464604417223,
      0.9405207634158946,  0.9345421859414664,  0.9301690637353549,
      0.9294860302851811,  0.9353033477861865,  0.9487046906540627,
      0.9747717828110428,  1.0145338727841107,  1.0720542968033118,
      1.1512675992588104,  1.2531200616114544,  1.3851532920333829,
      1.5641043499778187,  1.888153918206631,   3.793585097002943,
      0.31065778474132766, 0.30948568530913073, 0.3073973180857877,
      0.304426358741703,   0.30062151407031046, 0.2960452216695459,
      0.2907725815609881,  0.2848901546950307,  0.2784945573302836,
      0.27169090343523156, 0.2645911277277599,  0.25731221173508884,
      0.2499743566801228,  0.2426991262313735,  0.235607551697069,
      0.22881809988155727, 0.22244439866101373, 0.21659273307523844,
      0.2113595464843365,  0.2068293035209422,  0.20307301900755007,
      0.20014756485648486, 0.19809563442875291, 0.1969458112383366,
      0.3112091631217609,  0.3123812531005276,  0.31446957166387834,
      0.31744039198586504, 0.3212449408901727,  0.3258207087275452,
      0.33109253185345755, 0.33697381360002393, 0.34336795589818214,
      0.3501699511881018,  0.35726810473395043, 0.3645458692780265,
      0.37188375466113954, 0.3791612885473636,  0.3862589903371388,
      0.39306033329672996, 0.3994536556259553,  0.40533399460622394,
      0.4106048104985155,  0.41517957282877754, 0.418983183052939,
      0.42195321429371146, 0.4240409702982276,  0.42521265376071316,
      0.507063572207684,   0.51636564447546,    0.5321830383179786,
      0.5539972431384415,  0.5811833845540577,  0.6122423466230208,
      0.6448761665555232,  0.6796457578108405,  0.7141642321645364,
      0.7483733061632339,  0.7817172121102663,  0.8128841248003741,
      0.8411254232977388,  0.866891005434762,   0.8925072551139768,
      0.9238802409908266,  0.9579470522148495,  0.96980494166867,
      0.9652408204355815,  0.9703151246292322,  0.9751960286676178,
      0.9805459697657098,  0.9906083780360244,  1.0255798177030528,
      0.5026059204928238,  0.4929939158463259,  0.4748626741798086,
      0.44682768744428497, 0.40585546690400315, 0.35344484367665585,
      0.29767047372532995, 0.2486412978763419,  0.20867917383176834,
      0.17889198404923518, 0.15822602738913966, 0.14631560875691574,
      0.14232888900413043, 0.1457644313882178,  0.15766144894493292,
      0.17810892965542363, 0.209418319869943,   0.25495302993285324,
      0.31700562273113,    0.40134303985465547, 0.5164931946278004,
      0.6783851554369442,  1.0202938184357702,  4.607857807624242,
      0.9774269322344173,  0.9782234961145863,  0.9795372574931799,
      0.981318047389461,   0.983624788881885,   0.9861420135911327,
      0.9883085311072474,  0.9905248635130253,  0.9922915515096367,
      0.9935737919686982,  0.9944204070369081,  0.9946715719171169,
      0.9943375358761831,  0.9936968378829224,  0.9926932647580788,
      0.9921379334955616,  0.9914488687012672,  0.9892547300452603,
      0.9862515925749499,  0.9837861733277252,  0.9817197557010808,
      0.9803730049087086,  0.9799750628359662,  0.9810537155403897,
      0.9770337695109317,  0.9761679349041746,  0.9744982003900373,
      0.9719951259929452,  0.9688543709122791,  0.9649937789533457,
      0.9596965251891406,  0.9539247702178675,  0.9474464604417223,
      0.9405207634158946,  0.9345421859414664,  0.9301690637353549,
      0.9294860302851811,  0.9353033477861865,  0.9487046906540627,
      0.9747717828110428,  1.0145338727841107,  1.0720542968033118,
      1.1512675992588104,  1.2531200616114544,  1.3851532920333829,
      1.5641043499778187,  1.888153918206631,   3.793585097002943,
      0.31065778474132766, 0.30948568530913073, 0.3073973180857877,
      0.304426358741703,   0.30062151407031046, 0.2960452216695459,
      0.2907725815609881,  0.2848901546950307,  0.2784945573302836,
      0.27169090343523156, 0.2645911277277599,  0.25731221173508884,
      0.2499743566801228,  0.2426991262313735,  0.235607551697069,
      0.22881809988155727, 0.22244439866101373, 0.21659273307523844,
      0.2113595464843365,  0.2068293035209422,  0.20307301900755007,
      0.20014756485648486, 0.19809563442875291, 0.1969458112383366,
      0.3112091631217609,  0.3123812531005276,  0.31446957166387834,
      0.31744039198586504, 0.3212449408901727,  0.3258207087275452,
      0.33109253185345755, 0.33697381360002393, 0.34336795589818214,
      0.3501699511881018,  0.35726810473395043, 0.3645458692780265,
      0.37188375466113954, 0.3791612885473636,  0.3862589903371388,
      0.39306033329672996, 0.3994536556259553,  0.40533399460622394,
      0.4106048104985155,  0.41517957282877754, 0.418983183052939,
      0.42195321429371146, 0.4240409702982276,  0.42521265376071316,
  }
                      .reshape(5, 3, 48)};
  const Matrix u0{Vector{
      0.501201329826905,   0.5116359355024637,  0.5319074051483743,
      0.5589707619171111,  0.5827465970819395,  0.6075381590072287,
      0.6478287800261098,  0.6790355409602673,  0.7133931967257652,
      0.7494148660239399,  0.7810484322643073,  0.8126359592552933,
      0.8425020838682657,  0.8645419506106015,  0.8949221630961675,
      0.9227571957916987,  0.956903315770515,   0.9721166955254497,
      0.9637830054641607,  0.9689871998111064,  0.9780052461395315,
      0.9800096792783303,  0.9866559187128845,  1.0259002502783765,
      0.4966686437962501,  0.48787515310329704, 0.47425756881397013,
      0.4529963749015049,  0.408476005634349,   0.3459939903275797,
      0.30253369349357845, 0.24775800655372401, 0.20693919515249276,
      0.18146260630625397, 0.15636975183805416, 0.14601374154114258,
      0.14650107913349875, 0.13727041870317563, 0.1683831870000017,
      0.17162191402107488, 0.2031362524203933,  0.27577603408690954,
      0.29871937763798523, 0.3818725440679365,  0.5936766389483821,
      0.6251176881597851,  0.6385807821348144,  8.588920687973971,
      0.9772695078554363,  0.9780964847340475,  0.9795298556531103,
      0.9814516060269629,  0.9836667673170012,  0.9860156875599105,
      0.9883878204494114,  0.9905084767786486,  0.9922708461605165,
      0.9936017619678202,  0.9944024476546297,  0.9946649076913341,
      0.9943745046538804,  0.9936337564760365,  0.9927581145825486,
      0.9921077752930246,  0.9914208402522717,  0.9893168097737366,
      0.9862124444808182,  0.9837505132976124,  0.9817951942938945,
      0.9803586033893845,  0.9798689236806776,  0.9810623204215766,
      0.9768754438704327,  0.9760277640166496,  0.974478575572371,
      0.9721591341438979,  0.9689336085417326,  0.9647774267703809,
      0.9598449950430792,  0.9538966659970459,  0.9473662650538891,
      0.9406584253655178,  0.934421335628398,   0.9301643956807267,
      0.9298362763525451,  0.9344277651693338,  0.9500455031724694,
      0.9737836842154678,  1.0135552542508965,  1.0759574741123274,
      1.1472968116979971,  1.2490718342833227,  1.4038759147992033,
      1.5479011120352517,  1.7957409196327885,  5.157961463968172,
      0.31065778474132766, 0.30948568530913073, 0.3073973180857877,
      0.304426358741703,   0.30062151407031046, 0.2960452216695459,
      0.2907725815609881,  0.2848901546950307,  0.2784945573302836,
      0.27169090343523156, 0.2645911277277599,  0.25731221173508884,
      0.2499743566801228,  0.2426991262313735,  0.235607551697069,
      0.22881809988155727, 0.22244439866101373, 0.21659273307523844,
      0.2113595464843365,  0.2068293035209422,  0.20307301900755007,
      0.20014756485648486, 0.19809563442875291, 0.1969458112383366,
      0.3112091631217609,  0.3123812531005276,  0.31446957166387834,
      0.31744039198586504, 0.3212449408901727,  0.3258207087275452,
      0.33109253185345755, 0.33697381360002393, 0.34336795589818214,
      0.3501699511881018,  0.35726810473395043, 0.3645458692780265,
      0.37188375466113954, 0.3791612885473636,  0.3862589903371388,
      0.39306033329672996, 0.3994536556259553,  0.40533399460622394,
      0.4106048104985155,  0.41517957282877754, 0.418983183052939,
      0.4219532142937114,  0.4240409702982275,  0.42521265376071665,
  }
                      .reshape(3, 48)};
  const Vector flux_down_diffuse{
      1.3741548193855726,
      3.5696652566397336,
      1.2167573472564563,
  };
  const Vector flux_down_direct{
      1.8895898890890446,
      0.01946824083281573,
      2.6237245949071523e-22,
  };
  const Vector flux_up{
      2.7835953804235327,
      3.109037227698623,
      0.7370660620643675,
  };

  //flat_print(u, compute_u(dis, taus, phis, true) );
  //const auto [flux_up_, flux_down_diffuse_, flux_down_direct_] =  compute_flux(dis, taus);
  // flat_print(flux_down_direct, flux_down_direct_);

  compare("test_5a",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          true);
} catch (std::exception& e) {
  throw std::runtime_error(std::format("Error in test-5a:\n{}", e.what()));
}

void test_5b() try {
  const AscendingGrid tau_arr{64};
  const Vector omega_arr{0.9};
  const Index NQuad = 48;
  Matrix Leg_coeffs_all(1, Leg_coeffs_ALL.nelem(), 1);
  for (Index i = 1; i < Leg_coeffs_ALL.nelem(); i++) {
    Leg_coeffs_all(0, i) =
        Leg_coeffs_ALL[i] / (static_cast<Numeric>(2 * i + 1));
  }

  const Numeric mu0 = 1;
  const Numeric I0 = Constant::pi;
  const Numeric phi0 = 0;

  // Optional (unused)
  const Index NLeg = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{Leg_coeffs_all(0, NQuad)};
  const std::vector<disort::BDRF> BDRF_Fourier_modes{};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.5083700702235401,
      5.083700702235401,
      50.837007022354015,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.08674594639348392,    0.0873970797855139,     0.0882507200802331,
      0.08949608111613143,    0.09131254430314951,    0.09331855625394507,
      0.09458148796022411,    0.09636979957587326,    0.09767818377211163,
      0.09925429537389197,    0.10132490476474239,    0.10334541092834387,
      0.10507400752532388,    0.10704902426765851,    0.11130764123468125,
      0.1226542930292122,     0.13867521892730766,    0.13848200681621742,
      0.12664654919818422,    0.12470601387759098,    0.12398951395479038,
      0.1248691698809605,     0.1307025714363744,     0.1586435259137484,
      0.0864252355942811,     0.08575540015358021,    0.08420972156150437,
      0.08168004920309155,    0.07787402925719036,    0.07291295948817508,
      0.06686985381142888,    0.06242799023380432,    0.05947067467352151,
      0.058917181429422844,   0.060682935951739236,   0.06545802718745394,
      0.07347466260475019,    0.08514685726144375,    0.10202559956593474,
      0.12477819209177499,    0.155797688736987,      0.19832054209416497,
      0.25471108337882115,    0.3301476456487218,     0.4321502697459085,
      0.5750068727749713,     0.8761664385784642,     4.052545368915547,
      0.10322011043804612,    0.10201665326944995,    0.09988772749491245,
      0.0969901160276448,     0.09361548703125888,    0.08984225753084472,
      0.08559687993528213,    0.08144280513735293,    0.07730192415009024,
      0.07336076154095543,    0.06979994924614359,    0.06659694364505601,
      0.06378402558807743,    0.0615194743076996,     0.05970551932240424,
      0.05879969452646089,    0.058315587908438,      0.057175388952910536,
      0.05572775844317369,    0.05479992262625054,    0.05414914052824505,
      0.05389013474014071,    0.05411155221972683,    0.055182105909459454,
      0.10378624226409369,    0.10499589591319891,    0.10715418477647973,
      0.11033807594798827,    0.11480780189855642,    0.12065755988720148,
      0.1275453965115022,     0.13624735442467198,    0.1466671786073053,
      0.15893943692320311,    0.17380632938522442,    0.191309885477742,
      0.21226572764876778,    0.23786721834602656,    0.2681558325035843,
      0.3059646795458719,     0.3515816702699772,     0.40758586876346115,
      0.4765219607874068,     0.5592816784977748,     0.66145090462026,
      0.7943457900209945,     1.0286921477749198,     2.449426326732613,
      3.3277162244390357e-06, 3.280810961319551e-06,  3.1994501641677287e-06,
      3.0884413274541914e-06, 2.954024886309018e-06,  2.803216024528101e-06,
      2.64315304980907e-06,   2.4805280152848156e-06, 2.321157948574699e-06,
      2.169721671735651e-06,  2.0296566924990018e-06, 1.9031892445836027e-06,
      1.79145999135681e-06,   1.6947067567075844e-06, 1.612470817632165e-06,
      1.5438014554508426e-06, 1.48744202276088e-06,   1.4419882587325902e-06,
      1.406015385209765e-06,  1.3781745995528377e-06, 1.3572621743960278e-06,
      1.342265792482014e-06,  1.3323932082567351e-06, 1.3270869493064732e-06,
      3.3501003520690462e-06, 3.398358345768044e-06,  3.4866914148242084e-06,
      3.617707047378213e-06,  3.7951281768353316e-06, 4.0237694068993776e-06,
      4.309457279337967e-06,  4.658880432254112e-06,  5.079336207633348e-06,
      5.578332445259159e-06,  6.162999119386053e-06,  6.839267129134281e-06,
      7.6107858558902775e-06, 8.477582871385682e-06,  9.434523643929626e-06,
      1.046970793651271e-05,  1.1563036778429051e-05, 1.2685281016631641e-05,
      1.3798046127035184e-05, 1.4855013554992172e-05, 1.5804703829850026e-05,
      1.6594734423130608e-05, 1.7177174356931984e-05, 1.751429714503935e-05,
      0.08674594639348392,    0.0873970797855139,     0.0882507200802331,
      0.08949608111613143,    0.09131254430314951,    0.09331855625394507,
      0.09458148796022411,    0.09636979957587326,    0.09767818377211163,
      0.09925429537389197,    0.10132490476474239,    0.10334541092834387,
      0.10507400752532388,    0.10704902426765851,    0.11130764123468125,
      0.1226542930292122,     0.13867521892730766,    0.13848200681621742,
      0.12664654919818422,    0.12470601387759098,    0.12398951395479038,
      0.1248691698809605,     0.1307025714363744,     0.1586435259137484,
      0.0864252355942811,     0.08575540015358021,    0.08420972156150437,
      0.08168004920309155,    0.07787402925719036,    0.07291295948817508,
      0.06686985381142888,    0.06242799023380432,    0.05947067467352151,
      0.058917181429422844,   0.060682935951739236,   0.06545802718745394,
      0.07347466260475019,    0.08514685726144375,    0.10202559956593474,
      0.12477819209177499,    0.155797688736987,      0.19832054209416497,
      0.25471108337882115,    0.3301476456487218,     0.4321502697459085,
      0.5750068727749713,     0.8761664385784642,     4.052545368915547,
      0.10322011043804612,    0.10201665326944995,    0.09988772749491245,
      0.0969901160276448,     0.09361548703125888,    0.08984225753084472,
      0.08559687993528213,    0.08144280513735293,    0.07730192415009024,
      0.07336076154095543,    0.06979994924614359,    0.06659694364505601,
      0.06378402558807743,    0.0615194743076996,     0.05970551932240424,
      0.05879969452646089,    0.058315587908438,      0.057175388952910536,
      0.05572775844317369,    0.05479992262625054,    0.05414914052824505,
      0.05389013474014071,    0.05411155221972683,    0.055182105909459454,
      0.10378624226409369,    0.10499589591319891,    0.10715418477647973,
      0.11033807594798827,    0.11480780189855642,    0.12065755988720148,
      0.1275453965115022,     0.13624735442467198,    0.1466671786073053,
      0.15893943692320311,    0.17380632938522442,    0.191309885477742,
      0.21226572764876778,    0.23786721834602656,    0.2681558325035843,
      0.3059646795458719,     0.3515816702699772,     0.40758586876346115,
      0.4765219607874068,     0.5592816784977748,     0.66145090462026,
      0.7943457900209945,     1.0286921477749198,     2.449426326732613,
      3.3277162244390357e-06, 3.280810961319551e-06,  3.1994501641677287e-06,
      3.0884413274541914e-06, 2.954024886309018e-06,  2.803216024528101e-06,
      2.64315304980907e-06,   2.4805280152848156e-06, 2.321157948574699e-06,
      2.169721671735651e-06,  2.0296566924990018e-06, 1.9031892445836027e-06,
      1.79145999135681e-06,   1.6947067567075844e-06, 1.612470817632165e-06,
      1.5438014554508426e-06, 1.48744202276088e-06,   1.4419882587325902e-06,
      1.406015385209765e-06,  1.3781745995528377e-06, 1.3572621743960278e-06,
      1.342265792482014e-06,  1.3323932082567351e-06, 1.3270869493064732e-06,
      3.3501003520690462e-06, 3.398358345768044e-06,  3.4866914148242084e-06,
      3.617707047378213e-06,  3.7951281768353316e-06, 4.0237694068993776e-06,
      4.309457279337967e-06,  4.658880432254112e-06,  5.079336207633348e-06,
      5.578332445259159e-06,  6.162999119386053e-06,  6.839267129134281e-06,
      7.6107858558902775e-06, 8.477582871385682e-06,  9.434523643929626e-06,
      1.046970793651271e-05,  1.1563036778429051e-05, 1.2685281016631641e-05,
      1.3798046127035184e-05, 1.4855013554992172e-05, 1.5804703829850026e-05,
      1.6594734423130608e-05, 1.7177174356931984e-05, 1.751429714503935e-05,
      0.08674594639348392,    0.0873970797855139,     0.0882507200802331,
      0.08949608111613143,    0.09131254430314951,    0.09331855625394507,
      0.09458148796022411,    0.09636979957587326,    0.09767818377211163,
      0.09925429537389197,    0.10132490476474239,    0.10334541092834387,
      0.10507400752532388,    0.10704902426765851,    0.11130764123468125,
      0.1226542930292122,     0.13867521892730766,    0.13848200681621742,
      0.12664654919818422,    0.12470601387759098,    0.12398951395479038,
      0.1248691698809605,     0.1307025714363744,     0.1586435259137484,
      0.0864252355942811,     0.08575540015358021,    0.08420972156150437,
      0.08168004920309155,    0.07787402925719036,    0.07291295948817508,
      0.06686985381142888,    0.06242799023380432,    0.05947067467352151,
      0.058917181429422844,   0.060682935951739236,   0.06545802718745394,
      0.07347466260475019,    0.08514685726144375,    0.10202559956593474,
      0.12477819209177499,    0.155797688736987,      0.19832054209416497,
      0.25471108337882115,    0.3301476456487218,     0.4321502697459085,
      0.5750068727749713,     0.8761664385784642,     4.052545368915547,
      0.10322011043804612,    0.10201665326944995,    0.09988772749491245,
      0.0969901160276448,     0.09361548703125888,    0.08984225753084472,
      0.08559687993528213,    0.08144280513735293,    0.07730192415009024,
      0.07336076154095543,    0.06979994924614359,    0.06659694364505601,
      0.06378402558807743,    0.0615194743076996,     0.05970551932240424,
      0.05879969452646089,    0.058315587908438,      0.057175388952910536,
      0.05572775844317369,    0.05479992262625054,    0.05414914052824505,
      0.05389013474014071,    0.05411155221972683,    0.055182105909459454,
      0.10378624226409369,    0.10499589591319891,    0.10715418477647973,
      0.11033807594798827,    0.11480780189855642,    0.12065755988720148,
      0.1275453965115022,     0.13624735442467198,    0.1466671786073053,
      0.15893943692320311,    0.17380632938522442,    0.191309885477742,
      0.21226572764876778,    0.23786721834602656,    0.2681558325035843,
      0.3059646795458719,     0.3515816702699772,     0.40758586876346115,
      0.4765219607874068,     0.5592816784977748,     0.66145090462026,
      0.7943457900209945,     1.0286921477749198,     2.449426326732613,
      3.3277162244390357e-06, 3.280810961319551e-06,  3.1994501641677287e-06,
      3.0884413274541914e-06, 2.954024886309018e-06,  2.803216024528101e-06,
      2.64315304980907e-06,   2.4805280152848156e-06, 2.321157948574699e-06,
      2.169721671735651e-06,  2.0296566924990018e-06, 1.9031892445836027e-06,
      1.79145999135681e-06,   1.6947067567075844e-06, 1.612470817632165e-06,
      1.5438014554508426e-06, 1.48744202276088e-06,   1.4419882587325902e-06,
      1.406015385209765e-06,  1.3781745995528377e-06, 1.3572621743960278e-06,
      1.342265792482014e-06,  1.3323932082567351e-06, 1.3270869493064732e-06,
      3.3501003520690462e-06, 3.398358345768044e-06,  3.4866914148242084e-06,
      3.617707047378213e-06,  3.7951281768353316e-06, 4.0237694068993776e-06,
      4.309457279337967e-06,  4.658880432254112e-06,  5.079336207633348e-06,
      5.578332445259159e-06,  6.162999119386053e-06,  6.839267129134281e-06,
      7.6107858558902775e-06, 8.477582871385682e-06,  9.434523643929626e-06,
      1.046970793651271e-05,  1.1563036778429051e-05, 1.2685281016631641e-05,
      1.3798046127035184e-05, 1.4855013554992172e-05, 1.5804703829850026e-05,
      1.6594734423130608e-05, 1.7177174356931984e-05, 1.751429714503935e-05,
      0.08674594639348392,    0.0873970797855139,     0.0882507200802331,
      0.08949608111613143,    0.09131254430314951,    0.09331855625394507,
      0.09458148796022411,    0.09636979957587326,    0.09767818377211163,
      0.09925429537389197,    0.10132490476474239,    0.10334541092834387,
      0.10507400752532388,    0.10704902426765851,    0.11130764123468125,
      0.1226542930292122,     0.13867521892730766,    0.13848200681621742,
      0.12664654919818422,    0.12470601387759098,    0.12398951395479038,
      0.1248691698809605,     0.1307025714363744,     0.1586435259137484,
      0.0864252355942811,     0.08575540015358021,    0.08420972156150437,
      0.08168004920309155,    0.07787402925719036,    0.07291295948817508,
      0.06686985381142888,    0.06242799023380432,    0.05947067467352151,
      0.058917181429422844,   0.060682935951739236,   0.06545802718745394,
      0.07347466260475019,    0.08514685726144375,    0.10202559956593474,
      0.12477819209177499,    0.155797688736987,      0.19832054209416497,
      0.25471108337882115,    0.3301476456487218,     0.4321502697459085,
      0.5750068727749713,     0.8761664385784642,     4.052545368915547,
      0.10322011043804612,    0.10201665326944995,    0.09988772749491245,
      0.0969901160276448,     0.09361548703125888,    0.08984225753084472,
      0.08559687993528213,    0.08144280513735293,    0.07730192415009024,
      0.07336076154095543,    0.06979994924614359,    0.06659694364505601,
      0.06378402558807743,    0.0615194743076996,     0.05970551932240424,
      0.05879969452646089,    0.058315587908438,      0.057175388952910536,
      0.05572775844317369,    0.05479992262625054,    0.05414914052824505,
      0.05389013474014071,    0.05411155221972683,    0.055182105909459454,
      0.10378624226409369,    0.10499589591319891,    0.10715418477647973,
      0.11033807594798827,    0.11480780189855642,    0.12065755988720148,
      0.1275453965115022,     0.13624735442467198,    0.1466671786073053,
      0.15893943692320311,    0.17380632938522442,    0.191309885477742,
      0.21226572764876778,    0.23786721834602656,    0.2681558325035843,
      0.3059646795458719,     0.3515816702699772,     0.40758586876346115,
      0.4765219607874068,     0.5592816784977748,     0.66145090462026,
      0.7943457900209945,     1.0286921477749198,     2.449426326732613,
      3.3277162244390357e-06, 3.280810961319551e-06,  3.1994501641677287e-06,
      3.0884413274541914e-06, 2.954024886309018e-06,  2.803216024528101e-06,
      2.64315304980907e-06,   2.4805280152848156e-06, 2.321157948574699e-06,
      2.169721671735651e-06,  2.0296566924990018e-06, 1.9031892445836027e-06,
      1.79145999135681e-06,   1.6947067567075844e-06, 1.612470817632165e-06,
      1.5438014554508426e-06, 1.48744202276088e-06,   1.4419882587325902e-06,
      1.406015385209765e-06,  1.3781745995528377e-06, 1.3572621743960278e-06,
      1.342265792482014e-06,  1.3323932082567351e-06, 1.3270869493064732e-06,
      3.3501003520690462e-06, 3.398358345768044e-06,  3.4866914148242084e-06,
      3.617707047378213e-06,  3.7951281768353316e-06, 4.0237694068993776e-06,
      4.309457279337967e-06,  4.658880432254112e-06,  5.079336207633348e-06,
      5.578332445259159e-06,  6.162999119386053e-06,  6.839267129134281e-06,
      7.6107858558902775e-06, 8.477582871385682e-06,  9.434523643929626e-06,
      1.046970793651271e-05,  1.1563036778429051e-05, 1.2685281016631641e-05,
      1.3798046127035184e-05, 1.4855013554992172e-05, 1.5804703829850026e-05,
      1.6594734423130608e-05, 1.7177174356931984e-05, 1.751429714503935e-05,
      0.08674594639348392,    0.0873970797855139,     0.0882507200802331,
      0.08949608111613143,    0.09131254430314951,    0.09331855625394507,
      0.09458148796022411,    0.09636979957587326,    0.09767818377211163,
      0.09925429537389197,    0.10132490476474239,    0.10334541092834387,
      0.10507400752532388,    0.10704902426765851,    0.11130764123468125,
      0.1226542930292122,     0.13867521892730766,    0.13848200681621742,
      0.12664654919818422,    0.12470601387759098,    0.12398951395479038,
      0.1248691698809605,     0.1307025714363744,     0.1586435259137484,
      0.0864252355942811,     0.08575540015358021,    0.08420972156150437,
      0.08168004920309155,    0.07787402925719036,    0.07291295948817508,
      0.06686985381142888,    0.06242799023380432,    0.05947067467352151,
      0.058917181429422844,   0.060682935951739236,   0.06545802718745394,
      0.07347466260475019,    0.08514685726144375,    0.10202559956593474,
      0.12477819209177499,    0.155797688736987,      0.19832054209416497,
      0.25471108337882115,    0.3301476456487218,     0.4321502697459085,
      0.5750068727749713,     0.8761664385784642,     4.052545368915547,
      0.10322011043804612,    0.10201665326944995,    0.09988772749491245,
      0.0969901160276448,     0.09361548703125888,    0.08984225753084472,
      0.08559687993528213,    0.08144280513735293,    0.07730192415009024,
      0.07336076154095543,    0.06979994924614359,    0.06659694364505601,
      0.06378402558807743,    0.0615194743076996,     0.05970551932240424,
      0.05879969452646089,    0.058315587908438,      0.057175388952910536,
      0.05572775844317369,    0.05479992262625054,    0.05414914052824505,
      0.05389013474014071,    0.05411155221972683,    0.055182105909459454,
      0.10378624226409369,    0.10499589591319891,    0.10715418477647973,
      0.11033807594798827,    0.11480780189855642,    0.12065755988720148,
      0.1275453965115022,     0.13624735442467198,    0.1466671786073053,
      0.15893943692320311,    0.17380632938522442,    0.191309885477742,
      0.21226572764876778,    0.23786721834602656,    0.2681558325035843,
      0.3059646795458719,     0.3515816702699772,     0.40758586876346115,
      0.4765219607874068,     0.5592816784977748,     0.66145090462026,
      0.7943457900209945,     1.0286921477749198,     2.449426326732613,
      3.3277162244390357e-06, 3.280810961319551e-06,  3.1994501641677287e-06,
      3.0884413274541914e-06, 2.954024886309018e-06,  2.803216024528101e-06,
      2.64315304980907e-06,   2.4805280152848156e-06, 2.321157948574699e-06,
      2.169721671735651e-06,  2.0296566924990018e-06, 1.9031892445836027e-06,
      1.79145999135681e-06,   1.6947067567075844e-06, 1.612470817632165e-06,
      1.5438014554508426e-06, 1.48744202276088e-06,   1.4419882587325902e-06,
      1.406015385209765e-06,  1.3781745995528377e-06, 1.3572621743960278e-06,
      1.342265792482014e-06,  1.3323932082567351e-06, 1.3270869493064732e-06,
      3.3501003520690462e-06, 3.398358345768044e-06,  3.4866914148242084e-06,
      3.617707047378213e-06,  3.7951281768353316e-06, 4.0237694068993776e-06,
      4.309457279337967e-06,  4.658880432254112e-06,  5.079336207633348e-06,
      5.578332445259159e-06,  6.162999119386053e-06,  6.839267129134281e-06,
      7.6107858558902775e-06, 8.477582871385682e-06,  9.434523643929626e-06,
      1.046970793651271e-05,  1.1563036778429051e-05, 1.2685281016631641e-05,
      1.3798046127035184e-05, 1.4855013554992172e-05, 1.5804703829850026e-05,
      1.6594734423130608e-05, 1.7177174356931984e-05, 1.751429714503935e-05,
  }
                      .reshape(5, 3, 48)};
  const Matrix u0{Vector{
      0.08166046301428136,    0.08329406684126896,    0.08801160886446767,
      0.0938105985724559,     0.09266862800155977,    0.08923768303532834,
      0.09714287415931921,    0.0958404376952601,     0.0970093120923081,
      0.10015784644121595,    0.10074473960437272,    0.10313012782116002,
      0.10626825777897647,    0.10501122397057892,    0.11340256901282994,
      0.12168005359602471,    0.13776977967809914,    0.14048744859972445,
      0.12538189766630278,    0.12355404179033105,    0.12642650441578257,
      0.12440393897052672,    0.12727382098744955,    0.15892150052314125,
      0.0812743572596944,     0.08131560433415523,    0.08368565223127178,
      0.08703291170688626,    0.0801496942241299,     0.06641737907078675,
      0.07112658900746568,    0.061651770898440074,   0.05793961284070783,
      0.061184688887425544,   0.059042758136126756,   0.06518887160820135,
      0.07717499932682843,    0.0776077462290318,     0.11154716630389432,
      0.11901661597698981,    0.15020762579761623,    0.21684292999687568,
      0.23845013071256366,    0.3127993921547117,     0.5008532948578285,
      0.5277196812306896,     0.5358951517190403,     7.582628699399735,
      0.10309602068360008,    0.10191653655865261,    0.09988189299505527,
      0.09709539361323244,    0.09364857652946317,    0.08974268104659261,
      0.08565937975305501,    0.0814298882952594,     0.07728560316026219,
      0.07338280889058049,    0.06978579276446423,    0.06659169056960283,
      0.06381316622421222,    0.06146975039364478,    0.059756637191481506,
      0.05877592232566474,    0.05829349448570466,    0.05722432329403707,
      0.05569689996102964,    0.054771813610297135,   0.054208604993143034,
      0.05387878274365744,    0.0540278880388539,     0.05518888870638351,
      0.10366136787864305,    0.1048855860862099,     0.10713893748360935,
      0.11046747582828761,    0.11486977256555697,    0.1204871282891925,
      0.12766277276401244,    0.1362249745203465,     0.14660438234869477,
      0.15904741324927651,    0.1737115779341286,     0.1913052317539591,
      0.2125433934355181,     0.23717271665245318,    0.26922048818814215,
      0.3051801563145659,     0.35079549880581223,    0.4107142766962426,
      0.47334256335963243,    0.5559993443076817,     0.6765474524382528,
      0.7814368351277757,     0.9534458383268352,     3.5329076167453435,
      3.3277162244390264e-06, 3.2808109613195434e-06, 3.1994501641677283e-06,
      3.0884413274541994e-06, 2.9540248863090204e-06, 2.8032160245280935e-06,
      2.6431530498090746e-06, 2.4805280152848147e-06, 2.3211579485746977e-06,
      2.169721671735653e-06,  2.0296566924990005e-06, 1.9031892445836023e-06,
      1.7914599913568121e-06, 1.6947067567075806e-06, 1.6124708176321688e-06,
      1.543801455450841e-06,  1.4874420227608784e-06, 1.4419882587325938e-06,
      1.4060153852097626e-06, 1.3781745995528356e-06, 1.3572621743960323e-06,
      1.3422657924820133e-06, 1.3323932082567288e-06, 1.3270869493064736e-06,
      3.3501003520690373e-06, 3.3983583457680343e-06, 3.4866914148242054e-06,
      3.6177070473782213e-06, 3.7951281768353405e-06, 4.023769406899364e-06,
      4.309457279337973e-06,  4.658880432254113e-06,  5.07933620763334e-06,
      5.578332445259173e-06,  6.16299911938604e-06,   6.839267129134292e-06,
      7.6107858558902885e-06, 8.477582871385638e-06,  9.434523643929719e-06,
      1.0469707936512601e-05, 1.156303677842903e-05,  1.2685281016632027e-05,
      1.37980461270345e-05,   1.485501355499183e-05,  1.580470382985483e-05,
      1.659473442312193e-05,  1.7177174356895185e-05, 1.751429714611319e-05,
  }
                      .reshape(3, 48)};
  const Vector flux_down_diffuse{
      1.0489552951616465,
      1.273615791907322,
      3.290887153731153e-05,
  };
  const Vector flux_down_direct{
      1.8895898890890446,
      0.01946824083281573,
      2.6237245949071523e-22,
  };
  const Vector flux_up{
      0.36859548629991395,
      0.19518366673270404,
      5.298488410692906e-06,
  };

  // flat_print(u, compute_u(dis, taus, phis, true) );
  //  const auto [flux_up_, flux_down_diffuse_, flux_down_direct_] =  compute_flux(dis, taus);
  //  flat_print(flux_down_diffuse, flux_down_diffuse_);

  compare("test_5b",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          true);
} catch (std::exception& e) {
  throw std::runtime_error(std::format("Error in test-5b:\n{}", e.what()));
}

void test_5BDRF() try {
  const AscendingGrid tau_arr{64};
  const Vector omega_arr{1 - 1e-6};
  const Index NQuad = 48;
  Matrix Leg_coeffs_all(1, Leg_coeffs_ALL.nelem(), 1);
  for (Index i = 1; i < Leg_coeffs_ALL.nelem(); i++) {
    Leg_coeffs_all(0, i) =
        Leg_coeffs_ALL[i] / (static_cast<Numeric>(2 * i + 1));
  }

  const Numeric mu0 = 1;
  const Numeric I0 = Constant::pi;
  const Numeric phi0 = 0;
  const std::vector<disort::BDRF> BDRF_Fourier_modes{
      disort::BDRF{[](auto c, auto&, auto&) { c = 1; }}};

  // Optional (unused)
  const Index NLeg = NQuad;
  const Index NFourier = NQuad;
  const Matrix b_pos(NQuad, NQuad / 2, 0);
  const Matrix b_neg(NQuad, NQuad / 2, 0);
  const Vector f_arr{Leg_coeffs_all(0, NQuad)};
  const Matrix s_poly_coeffs(1, 0);

  const disort::main_data dis(NQuad,
                              NLeg,
                              NFourier,
                              tau_arr,
                              omega_arr,
                              Leg_coeffs_all,
                              b_pos,
                              b_neg,
                              f_arr,
                              s_poly_coeffs,
                              BDRF_Fourier_modes,
                              mu0,
                              I0,
                              phi0);

  const Vector taus{
      0.5083700702235401,
      5.083700702235401,
      50.837007022354015,
  };
  const Vector phis{
      0.0,
      1.5705463267948965,
      3.141092653589793,
      4.71163898038469,
      6.282185307179586,
  };
  const Tensor3 u{Vector{
      0.5822592238144008,  0.5931597331853786,  0.611771717018605,
      0.6374709382938816,  0.6695161640019965,  0.7062840924918823,
      0.7453485549085075,  0.7871425018558244,  0.8291490001693393,
      0.8711812951079485,  0.9125569122632301,  0.9518399755031232,
      0.9881607470329598,  1.0218515003657107,  1.0551248544395107,
      1.0937784788062206,  1.1346471744683941,  1.152731750938279,
      1.153728872092833,   1.1636166979380775,  1.1724913089931595,
      1.1809549168454958,  1.193203741980665,   1.2294014452711794,
      0.5770406621548679,  0.5657891695423412,  0.5446452007918775,
      0.5120111092086335,  0.464346418322673,   0.4033604716532605,
      0.3385880653638812,  0.28142249981228173, 0.23467575290648654,
      0.19947337867204928, 0.17459091322863196, 0.159450839480953,
      0.1530168967571177,  0.15461029791602282, 0.16512583412047743,
      0.18453982230046972, 0.21507947806591388, 0.2600433652472495,
      0.321674566296712,   0.4057038396820004,  0.5206325523845258,
      0.6823706736374883,  1.024180347944659,   4.61169206602885,
      1.1466502570203054,  1.1486381993212462,  1.1520739314851156,
      1.1568718547387178,  1.1630398407957092,  1.1701972603900388,
      1.1777049619849356,  1.1858741524842062,  1.1941063265866505,
      1.2022596310240599,  1.2102696247505893,  1.2178588477891212,
      1.2249174075889493,  1.2316030770326405,  1.2377401341431409,
      1.2440233196078894,  1.2497592573787437,  1.2534719731749857,
      1.2557613778328354,  1.2578880681532567,  1.2596386512026518,
      1.261271760129538,   1.2629681668420176,  1.2652220927984439,
      1.1456965400232764,  1.1436388878224044,  1.1398449206793222,
      1.1343182389075108,  1.1273024051410605,  1.118776864170838,
      1.1080992411959194,  1.0963181281735392,  1.0832991934221519,
      1.0694115916869136,  1.0561771149257408,  1.0444051950234001,
      1.0363539724647408,  1.035015639220409,   1.0416438184506702,
      1.0614608043238734,  1.0955979253644237,  1.1481813986174703,
      1.223174771715551,   1.3215278944682558,  1.4507695864300243,
      1.6276160437021532,  1.9502257921554187,  3.854863256388969,
      1.2768544235121877,  1.2768539105004602,  1.2768530053551186,
      1.2768517373288695,  1.2768501471030425,  1.2768482845962272,
      1.2768462065634887,  1.2768439739575277,  1.276841649165794,
      1.2768392932945418,  1.2768369636551675,  1.2768347115871095,
      1.2768325807352037,  1.2768306058635026,  1.2768288122645128,
      1.276827215793192,   1.2768258235291468,  1.2768246350084274,
      1.2768236438958356,  1.2768228399074528,  1.276822210775857,
      1.2768217440757472,  1.2768214287774051,  1.2768212564095036,
      1.2768546660854576,  1.2768551843759617,  1.2768561167208703,
      1.276857462720023,   1.276859220169868,   1.276861384021501,
      1.2768639449288832,  1.2768668876818707,  1.2768701897032289,
      1.2768738197378282,  1.276877736864235,   1.2768818899476941,
      1.2768862176197107,  1.2768906488436509,  1.2768951040825856,
      1.276899497052366,   1.2769037369969618,  1.2769077313928041,
      1.2769113889544266,  1.276914622794578,   1.2769173535825753,
      1.2769195125493293,  1.2769210442103782,  1.2769219088985975,
      0.5822592238144008,  0.5931597331853786,  0.611771717018605,
      0.6374709382938816,  0.6695161640019965,  0.7062840924918823,
      0.7453485549085075,  0.7871425018558244,  0.8291490001693393,
      0.8711812951079485,  0.9125569122632301,  0.9518399755031232,
      0.9881607470329598,  1.0218515003657107,  1.0551248544395107,
      1.0937784788062206,  1.1346471744683941,  1.152731750938279,
      1.153728872092833,   1.1636166979380775,  1.1724913089931595,
      1.1809549168454958,  1.193203741980665,   1.2294014452711794,
      0.5770406621548679,  0.5657891695423412,  0.5446452007918775,
      0.5120111092086335,  0.464346418322673,   0.4033604716532605,
      0.3385880653638812,  0.28142249981228173, 0.23467575290648654,
      0.19947337867204928, 0.17459091322863196, 0.159450839480953,
      0.1530168967571177,  0.15461029791602282, 0.16512583412047743,
      0.18453982230046972, 0.21507947806591388, 0.2600433652472495,
      0.321674566296712,   0.4057038396820004,  0.5206325523845258,
      0.6823706736374883,  1.024180347944659,   4.61169206602885,
      1.1466502570203054,  1.1486381993212462,  1.1520739314851156,
      1.1568718547387178,  1.1630398407957092,  1.1701972603900388,
      1.1777049619849356,  1.1858741524842062,  1.1941063265866505,
      1.2022596310240599,  1.2102696247505893,  1.2178588477891212,
      1.2249174075889493,  1.2316030770326405,  1.2377401341431409,
      1.2440233196078894,  1.2497592573787437,  1.2534719731749857,
      1.2557613778328354,  1.2578880681532567,  1.2596386512026518,
      1.261271760129538,   1.2629681668420176,  1.2652220927984439,
      1.1456965400232764,  1.1436388878224044,  1.1398449206793222,
      1.1343182389075108,  1.1273024051410605,  1.118776864170838,
      1.1080992411959194,  1.0963181281735392,  1.0832991934221519,
      1.0694115916869136,  1.0561771149257408,  1.0444051950234001,
      1.0363539724647408,  1.035015639220409,   1.0416438184506702,
      1.0614608043238734,  1.0955979253644237,  1.1481813986174703,
      1.223174771715551,   1.3215278944682558,  1.4507695864300243,
      1.6276160437021532,  1.9502257921554187,  3.854863256388969,
      1.2768544235121877,  1.2768539105004602,  1.2768530053551186,
      1.2768517373288695,  1.2768501471030425,  1.2768482845962272,
      1.2768462065634887,  1.2768439739575277,  1.276841649165794,
      1.2768392932945418,  1.2768369636551675,  1.2768347115871095,
      1.2768325807352037,  1.2768306058635026,  1.2768288122645128,
      1.276827215793192,   1.2768258235291468,  1.2768246350084274,
      1.2768236438958356,  1.2768228399074528,  1.276822210775857,
      1.2768217440757472,  1.2768214287774051,  1.2768212564095036,
      1.2768546660854576,  1.2768551843759617,  1.2768561167208703,
      1.276857462720023,   1.276859220169868,   1.276861384021501,
      1.2768639449288832,  1.2768668876818707,  1.2768701897032289,
      1.2768738197378282,  1.276877736864235,   1.2768818899476941,
      1.2768862176197107,  1.2768906488436509,  1.2768951040825856,
      1.276899497052366,   1.2769037369969618,  1.2769077313928041,
      1.2769113889544266,  1.276914622794578,   1.2769173535825753,
      1.2769195125493293,  1.2769210442103782,  1.2769219088985975,
      0.5822592238144008,  0.5931597331853786,  0.611771717018605,
      0.6374709382938816,  0.6695161640019965,  0.7062840924918823,
      0.7453485549085075,  0.7871425018558244,  0.8291490001693393,
      0.8711812951079485,  0.9125569122632301,  0.9518399755031232,
      0.9881607470329598,  1.0218515003657107,  1.0551248544395107,
      1.0937784788062206,  1.1346471744683941,  1.152731750938279,
      1.153728872092833,   1.1636166979380775,  1.1724913089931595,
      1.1809549168454958,  1.193203741980665,   1.2294014452711794,
      0.5770406621548679,  0.5657891695423412,  0.5446452007918775,
      0.5120111092086335,  0.464346418322673,   0.4033604716532605,
      0.3385880653638812,  0.28142249981228173, 0.23467575290648654,
      0.19947337867204928, 0.17459091322863196, 0.159450839480953,
      0.1530168967571177,  0.15461029791602282, 0.16512583412047743,
      0.18453982230046972, 0.21507947806591388, 0.2600433652472495,
      0.321674566296712,   0.4057038396820004,  0.5206325523845258,
      0.6823706736374883,  1.024180347944659,   4.61169206602885,
      1.1466502570203054,  1.1486381993212462,  1.1520739314851156,
      1.1568718547387178,  1.1630398407957092,  1.1701972603900388,
      1.1777049619849356,  1.1858741524842062,  1.1941063265866505,
      1.2022596310240599,  1.2102696247505893,  1.2178588477891212,
      1.2249174075889493,  1.2316030770326405,  1.2377401341431409,
      1.2440233196078894,  1.2497592573787437,  1.2534719731749857,
      1.2557613778328354,  1.2578880681532567,  1.2596386512026518,
      1.261271760129538,   1.2629681668420176,  1.2652220927984439,
      1.1456965400232764,  1.1436388878224044,  1.1398449206793222,
      1.1343182389075108,  1.1273024051410605,  1.118776864170838,
      1.1080992411959194,  1.0963181281735392,  1.0832991934221519,
      1.0694115916869136,  1.0561771149257408,  1.0444051950234001,
      1.0363539724647408,  1.035015639220409,   1.0416438184506702,
      1.0614608043238734,  1.0955979253644237,  1.1481813986174703,
      1.223174771715551,   1.3215278944682558,  1.4507695864300243,
      1.6276160437021532,  1.9502257921554187,  3.854863256388969,
      1.2768544235121877,  1.2768539105004602,  1.2768530053551186,
      1.2768517373288695,  1.2768501471030425,  1.2768482845962272,
      1.2768462065634887,  1.2768439739575277,  1.276841649165794,
      1.2768392932945418,  1.2768369636551675,  1.2768347115871095,
      1.2768325807352037,  1.2768306058635026,  1.2768288122645128,
      1.276827215793192,   1.2768258235291468,  1.2768246350084274,
      1.2768236438958356,  1.2768228399074528,  1.276822210775857,
      1.2768217440757472,  1.2768214287774051,  1.2768212564095036,
      1.2768546660854576,  1.2768551843759617,  1.2768561167208703,
      1.276857462720023,   1.276859220169868,   1.276861384021501,
      1.2768639449288832,  1.2768668876818707,  1.2768701897032289,
      1.2768738197378282,  1.276877736864235,   1.2768818899476941,
      1.2768862176197107,  1.2768906488436509,  1.2768951040825856,
      1.276899497052366,   1.2769037369969618,  1.2769077313928041,
      1.2769113889544266,  1.276914622794578,   1.2769173535825753,
      1.2769195125493293,  1.2769210442103782,  1.2769219088985975,
      0.5822592238144008,  0.5931597331853786,  0.611771717018605,
      0.6374709382938816,  0.6695161640019965,  0.7062840924918823,
      0.7453485549085075,  0.7871425018558244,  0.8291490001693393,
      0.8711812951079485,  0.9125569122632301,  0.9518399755031232,
      0.9881607470329598,  1.0218515003657107,  1.0551248544395107,
      1.0937784788062206,  1.1346471744683941,  1.152731750938279,
      1.153728872092833,   1.1636166979380775,  1.1724913089931595,
      1.1809549168454958,  1.193203741980665,   1.2294014452711794,
      0.5770406621548679,  0.5657891695423412,  0.5446452007918775,
      0.5120111092086335,  0.464346418322673,   0.4033604716532605,
      0.3385880653638812,  0.28142249981228173, 0.23467575290648654,
      0.19947337867204928, 0.17459091322863196, 0.159450839480953,
      0.1530168967571177,  0.15461029791602282, 0.16512583412047743,
      0.18453982230046972, 0.21507947806591388, 0.2600433652472495,
      0.321674566296712,   0.4057038396820004,  0.5206325523845258,
      0.6823706736374883,  1.024180347944659,   4.61169206602885,
      1.1466502570203054,  1.1486381993212462,  1.1520739314851156,
      1.1568718547387178,  1.1630398407957092,  1.1701972603900388,
      1.1777049619849356,  1.1858741524842062,  1.1941063265866505,
      1.2022596310240599,  1.2102696247505893,  1.2178588477891212,
      1.2249174075889493,  1.2316030770326405,  1.2377401341431409,
      1.2440233196078894,  1.2497592573787437,  1.2534719731749857,
      1.2557613778328354,  1.2578880681532567,  1.2596386512026518,
      1.261271760129538,   1.2629681668420176,  1.2652220927984439,
      1.1456965400232764,  1.1436388878224044,  1.1398449206793222,
      1.1343182389075108,  1.1273024051410605,  1.118776864170838,
      1.1080992411959194,  1.0963181281735392,  1.0832991934221519,
      1.0694115916869136,  1.0561771149257408,  1.0444051950234001,
      1.0363539724647408,  1.035015639220409,   1.0416438184506702,
      1.0614608043238734,  1.0955979253644237,  1.1481813986174703,
      1.223174771715551,   1.3215278944682558,  1.4507695864300243,
      1.6276160437021532,  1.9502257921554187,  3.854863256388969,
      1.2768544235121877,  1.2768539105004602,  1.2768530053551186,
      1.2768517373288695,  1.2768501471030425,  1.2768482845962272,
      1.2768462065634887,  1.2768439739575277,  1.276841649165794,
      1.2768392932945418,  1.2768369636551675,  1.2768347115871095,
      1.2768325807352037,  1.2768306058635026,  1.2768288122645128,
      1.276827215793192,   1.2768258235291468,  1.2768246350084274,
      1.2768236438958356,  1.2768228399074528,  1.276822210775857,
      1.2768217440757472,  1.2768214287774051,  1.2768212564095036,
      1.2768546660854576,  1.2768551843759617,  1.2768561167208703,
      1.276857462720023,   1.276859220169868,   1.276861384021501,
      1.2768639449288832,  1.2768668876818707,  1.2768701897032289,
      1.2768738197378282,  1.276877736864235,   1.2768818899476941,
      1.2768862176197107,  1.2768906488436509,  1.2768951040825856,
      1.276899497052366,   1.2769037369969618,  1.2769077313928041,
      1.2769113889544266,  1.276914622794578,   1.2769173535825753,
      1.2769195125493293,  1.2769210442103782,  1.2769219088985975,
      0.5822592238144008,  0.5931597331853786,  0.611771717018605,
      0.6374709382938816,  0.6695161640019965,  0.7062840924918823,
      0.7453485549085075,  0.7871425018558244,  0.8291490001693393,
      0.8711812951079485,  0.9125569122632301,  0.9518399755031232,
      0.9881607470329598,  1.0218515003657107,  1.0551248544395107,
      1.0937784788062206,  1.1346471744683941,  1.152731750938279,
      1.153728872092833,   1.1636166979380775,  1.1724913089931595,
      1.1809549168454958,  1.193203741980665,   1.2294014452711794,
      0.5770406621548679,  0.5657891695423412,  0.5446452007918775,
      0.5120111092086335,  0.464346418322673,   0.4033604716532605,
      0.3385880653638812,  0.28142249981228173, 0.23467575290648654,
      0.19947337867204928, 0.17459091322863196, 0.159450839480953,
      0.1530168967571177,  0.15461029791602282, 0.16512583412047743,
      0.18453982230046972, 0.21507947806591388, 0.2600433652472495,
      0.321674566296712,   0.4057038396820004,  0.5206325523845258,
      0.6823706736374883,  1.024180347944659,   4.61169206602885,
      1.1466502570203054,  1.1486381993212462,  1.1520739314851156,
      1.1568718547387178,  1.1630398407957092,  1.1701972603900388,
      1.1777049619849356,  1.1858741524842062,  1.1941063265866505,
      1.2022596310240599,  1.2102696247505893,  1.2178588477891212,
      1.2249174075889493,  1.2316030770326405,  1.2377401341431409,
      1.2440233196078894,  1.2497592573787437,  1.2534719731749857,
      1.2557613778328354,  1.2578880681532567,  1.2596386512026518,
      1.261271760129538,   1.2629681668420176,  1.2652220927984439,
      1.1456965400232764,  1.1436388878224044,  1.1398449206793222,
      1.1343182389075108,  1.1273024051410605,  1.118776864170838,
      1.1080992411959194,  1.0963181281735392,  1.0832991934221519,
      1.0694115916869136,  1.0561771149257408,  1.0444051950234001,
      1.0363539724647408,  1.035015639220409,   1.0416438184506702,
      1.0614608043238734,  1.0955979253644237,  1.1481813986174703,
      1.223174771715551,   1.3215278944682558,  1.4507695864300243,
      1.6276160437021532,  1.9502257921554187,  3.854863256388969,
      1.2768544235121877,  1.2768539105004602,  1.2768530053551186,
      1.2768517373288695,  1.2768501471030425,  1.2768482845962272,
      1.2768462065634887,  1.2768439739575277,  1.276841649165794,
      1.2768392932945418,  1.2768369636551675,  1.2768347115871095,
      1.2768325807352037,  1.2768306058635026,  1.2768288122645128,
      1.276827215793192,   1.2768258235291468,  1.2768246350084274,
      1.2768236438958356,  1.2768228399074528,  1.276822210775857,
      1.2768217440757472,  1.2768214287774051,  1.2768212564095036,
      1.2768546660854576,  1.2768551843759617,  1.2768561167208703,
      1.276857462720023,   1.276859220169868,   1.276861384021501,
      1.2768639449288832,  1.2768668876818707,  1.2768701897032289,
      1.2768738197378282,  1.276877736864235,   1.2768818899476941,
      1.2768862176197107,  1.2768906488436509,  1.2768951040825856,
      1.276899497052366,   1.2769037369969618,  1.2769077313928041,
      1.2769113889544266,  1.276914622794578,   1.2769173535825753,
      1.2769195125493293,  1.2769210442103782,  1.2769219088985975,
  }
                      .reshape(5, 3, 48)};
  const Matrix u0{Vector{
      0.5763969814336217,  0.5884300242123823,  0.6114960838490007,
      0.6424444570725513,  0.6710793765298784,  0.7015799048760902,
      0.7483011683790941,  0.7865322850052512,  0.8283779647305681,
      0.8722228549686545,  0.9118881324172711,  0.9515918099580424,
      0.9895374076034867,  1.0195024455415502,  1.0575397624217013,
      1.0926554336070928,  1.1336034380240596,  1.1550435047950587,
      1.1522710571214123,  1.1622887731199516,  1.175300526465073,
      1.1804186263581162,  1.189251282657525,   1.229721877846503,
      0.5711033854582942,  0.5606704067993122,  0.544040095426039,
      0.5181797966658535,  0.4669669570530188,  0.39590961830418436,
      0.3434512851321297,  0.28053920848966385, 0.23293577422721096,
      0.20204400092906807, 0.17273463767754646, 0.15914897226517985,
      0.157189086886486,   0.14611628523098066, 0.17584757217554622,
      0.17805280666612097, 0.20879741061636417, 0.2808663694013058,
      0.30338832120356723, 0.38623334389528147, 0.5978159967051074,
      0.6291032063603291,  0.6424673116437032,  8.592754946378578,
      1.1464928326413244,  1.1485111879407075,  1.152066529645046,
      1.1570054133762198,  1.1630818192308254,  1.1700709343588165,
      1.1777842513270997,  1.1858577657498297,  1.1940856212375304,
      1.2022876010231818,  1.2102516653683109,  1.2178521835633385,
      1.2249543763666466,  1.2315399956257544,  1.2378049839676106,
      1.2439931614053523,  1.2497312289297482,  1.253534052903462,
      1.2557222297387036,  1.257852408123144,   1.2597140897954655,
      1.261257358610214,   1.262862027686729,   1.2652306976796308,
      1.1455382143827773,  1.1434987169348794,  1.139825295861656,
      1.1344822470584635,  1.127381642770514,   1.1185605119878732,
      1.108247711049858,   1.0962900239527176,  1.0832189980343185,
      1.0695492536365367,  1.0560562646126723,  1.044400526968772,
      1.036704218532105,   1.0341400566035563,  1.042984630969077,
      1.0604727057282983,  1.0946193068312096,  1.152084575926486,
      1.2192039841547377,  1.317479667140124,   1.4694922091958447,
      1.6114128057595862,  1.8578127935815762,  5.2192396233541976,
      1.2768544235121877,  1.2768539105004602,  1.2768530053551186,
      1.2768517373288695,  1.2768501471030425,  1.2768482845962272,
      1.2768462065634887,  1.2768439739575277,  1.276841649165794,
      1.2768392932945418,  1.2768369636551675,  1.2768347115871095,
      1.2768325807352037,  1.2768306058635026,  1.2768288122645128,
      1.276827215793192,   1.2768258235291468,  1.2768246350084274,
      1.2768236438958356,  1.2768228399074528,  1.276822210775857,
      1.2768217440757472,  1.2768214287774051,  1.2768212564095036,
      1.2768546660854576,  1.2768551843759617,  1.2768561167208703,
      1.276857462720023,   1.276859220169868,   1.276861384021501,
      1.2768639449288832,  1.2768668876818707,  1.2768701897032289,
      1.2768738197378282,  1.276877736864235,   1.2768818899476941,
      1.2768862176197107,  1.2768906488436509,  1.2768951040825856,
      1.276899497052366,   1.2769037369969618,  1.2769077313928041,
      1.2769113889544266,  1.276914622794578,   1.2769173535825753,
      1.2769195125493293,  1.276921044210378,   1.276921908898601,
  }
                      .reshape(3, 48)};
  const Vector flux_down_diffuse{
      1.4078290661820567,
      3.863551690526596,
      4.011489377274899,
  };
  const Vector flux_down_direct{
      1.8895898890890446,
      0.01946824083281573,
      2.6237245949071523e-22,
  };
  const Vector flux_up{
      3.2964158512412185,
      3.8820772057524597,
      4.011278175992092,
  };

  // flat_print(u, compute_u(dis, taus, phis, true));
  // const auto [flux_up_, flux_down_diffuse_, flux_down_direct_] =  compute_flux(dis, taus);
  // flat_print(flux_down_diffuse, flux_down_diffuse_);

  compare("test_5BDRF",
          dis,
          taus,
          phis,
          u,
          u0,
          flux_down_diffuse,
          flux_down_direct,
          flux_up,
          true);
} catch (std::exception& e) {
  throw std::runtime_error(std::format("Error in test-5BDRF:\n{}", e.what()));
}

int main() try {
  std::cout << std::setprecision(16);
  test_5a();
  test_5b();
  test_5BDRF();
} catch (std::exception& e) {
  std::cerr << "Error in main:\n" << e.what() << '\n';
  return EXIT_FAILURE;
}
