#pragma once

#include "rtepack_mueller_matrix.h"
#include "rtepack_propagation_matrix.h"
#include "rtepack_source.h"

namespace rtepack {
/** A single linear step of the point-to-point radiative transfer equation
 * 
 * Returns T * (I - J) + J
 *
 * @param T Transmission matrix of the medium
 * @param I Radiation attenuated by the medium
 * @param J Source function of the medium
 * @return constexpr stokvec Radiation leaving the medium
 */
constexpr stokvec linear_step(const muelmat &T,
                              const stokvec &I,
                              const stokvec &J) {
  return T * (I - J) + J;
}
/** A single linear step of the point-to-point radiative transfer equation
 * 
 * Sets I := T * (I - J) + J
 * where
 * T = exp(- (K0 + K1) * r / 2)
 * J = (S0 + S1) / 2
 * S0 = planck(T0, f) + inv(K0) * J0
 * S1 = planck(T1, f) + inv(K1) * J1
 *
 * @param[inout] I incoming and then outgoing radiation
 * @param[in] f frequency grid
 * @param[in] K0 absorption matrix at point 0
 * @param[in] K1 absorption matrix at point 1
 * @param[in] J0 source function at point 0
 * @param[in] J1 source function at point 1
 * @param[in] T0 temperature at point 0
 * @param[in] T1 temperature at point 1
 * @param[in] r distance between the two points
 */
void nlte_step(stokvec_vector_view I,
               const Vector &f,
               const propmat_vector_const_view &K0,
               const propmat_vector_const_view &K1,
               const stokvec_vector_const_view &J0,
               const stokvec_vector_const_view &J1,
               const Numeric &T0,
               const Numeric &T1,
               const Numeric &r);

/** A single linear step of the point-to-point radiative transfer equation
 * 
 * Returns T * (I - J) + J
 *
 * Also returns the derivatives.
 *
 * The assumption is however that T and J are from two points, 1 and 2.
 * The value of T has to be computed as if it consists of theses two points.
 * The derivatives are computed as if it was.
 * 
 * @param dI1 Radiation attenuated by the medium derivative wrt point 1
 * @param dI2 Radiation attenuated by the medium derivative wrt point 2
 * @param T Transmission matrix of the medium
 * @param PiT Cumulated Transmission to the end-of-the-path, to scale derivatives
 * @param I Radiation attenuated by the medium
 * @param J1 Source function of the medium at point 1
 * @param J2 Source function of the medium at point 2
 * @param dT1 Transmission matrix of the medium wrt point 1
 * @param dT2 Transmission matrix of the medium wrt point 2
 * @param dJ1 Source function derivative of the medium wrt point 1
 * @param dJ2 Source function derivative of the medium wrt point 1
 * @return constexpr stokvec as in linear_step with J = avg(J1, J2)
 */
constexpr stokvec two_level_linear_step(stokvec_vector_view &dI1,
                                        stokvec_vector_view &dI2,
                                        const muelmat &T,
                                        const muelmat &PiT,
                                        const stokvec &I,
                                        const stokvec &J1,
                                        const stokvec &J2,
                                        const muelmat_vector_const_view &dT1,
                                        const muelmat_vector_const_view &dT2,
                                        const stokvec_vector_const_view &dJ1,
                                        const stokvec_vector_const_view &dJ2) {
  assert(dI1.size() == dI2.size() and dT1.size() == dT2.size() and
         dJ1.size() == dJ2.size() and dI1.size() == dT1.size());

  const auto J = avg(J1, J2);

  for (Size k = 0; k < dT1.size(); k++) {
    dI1[k] += PiT * (dT1[k] * (I - J) + dJ1[k] - T * dJ1[k]);
    dI2[k] += PiT * (dT2[k] * (I - J) + dJ2[k] - T * dJ2[k]);
  }

  return linear_step(T, I, J);
}

void two_level_linear_emission_step(stokvec_vector_view I,
                                    stokvec_matrix_view dI1,
                                    stokvec_matrix_view dI2,
                                    const stokvec_vector_const_view &J1,
                                    const stokvec_vector_const_view &J2,
                                    const stokvec_matrix_const_view &dJ1,
                                    const stokvec_matrix_const_view &dJ2,
                                    const muelmat_vector_const_view &T,
                                    const muelmat_vector_const_view &PiT,
                                    const muelmat_matrix_const_view &dT1,
                                    const muelmat_matrix_const_view &dT2);

void two_level_linear_emission_step(stokvec_vector_view I,
                                    const stokvec_vector_const_view &J1,
                                    const stokvec_vector_const_view &J2,
                                    const muelmat_vector_const_view &T);

void two_level_linear_transmission_step(stokvec_vector_view I,
                                        stokvec_matrix_view dI1,
                                        stokvec_matrix_view dI2,
                                        const muelmat_vector_const_view &T,
                                        const muelmat_vector_const_view &PiT,
                                        const muelmat_matrix_const_view &dT1,
                                        const muelmat_matrix_const_view &dT2);

void two_level_linear_emission_step_by_step_full(
    stokvec_vector &I,
    std::vector<stokvec_matrix> &dI,
    const std::vector<muelmat_vector> &Ts,
    const std::vector<muelmat_vector> &Pi,
    const std::vector<muelmat_tensor3> &dTs,
    const std::vector<stokvec_vector> &Js,
    const std::vector<stokvec_matrix> &dJs,
    const stokvec_vector &I0);

void two_level_linear_emission_step_by_step_full(
    std::vector<stokvec_vector> &Is,
    const std::vector<muelmat_vector> &Ts,
    const std::vector<stokvec_vector> &Js);

void two_level_linear_transmission_step(stokvec_vector &I,
                                        std::vector<stokvec_matrix> &dI,
                                        const std::vector<muelmat_vector> &Ts,
                                        const std::vector<muelmat_vector> &Pi,
                                        const std::vector<muelmat_tensor3> &dTs,
                                        const stokvec_vector &I0);
}  // namespace rtepack
